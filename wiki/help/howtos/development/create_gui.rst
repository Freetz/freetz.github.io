help/howtos/development/create_gui
==================================
Howtos: Entwicklung
^^^^^^^^^^^^^^^^^^^

#. `Entpacken und Packen von
   Firmware-Images <repack_fw.html#EntpackenundPackenvonFirmware-Images>`__

   #. `Tools und Syntax <repack_fw.html#ToolsundSyntax>`__
   #. `Vorgehensweise <repack_fw.html#Vorgehensweise>`__
   #. `Verwendung von fwmod im "no
      freetz"-Modus <repack_fw.html#Verwendungvonfwmodimnofreetz-Modus>`__

#. `Patches in Freetz
   einspielen <integrate_patches.html#PatchesinFreetzeinspielen>`__
#. `Example 3:
   NZBGet <developer_information/package_development_start/example_3.html#Example3:NZBGet>`__

   #. `Build
      manually <developer_information/package_development_start/example_3.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_3.html#AddpackagetoFreetz>`__
   #. `Create new image with added
      package <developer_information/package_development_start/example_3.html#Createnewimagewithaddedpackage>`__
   #. `Testing <developer_information/package_development_start/example_3.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_3.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. `Example 2:
   par2cmdline <developer_information/package_development_start/example_2.html#Example2:par2cmdline>`__

   #. `Build
      manually <developer_information/package_development_start/example_2.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_2.html#AddpackagetoFreetz>`__
   #. `Create new image with added
      package <developer_information/package_development_start/example_2.html#Createnewimagewithaddedpackage>`__
   #. `Testing <developer_information/package_development_start/example_2.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_2.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. `Example 1:
   Httptunnel <developer_information/package_development_start/example_1.html#Example1:Httptunnel>`__

   #. `Build
      manually <developer_information/package_development_start/example_1.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_1.html#AddpackagetoFreetz>`__
   #. `Call Procedures "make menuconfig" and
      "make" <developer_information/package_development_start/example_1.html#CallProceduresmakemenuconfigandmake>`__
   #. `Testing <developer_information/package_development_start/example_1.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_1.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. 

   #. `Signieren von Firmware <sign_image.html#SignierenvonFirmware>`__
   #. `Konkrete Anwendung in
      Freetz <sign_image.html#KonkreteAnwendunginFreetz>`__

#. `Ablauf eines
   Firmware-Updates <firmware_update_details.html#AblaufeinesFirmware-Updates>`__
#. `Eigene Programme
   kompilieren <compile_own_progs.html#EigeneProgrammekompilieren>`__
#. `Dynamische Bandbreitenanzeige per
   SVG <bandwidth_svg.html#DynamischeBandbreitenanzeigeperSVG>`__

   #. `Anleitung zur
      Test-Installation <bandwidth_svg.html#AnleitungzurTest-Installation>`__

#. `Platz sparen im Dateisystem der
   FritzBox <make_room.html#PlatzsparenimDateisystemderFritzBox>`__

   #. `Vorwort und Motivation <make_room.html#VorwortundMotivation>`__
   #. `Bestandsaufnahme: Wo stecken die
      Platzfresser? <make_room.html#Bestandsaufnahme:WosteckendiePlatzfresser>`__
   #. `Weitere Spartricks <make_room.html#WeitereSpartricks>`__
   #. `Schlußwort <make_room.html#Schlußwort>`__

#. `Flash-Partitionen im laufenden Betrieb
   sichern <save_mtd_1.html#Flash-PartitionenimlaufendenBetriebsichern>`__

   #. `Motivation <save_mtd_1.html#Motivation>`__
   #. `Voraussetzungen <save_mtd_1.html#Voraussetzungen>`__
   #. `Lösungsweg <save_mtd_1.html#Lösungsweg>`__
   #. `Wege, sich schnell einen Überblick zu
      verschaffen <save_mtd_1.html#WegesichschnelleinenÜberblickzuverschaffen>`__
   #. `Zusammenfassung <save_mtd_1.html#Zusammenfassung>`__

#. `Release Management <release_management.html#ReleaseManagement>`__

   #. `Subversion
      Repository <release_management.html#SubversionRepository>`__
   #. `Checklists <release_management.html#Checklists>`__
   #. `GIT <release_management.html#GIT>`__
   #. `Downloads <release_management.html#Downloads>`__
   #. `References <release_management.html#References>`__

#. `First steps - How to start your first freetz
   package <developer_information/package_development_start.html#Firststeps-Howtostartyourfirstfreetzpackage>`__

   #. `Info <developer_information/package_development_start.html#Info>`__
   #. `Build
      Environment <developer_information/package_development_start.html#BuildEnvironment>`__
   #. `File
      Structure <developer_information/package_development_start.html#FileStructure>`__
   #. `Examples Binary
      Package <developer_information/package_development_start.html#ExamplesBinaryPackage>`__
   #. `Configuration
      Handling <developer_information/package_development_start.html#ConfigurationHandling>`__
   #. `Examples
      Web-Interface <developer_information/package_development_start.html#ExamplesWeb-Interface>`__
   #. `Trouble
      shooting <developer_information/package_development_start.html#Troubleshooting>`__

#. `Kernel konfigurieren und
   kompilieren <make_kernel.html#Kernelkonfigurierenundkompilieren>`__
#. `Menükonfiguration
   pflegen <menuconfig.html#Menükonfigurationpflegen>`__

   #. `Einstieg <menuconfig.html#Einstieg>`__
   #. `Beispiel-Konfiguration für ein neues
      Paket <menuconfig.html#Beispiel-KonfigurationfüreinneuesPaket>`__
   #. `Menuconfig-Warnungen
      beheben <menuconfig.html#Menuconfig-Warnungenbeheben>`__
   #. `Erklärung und Anwendung der erweiterten
      MK-Targets <menuconfig.html#ErklärungundAnwendungdererweitertenMK-Targets>`__
   #. `Syntax-Fehler in MK-Dateien
      finden <menuconfig.html#Syntax-FehlerinMK-Dateienfinden>`__
   #. `Syntax-Hervorhebung für
      MK-Dateien <menuconfig.html#Syntax-HervorhebungfürMK-Dateien>`__

#. `ADAM2-Bootloader <adam2.html#ADAM2-Bootloader>`__

   #. `Bootloader-Backup
      anlegen <adam2.html#Bootloader-Backupanlegen>`__
   #. `Bootloader überschreiben <adam2.html#Bootloaderüberschreiben>`__
   #. `Bootloader-Befehle <adam2.html#Bootloader-Befehle>`__
   #. `Bootloader-Quelltext <adam2.html#Bootloader-Quelltext>`__
   #. `Aufbau des Bootloaders <adam2.html#AufbaudesBootloaders>`__
   #. `Bootloader und Freetz <adam2.html#BootloaderundFreetz>`__

#. `Einstellungen speichern im
   Urlader-Environment <urlader_flags.html#EinstellungenspeichernimUrlader-Environment>`__

   #. `Vorwort und
      Motivation <urlader_flags.html#VorwortundMotivation>`__
   #. `Lösungsmöglichkeiten <urlader_flags.html#Lösungsmöglichkeiten>`__
   #. `Bootloader
      Environment <urlader_flags.html#BootloaderEnvironment>`__
   #. `Variable
      "kernel_args" <urlader_flags.html#Variablekernel_args>`__
   #. `Kernel_Args-API <urlader_flags.html#Kernel_Args-API>`__
   #. `Mögliche
      Anwendungsfälle <urlader_flags.html#MöglicheAnwendungsfälle>`__

#. `Busybox konfigurieren und
   kompilieren <make_busybox.html#Busyboxkonfigurierenundkompilieren>`__
#. `Wie baue ich ein eigenes Paket für
   Freetz? <package_creation.html#WiebaueicheineigenesPaketfürFreetz>`__
#. `Firmware-Image-Namen analysieren und
   interpretieren <analyse_image_names.html#Firmware-Image-Namenanalysierenundinterpretieren>`__

   #. `Einleitung <analyse_image_names.html#Einleitung>`__
   #. `Skript-Code <analyse_image_names.html#Skript-Code>`__
   #. `Daten im Rohformat <analyse_image_names.html#DatenimRohformat>`__
   #. `Ausgabe grundlegender
      Informationen <analyse_image_names.html#AusgabegrundlegenderInformationen>`__
   #. `Ausgabe erweiterter
      Informationen <analyse_image_names.html#AusgabeerweiterterInformationen>`__

#. 

   #. `Web-interface
      HTTPTunnel <developer_information/package_development_start/webinterface_example_1.html#Web-interfaceHTTPTunnel>`__

#. `Developer
   Information <developer_information.html#DeveloperInformation>`__
#. `Addon Paket
   installieren <install_addon.html#AddonPaketinstallieren>`__
#. `Paketverwaltung für
   Freetz <developer_information/package_development_dynamic.html#PaketverwaltungfürFreetz>`__

   #. `Erweiterung des
      Dateisystems <developer_information/package_development_dynamic.html#ErweiterungdesDateisystems>`__
   #. `Paketverwaltung <developer_information/package_development_dynamic.html#Paketverwaltung>`__
   #. `Links <developer_information/package_development_dynamic.html#Links>`__
   #. `Kommentare <developer_information/package_development_dynamic.html#Kommentare>`__

#. `Wie die FritzBox Manipulationen
   erkennt <manipulation_detection.html#WiedieFritzBoxManipulationenerkennt>`__

   #. `Ursachen <manipulation_detection.html#Ursachen>`__
   #. `Diagnose <manipulation_detection.html#Diagnose>`__
   #. `Lösungen <manipulation_detection.html#Lösungen>`__
   #. `Schlußwort und
      Ausblick <manipulation_detection.html#SchlußwortundAusblick>`__

#. `Shell Coding
   Conventions <developer_information/shell_coding_conventions.html#ShellCodingConventions>`__

   #. `Shell
      Language <developer_information/shell_coding_conventions.html#ShellLanguage>`__
   #. `Basic
      Format <developer_information/shell_coding_conventions.html#BasicFormat>`__
   #. `If, For, and
      While <developer_information/shell_coding_conventions.html#IfForandWhile>`__
   #. `Test
      Built-in <developer_information/shell_coding_conventions.html#TestBuilt-in>`__
   #. `Single-line conditional
      statements <developer_information/shell_coding_conventions.html#Single-lineconditionalstatements>`__
   #. `Infinite
      Loops <developer_information/shell_coding_conventions.html#InfiniteLoops>`__
   #. `Exit Status and If/While
      Statements <developer_information/shell_coding_conventions.html#ExitStatusandIfWhileStatements>`__
   #. `Variable
      References <developer_information/shell_coding_conventions.html#VariableReferences>`__
   #. `Variable
      Naming <developer_information/shell_coding_conventions.html#VariableNaming>`__
   #. `Quoting <developer_information/shell_coding_conventions.html#Quoting>`__
   #. `Variable
      Assignments <developer_information/shell_coding_conventions.html#VariableAssignments>`__
   #. `Testing for (Non-)Empty
      Strings <developer_information/shell_coding_conventions.html#TestingforNon-EmptyStrings>`__
   #. `Commenting <developer_information/shell_coding_conventions.html#Commenting>`__
   #. `Pathnames <developer_information/shell_coding_conventions.html#Pathnames>`__
   #. `Interpreter
      Magic <developer_information/shell_coding_conventions.html#InterpreterMagic>`__

#. `Package
   Development <developer_information/package_development.html#PackageDevelopment>`__

   #. `Persistent Package
      Settings <developer_information/package_development.html#PersistentPackageSettings>`__

#. `Erstellen einer GUI für Pakete in
   Freetz <create_gui.html#ErstelleneinerGUIfürPaketeinFreetz>`__

   #. `Motivation <create_gui.html#Motivation>`__
   #. `Grundlagen <create_gui.html#Grundlagen>`__
   #. `Wie funktioniert das mit der
      GUI? <create_gui.html#WiefunktioniertdasmitderGUI>`__

#. `Flash Partitionierung <flash.html#FlashPartitionierung>`__

   #. `Hidden SquashFS <flash.html#HiddenSquashFS>`__
   #. `Contiguous SquashFS <flash.html#ContiguousSquashFS>`__
   #. `Hidden Root <flash.html#HiddenRoot>`__
   #. `NAND Root <flash.html#NANDRoot>`__
   #. `Dateisystem <flash.html#Dateisystem>`__
   #. `Kernel <flash.html#Kernel>`__
   #. `Weblinks <flash.html#Weblinks>`__

#. `Trac
   Hooks <developer_information/post_commit_hook.html#TracHooks>`__

   #. `trac-post-commit-hook <developer_information/post_commit_hook.html#trac-post-commit-hook>`__
   #. `trac-post-revprop-change-hook <developer_information/post_commit_hook.html#trac-post-revprop-change-hook>`__

#. `Package Developing - Advanced
   Topics <developer_information/package_development_advanced.html#PackageDeveloping-AdvancedTopics>`__

   #. `Adding conditional
      patches <developer_information/package_development_advanced.html#Addingconditionalpatches>`__
   #. `Adding multi-binary
      packages <developer_information/package_development_advanced.html#Addingmulti-binarypackages>`__

#. `Eigene Dateien in die Firmware
   integrieren <integrate_own_files.html#EigeneDateienindieFirmwareintegrieren>`__

   #. `Feste Integration über das Freetz
      Image <integrate_own_files.html#FesteIntegrationüberdasFreetzImage>`__
   #. `Erzeugen der Dateien aus der
      debug.cfg <integrate_own_files.html#ErzeugenderDateienausderdebug.cfg>`__
   #. `Nachladen vom
      Webserver <integrate_own_files.html#NachladenvomWebserver>`__
   #. `Nachladen vom
      USB-Stick <integrate_own_files.html#NachladenvomUSB-Stick>`__
   #. `WebDAV Share
      mounten <integrate_own_files.html#WebDAVSharemounten>`__
   #. `NFS-Share mounten <integrate_own_files.html#NFS-Sharemounten>`__

#. `Freetz Build-Prozeß <freetz_make.html#FreetzBuild-Prozeß>`__

   #. `Vorwort und Motivation <freetz_make.html#VorwortundMotivation>`__
   #. `Grundsätzliches <freetz_make.html#Grundsätzliches>`__

#. `Flash-Partitionen von außen mit FTP
   sichern <save_mtd_2.html#Flash-PartitionenvonaußenmitFTPsichern>`__

   #. `Motivation <save_mtd_2.html#Motivation>`__
   #. `Voraussetzungen <save_mtd_2.html#Voraussetzungen>`__
   #. `Allgemeine Informationen zur
      Datensicherung <save_mtd_2.html#AllgemeineInformationenzurDatensicherung>`__
   #. `Sicherung mit Linux-Standard-FTP
      (ftp) <save_mtd_2.html#SicherungmitLinux-Standard-FTPftp>`__
   #. `Sicherung mit Linux-NcFTP
      (ncftpget) <save_mtd_2.html#SicherungmitLinux-NcFTPncftpget>`__
   #. `Sicherung mit Cygwin-NcFTP
      (ncftpget) <save_mtd_2.html#SicherungmitCygwin-NcFTPncftpget>`__
   #. `Uploads via FTP <save_mtd_2.html#UploadsviaFTP>`__

#. `libmodcgi.sh <developer_information/webif/libmodcgi.html#libmodcgi.sh>`__

   #. `cgi <developer_information/webif/libmodcgi.html#cgi>`__
   #. `cgi_begin <developer_information/webif/libmodcgi.html#cgi_begin>`__
   #. `cgi_end <developer_information/webif/libmodcgi.html#cgi_end>`__
   #. `sec_begin <developer_information/webif/libmodcgi.html#sec_begin>`__
   #. `sec_end <developer_information/webif/libmodcgi.html#sec_end>`__
   #. `html <developer_information/webif/libmodcgi.html#html>`__
   #. `check,
      select <developer_information/webif/libmodcgi.html#checkselect>`__
   #. `href <developer_information/webif/libmodcgi.html#href>`__
   #. `back_button <developer_information/webif/libmodcgi.html#back_button>`__
   #. `sec_level <developer_information/webif/libmodcgi.html#sec_level>`__
   #. `stat_bar <developer_information/webif/libmodcgi.html#stat_bar>`__
   #. `cgi_param <developer_information/webif/libmodcgi.html#cgi_param>`__
   #. `cgi_error,
      print_error <developer_information/webif/libmodcgi.html#cgi_errorprint_error>`__
   #. `path_info <developer_information/webif/libmodcgi.html#path_info>`__
   #. `valid <developer_information/webif/libmodcgi.html#valid>`__

#. `Cross-Compiler / Toolchain
   erstellen <create_cross-compiler_toolchain.html#Cross-CompilerToolchainerstellen>`__
#. `Eigene Download-Toolchain
   erstellen <create_cross-compiler_toolchain.html#EigeneDownload-Toolchainerstellen>`__
#. `Target/Native-Compiler-Toolchain
   erstellen <create_cross-compiler_toolchain.html#TargetNative-Compiler-Toolchainerstellen>`__

   #. `Using the dev-tools package to install compiler and
      tools <create_cross-compiler_toolchain.html#Usingthedev-toolspackagetoinstallcompilerandtools>`__

.. _ErstelleneinerGUIfürPaketeinFreetz:

Erstellen einer GUI für Pakete in Freetz
========================================

.. _Motivation:

Motivation
----------

Ein großer Faktor für den Erfolg von Freetz ist die Tatsache, dass die
Pakete dort über eine GUI zu konfigurieren sind. Über den Aufbau und die
Vorgehensweise zur Erstellen einer solchen GUI soll es in diesem Beitrag
gehen. Als Grundlage nehmen wir ein virtuelles Paket mit Namen "hugo"
an, um einen Bezug zu haben

.. _Grundlagen:

Grundlagen
----------

Bevor man sich Gedanken über die GUI machen kann, sind ein paar
grundlegende Dinge über die Art und Weise zu sagen, wie in Freetz Pakete
funktionieren. Als grundlegende Information sei auf die `​Doku von
Daniel <http://www.ip-phone-forum.de/showthread.php?t=90425>`__
verwiesen, hier soll das ganze nur kurz wiedergegeben werden (ich hoffe
das "fast wortwörtliche direkte Kopieren" aus dem Thread von Daniel ist
mir hier erlaubt):

.. _EigenePakete:

Eigene Pakete
~~~~~~~~~~~~~

An ein Paket stellen sich folgende Anforderungen:

-  rc Skript:
   ``etc/init.d/rc.<paketname> [start|stop|load|unload|restart|status]``

Wenn konfigurierbar:

-  Default Konfiguration: ``etc/default.<paketname>/<paketname>.cfg``
-  Optional: cgi Skript für die Weboberfläche:
   ``usr/lib/cgi-bin/<paketname>.cgi``
-  Optional: Extra cgi Skripte in ``usr/lib/cgi-bin/<paketname>/``

Sonstige Default Dateien sollten auch ins Verzeichnis
etc/default.<paketname>/ gepackt werden.

-  ``/mod/etc/init.d/rc.<paketname>``
-  ``/mod/etc/default.<paketname>/*``
-  ``/mod/usr/lib/cgi-bin/<paketname>.cgi``
-  ``/mod/usr/lib/cgi-bin/<paketname>/*``

sind immer gültig (sofern im Paket enthalten) und werden bei statischen
Paketen über Symlinks realisiert. Binaries sollten nach ``bin``,
``sbin``, ``usr/bin`` oder ``usr/sbin``, damit sie sowohl in statischen
als auch dynamischen Paketen aufrufbar sind (die PATH Variable enthält
auch ``/mod/bin``, ``/mod/sbin``, ``/mod/usr/bin`` und
``/mod/usr/sbin``). Libraries funktionieren mit statischen wie auch
dynamischen Paketen in lib (``LD_LIBRARY_PATH=/mod/lib`` ⇒ Library wird
in ``/lib`` und ``/mod/lib`` gesucht)

Benötigt ein Daemon eines Paketes eine Konfigurationsdatei (z.B.
``hugo.conf``), die für diesen Daemon spezifisch ist, so wird sie in der
Regel im rc Skript vor dem Starten des Daemons erzeugt. Ich habe dafür
folgende Konvention gewählt (ist aber kein muss), welche am Beispiel der
``bftpd.conf`` erläutert ist:

#. Suche nach Skript ``/tmp/flash/hugo_conf``, welches die ``hugo.conf``
   als Ausgabe hat; existiert? → goto 3.
#. Führe Skript ``/etc/default.hugo/hugo_conf`` aus, die Ausgabe ergibt
   wie bei 1. die ``hugo.conf`` (meistens ist dies der Fall)
#. Existiert ``/tmp/flash/hugo.conf.extra``? → füge sie an die in 1.
   oder 2. generierte ``hugo.conf`` an

Das sollte alle Möglichkeiten des "Feintunings" offen lassen. 3. macht
nicht immer Sinn, darum ist es optional. Wäre schön, wenn jeder, der ein
Paket erstellt, die Konventionen einhält. Das Skript ``hugo_conf`` muss
stets mit exportierten Variablen aus ``/mod/etc/conf/hugo.cfg``
aufgerufen werden. So wird die ``hugo.conf`` je nach Paket-Konfiguration
individuell erstellt.

.. _Konfiguration:

Konfiguration
~~~~~~~~~~~~~

Jedes Paket besitzt ein Konfigurationsdatei
``/mod/etc/conf/<paketname>.cfg``, welche wie folgt aufgebaut ist:

.. code:: wiki

     export <PAKETNAME>_OPTION1='bla'
     export <PAKETNAME>_OPTION2='blub'
     ...

Sie enthält alle Optionen, die auch übers Webinterface eingestellt
werden können und ist in Shell Syntax. Damit kann die aktuelle
Konfiguration mit

.. code:: wiki

     . /mod/etc/conf/<paketname>.cfg

eingelesen werden. In der Datei
``/mod/etc/default.<paketname>/<paketname>.cfg`` sind die default
Einstellungen gespeichert. Beim Speichern werden nur die sich von den
Defaults unterscheidenden Variablen in die
``/tmp/flash/<paketname>.diff`` transferiert und mit dem ganzen
Verzeichnis ``/tmp/flash/`` ins tffs abgelegt. Die Basis-Konfiguration
hat den Paketnamen 'mod'. Die Befehle dazu sind:

::

     modconf load <paketname>
     # -> erzeugt die Datei /mod/etc/conf/<paketname>.cfg aus den Defaults und der <paketname>.diff


     modconf save <paketname>
     # -> erzeugt die Datei <paketname>.diff aus den Defaults und der /mod/etc/conf/<paketname>.cfg

     modsave
     # -> ruft unter anderem für alle Pakete 'modconf save' auf und speichert das Verzeichnis /tmp/flash ins tffs

     modsave flash
     # -> speichert nur das Verzeichnis /tmp/flash ins tffs

Das dauerhafte Abschalten des Webinterfaces geht damit so (Variable
MOD_HTTPD in der Basis-Konfiguration 'mod'):

.. code:: wiki

     vi /mod/etc/conf/mod.cfg  # -> MOD_HTTPD='yes' durch MOD_HTTPD='no' ersetzen
     modconf save mod  # nun ist mod.diff up-to-date
     modsave flash  # damit ist mod.diff im tffs

     # oder

     vi /mod/etc/conf/mod.cfg  # -> MOD_HTTPD='yes' durch MOD_HTTPD='no' ersetzen
     modsave  # erzeugt alle diff Dateien neu und speichert ins tffs

Soviel zur Veranschaulichung. Komfortabler ist folgendes:

.. code:: wiki

     modconf set mod MOD_HTTPD=no
     modconf save mod
     modsave flash

     # bzw.

     modconf set mod MOD_HTTPD=no
     modsave

.. _WiefunktioniertdasmitderGUI:

Wie funktioniert das mit der GUI?
---------------------------------

Im vorigen Abschnitt wurde beschrieben, welche Dateien es gibt und wie
ich die Werte von Variablen direkt von der Shell aus ändern kann. Die
Freetz GUI's basieren auf dem Konzept des
`​Proccgi <http://www.fpx.de/fp/Software/ProcCGI.html>`__ von Frank
Pilhofer. Hierzu bedienen sie sich Umgebungsvariablen, die wie oben
beschrieben dem Muster ``<Paketname>_<Variablenname>`` folgen. In den
HTML-Seiten der GUI werden Input-Felder mit dem Tag
``name="<Variablenname>"`` versehen. Diese Felder korrespondieren dann
mit den Variablen. Alle GUI-Seiten sind in einen Rahmen-Formular von
Freetz untergebracht, das über den Button "Übernehmen" diese Variablen
ausliest und der Umgebungsvariable zuweist.

.. _EinBeispiel:

Ein Beispiel
~~~~~~~~~~~~

Ich hoffe, ein kleines Beispiel macht das deutlicher, unser "Paket"
heisst wie schon gesagt "hugo". Als erstes legen wir das "default"
Verzeichnis und die hugo.cfg Datei an.

::

   mkdir /mod/etc/default.hugo
   touch /mod/etc/default.hugo/hugo.cfg

Im "default" Verzeichnis des Paketes ``/etc/default.hugo/hugo.cfg``
werden die benutzten Variablen über einen export definiert und zugleich
auch mit einem "default-Wert" belegt. Wenn man später also im
Webinterface auf "Standard" klickt, werden die dort festgelegten Werte
aus der GUI übernommen. So eine Datei sähe dann in etwa so aus:

::

   export HUGO_ACTION='ACCEPT'
   export HUGO_CHAIN='INPUT'
   export HUGO_DESTINATION='anywhere'
   export HUGO_ENABLED='no'

Damit sind die Variablen ``ACTION``, ``CHAIN``, ``DESTINATION``,
``ENABLED``, etc. definiert. Diese Variablennamen werden in der GUI,
einem "cgi-File" belegt (per Eingabe oder auch per javascript).

Der entsprechende Abschnitt dazu im Code

::

   <p>DESTINATION: <input type="text" name="destination" value="$(html "$HUGO_DESTINATION")"></p>

man sieht hier auch, dass dieses "cgi"-File Shellauswertung nutzt, um im
HTML-Code den Wert von "DESTINATION" als Vorbelegung nutzt.

Beim "Übernehmen" werden diese Variablen mit den "default-Variablen"
verglichen und beim Abweichen direkt resetfest im Flash abgespeichert.

Gibt man hier nun in das Feld "Blabla" ein, erzeugt das "Übernehmen" die
Datei ``/var/tmp/flash/hugo.diff`` mit diesem Inhalt:

::

   export HUGO_DESTINATION='Blabla'

die mit ``modsave`` auch gleich gesichert wird. Auch wird aus der
Zusammenführung der default-Werte und der geänderten Werte im
*diff*-file die aktuelle Datei ``/mod/etc/conf/hugo.cfg`` erstellt, die
für jede Variable den aktuellen Wert zuweist (das alles macht übrigens
das cgi ``/usr/mww/cgi-bin/save.cgi``, der beim Abschicken des Formulars
aufgerufen wird).

hat man also die ``hugo.cfg`` Datei im "default" Verzeichnis fertig
gestellt, so kopiert man diese nach ``/mod/etc/conf``

::

   modconf load hugo

Jetzt kommt die GUI Programmierung dran. Die Datei ``hugo.cgi`` wird im
Verzeichnis ``/mod/usr/lib/cgi-bin/`` angelegt und sollte ungefähr so
aussehen.

::

   #!/bin/sh

   PATH=/bin:/usr/bin:/sbin:/usr/sbin
   . /usr/lib/libmodcgi.sh

   # setzt auto_chk oder man_chk auf ' checked', je nach Wert von HUGO_ENABLED
   check "$HUGO_ENABLED" yes:auto "*":man

   sec_begin 'Activation'
   cat << EOF
   <div style="float: right;"><font size="1">Version 1.0.3</font></div>
   <p>
   <input id="e1" type="radio" name="enabled" value="yes" $auto_chk><label for="e1"> Active</label>
   <input id="e2" type="radio" name="enabled" value="no" $man_chk><label for="e2"> Inactive</label>
   </p>
   EOF
   sec_end

   sec_begin 'hugo Überschrift'
   cat << EOF
   ...
   <p>DESTINATION: <input type="text" name="destination" value="$(html "$HUGO_DESTINATION")"></p>
   ...
   EOF
   sec_end

Wollen wir eine zusätzliche Datei fest ins Flash speichern, so müssen
wir diese mit ``modreg file`` registrieren und eine Datei namens
``hugo_file.def`` im Verzeichnis ``/mod/etc/default.hugo`` anlegen.
Inhalt muss so aussehen:

::

   CAPTION='Überschrift'
   DESCRIPTION='Beschreibung dieser Datei. Bla bla bla...'
   CONFIG_FILE='/tmp/flash/hugo_file'
   CONFIG_SAVE='modsave flash;'
   CONFIG_TYPE='text'

(Falls die zu bearbeitende Datei zunächst generiert werden muss, kann
die nötige Anweisung in ``CONFIG_PREPARE`` angegeben werden.)

Der Daemon, der unsere Arbeiten ausführt, heisst ``rc.hugo`` und wird
unter ``/mod/etc/init.d`` angelegt. Die ersten Zeilen müssen so
aussehen:

::

   #!/bin/sh

   DAEMON=hugo

   # Liest Paketkonfiguration ein und definiert einige Hilsfunktionen
   . /etc/init.d/modlibrc

   start() {
            # HIER KOMMEN DIE VERARBEITUNGEN REIN
            echo "Starting hugo..."
   }

   stop() {
            # HIER KOMMEN DIE VERARBEITUNGEN REIN
            echo "Stopping hugo..."
   }

   case "$1" in
           start)
                   start
                   ;;
           stop)
                   stop
                   ;;
           restart)
                   stop
                   start
                   ;;
           status)
                   if [ -z "$(pidof "$DAEMON")" ]; then
                           echo 'stopped'
                   else
                           echo 'running'
                   fi
                   ;;
        ""|load)
                   # CGI registrieren
                   modreg cgi $DAEMON Bezeichnung
                   # File registrieren (wird resetfest ins flash gespeichert)
                   # modreg file <pkg> <id> <title> <sec-level>  <desc-file (ohne Pfad und .def-Endung)>
                   modreg file 'hugo' 'config' 'HUGO: File' 0 "hugo_file"

                   if [ "$HUGO_ENABLED" != "yes" ]; then
                           echo "$DAEMON is disabled" 1>&2
                           exit 1
                   else
                           start
                   fi
                   ;;

                   ;;
           unload)
                   stop
                   modunreg file 'hugo'
                   modunreg cgi 'hugo'
                   ;;
           *)
                   echo "Usage: $0 [start|stop|restart|status]" 1>&2
                   exit 1
                   ;;
   esac

   exit 0

Jetzt löschen den cache und bauen wir den Menüpunkt "hugo" in das
Webmenü ein.

::

   rm /var/mod/var/cache/menu/packages
   modreg cgi hugo hugo

**TIPP:** Wenn man ein CGI entwickelt, sollte man seine Arbeiten auf
einen angeschlossenen USB-Stick ablegen und die entsprechenden Dateien
ins RAM von Freetz kopieren bzw. Softlinks setzen. Hier ein Beispiel für
ein kleines Script, welches die Dateien temporär ins RAM kopiert.

::

   #!/bin/sh
   mkdir /mod/etc/default.hugo
   cp hugo.cfg /mod/etc/default.hugo
   modconf load hugo
   cd /mod/usr/lib/cgi-bin
   ln -s /var/media/ftp/uStor01/hugo.cgi hugo.cgi
   cd /mod/etc/init.d
   ln -s /var/media/ftp/uStor01/rc.hugo rc.hugo
   modreg cgi hugo hugo
   cd -

-  Tags
-  `development </tags/development>`__
