help/howtos/development/manipulation_detection
==============================================
Howtos: Entwicklung
^^^^^^^^^^^^^^^^^^^

#. `Entpacken und Packen von
   Firmware-Images <repack_fw.html#EntpackenundPackenvonFirmware-Images>`__

   #. `Tools und Syntax <repack_fw.html#ToolsundSyntax>`__
   #. `Vorgehensweise <repack_fw.html#Vorgehensweise>`__
   #. `Verwendung von fwmod im "no
      freetz"-Modus <repack_fw.html#Verwendungvonfwmodimnofreetz-Modus>`__

#. `Patches in Freetz
   einspielen <integrate_patches.html#PatchesinFreetzeinspielen>`__
#. `Example 3:
   NZBGet <developer_information/package_development_start/example_3.html#Example3:NZBGet>`__

   #. `Build
      manually <developer_information/package_development_start/example_3.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_3.html#AddpackagetoFreetz>`__
   #. `Create new image with added
      package <developer_information/package_development_start/example_3.html#Createnewimagewithaddedpackage>`__
   #. `Testing <developer_information/package_development_start/example_3.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_3.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. `Example 2:
   par2cmdline <developer_information/package_development_start/example_2.html#Example2:par2cmdline>`__

   #. `Build
      manually <developer_information/package_development_start/example_2.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_2.html#AddpackagetoFreetz>`__
   #. `Create new image with added
      package <developer_information/package_development_start/example_2.html#Createnewimagewithaddedpackage>`__
   #. `Testing <developer_information/package_development_start/example_2.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_2.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. `Example 1:
   Httptunnel <developer_information/package_development_start/example_1.html#Example1:Httptunnel>`__

   #. `Build
      manually <developer_information/package_development_start/example_1.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_1.html#AddpackagetoFreetz>`__
   #. `Call Procedures "make menuconfig" and
      "make" <developer_information/package_development_start/example_1.html#CallProceduresmakemenuconfigandmake>`__
   #. `Testing <developer_information/package_development_start/example_1.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_1.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. 

   #. `Signieren von Firmware <sign_image.html#SignierenvonFirmware>`__
   #. `Konkrete Anwendung in
      Freetz <sign_image.html#KonkreteAnwendunginFreetz>`__

#. `Ablauf eines
   Firmware-Updates <firmware_update_details.html#AblaufeinesFirmware-Updates>`__
#. `Eigene Programme
   kompilieren <compile_own_progs.html#EigeneProgrammekompilieren>`__
#. `Dynamische Bandbreitenanzeige per
   SVG <bandwidth_svg.html#DynamischeBandbreitenanzeigeperSVG>`__

   #. `Anleitung zur
      Test-Installation <bandwidth_svg.html#AnleitungzurTest-Installation>`__

#. `Platz sparen im Dateisystem der
   FritzBox <make_room.html#PlatzsparenimDateisystemderFritzBox>`__

   #. `Vorwort und Motivation <make_room.html#VorwortundMotivation>`__
   #. `Bestandsaufnahme: Wo stecken die
      Platzfresser? <make_room.html#Bestandsaufnahme:WosteckendiePlatzfresser>`__
   #. `Weitere Spartricks <make_room.html#WeitereSpartricks>`__
   #. `Schlußwort <make_room.html#Schlußwort>`__

#. `Flash-Partitionen im laufenden Betrieb
   sichern <save_mtd_1.html#Flash-PartitionenimlaufendenBetriebsichern>`__

   #. `Motivation <save_mtd_1.html#Motivation>`__
   #. `Voraussetzungen <save_mtd_1.html#Voraussetzungen>`__
   #. `Lösungsweg <save_mtd_1.html#Lösungsweg>`__
   #. `Wege, sich schnell einen Überblick zu
      verschaffen <save_mtd_1.html#WegesichschnelleinenÜberblickzuverschaffen>`__
   #. `Zusammenfassung <save_mtd_1.html#Zusammenfassung>`__

#. `Release Management <release_management.html#ReleaseManagement>`__

   #. `Subversion
      Repository <release_management.html#SubversionRepository>`__
   #. `Checklists <release_management.html#Checklists>`__
   #. `GIT <release_management.html#GIT>`__
   #. `Downloads <release_management.html#Downloads>`__
   #. `References <release_management.html#References>`__

#. `First steps - How to start your first freetz
   package <developer_information/package_development_start.html#Firststeps-Howtostartyourfirstfreetzpackage>`__

   #. `Info <developer_information/package_development_start.html#Info>`__
   #. `Build
      Environment <developer_information/package_development_start.html#BuildEnvironment>`__
   #. `File
      Structure <developer_information/package_development_start.html#FileStructure>`__
   #. `Examples Binary
      Package <developer_information/package_development_start.html#ExamplesBinaryPackage>`__
   #. `Configuration
      Handling <developer_information/package_development_start.html#ConfigurationHandling>`__
   #. `Examples
      Web-Interface <developer_information/package_development_start.html#ExamplesWeb-Interface>`__
   #. `Trouble
      shooting <developer_information/package_development_start.html#Troubleshooting>`__

#. `Kernel konfigurieren und
   kompilieren <make_kernel.html#Kernelkonfigurierenundkompilieren>`__
#. `Menükonfiguration
   pflegen <menuconfig.html#Menükonfigurationpflegen>`__

   #. `Einstieg <menuconfig.html#Einstieg>`__
   #. `Beispiel-Konfiguration für ein neues
      Paket <menuconfig.html#Beispiel-KonfigurationfüreinneuesPaket>`__
   #. `Menuconfig-Warnungen
      beheben <menuconfig.html#Menuconfig-Warnungenbeheben>`__
   #. `Erklärung und Anwendung der erweiterten
      MK-Targets <menuconfig.html#ErklärungundAnwendungdererweitertenMK-Targets>`__
   #. `Syntax-Fehler in MK-Dateien
      finden <menuconfig.html#Syntax-FehlerinMK-Dateienfinden>`__
   #. `Syntax-Hervorhebung für
      MK-Dateien <menuconfig.html#Syntax-HervorhebungfürMK-Dateien>`__

#. `ADAM2-Bootloader <adam2.html#ADAM2-Bootloader>`__

   #. `Bootloader-Backup
      anlegen <adam2.html#Bootloader-Backupanlegen>`__
   #. `Bootloader überschreiben <adam2.html#Bootloaderüberschreiben>`__
   #. `Bootloader-Befehle <adam2.html#Bootloader-Befehle>`__
   #. `Bootloader-Quelltext <adam2.html#Bootloader-Quelltext>`__
   #. `Aufbau des Bootloaders <adam2.html#AufbaudesBootloaders>`__
   #. `Bootloader und Freetz <adam2.html#BootloaderundFreetz>`__

#. `Einstellungen speichern im
   Urlader-Environment <urlader_flags.html#EinstellungenspeichernimUrlader-Environment>`__

   #. `Vorwort und
      Motivation <urlader_flags.html#VorwortundMotivation>`__
   #. `Lösungsmöglichkeiten <urlader_flags.html#Lösungsmöglichkeiten>`__
   #. `Bootloader
      Environment <urlader_flags.html#BootloaderEnvironment>`__
   #. `Variable
      "kernel_args" <urlader_flags.html#Variablekernel_args>`__
   #. `Kernel_Args-API <urlader_flags.html#Kernel_Args-API>`__
   #. `Mögliche
      Anwendungsfälle <urlader_flags.html#MöglicheAnwendungsfälle>`__

#. `Busybox konfigurieren und
   kompilieren <make_busybox.html#Busyboxkonfigurierenundkompilieren>`__
#. `Wie baue ich ein eigenes Paket für
   Freetz? <package_creation.html#WiebaueicheineigenesPaketfürFreetz>`__
#. `Firmware-Image-Namen analysieren und
   interpretieren <analyse_image_names.html#Firmware-Image-Namenanalysierenundinterpretieren>`__

   #. `Einleitung <analyse_image_names.html#Einleitung>`__
   #. `Skript-Code <analyse_image_names.html#Skript-Code>`__
   #. `Daten im Rohformat <analyse_image_names.html#DatenimRohformat>`__
   #. `Ausgabe grundlegender
      Informationen <analyse_image_names.html#AusgabegrundlegenderInformationen>`__
   #. `Ausgabe erweiterter
      Informationen <analyse_image_names.html#AusgabeerweiterterInformationen>`__

#. 

   #. `Web-interface
      HTTPTunnel <developer_information/package_development_start/webinterface_example_1.html#Web-interfaceHTTPTunnel>`__

#. `Developer
   Information <developer_information.html#DeveloperInformation>`__
#. `Addon Paket
   installieren <install_addon.html#AddonPaketinstallieren>`__
#. `Paketverwaltung für
   Freetz <developer_information/package_development_dynamic.html#PaketverwaltungfürFreetz>`__

   #. `Erweiterung des
      Dateisystems <developer_information/package_development_dynamic.html#ErweiterungdesDateisystems>`__
   #. `Paketverwaltung <developer_information/package_development_dynamic.html#Paketverwaltung>`__
   #. `Links <developer_information/package_development_dynamic.html#Links>`__
   #. `Kommentare <developer_information/package_development_dynamic.html#Kommentare>`__

#. `Wie die FritzBox Manipulationen
   erkennt <manipulation_detection.html#WiedieFritzBoxManipulationenerkennt>`__

   #. `Ursachen <manipulation_detection.html#Ursachen>`__
   #. `Diagnose <manipulation_detection.html#Diagnose>`__
   #. `Lösungen <manipulation_detection.html#Lösungen>`__
   #. `Schlußwort und
      Ausblick <manipulation_detection.html#SchlußwortundAusblick>`__

#. `Shell Coding
   Conventions <developer_information/shell_coding_conventions.html#ShellCodingConventions>`__

   #. `Shell
      Language <developer_information/shell_coding_conventions.html#ShellLanguage>`__
   #. `Basic
      Format <developer_information/shell_coding_conventions.html#BasicFormat>`__
   #. `If, For, and
      While <developer_information/shell_coding_conventions.html#IfForandWhile>`__
   #. `Test
      Built-in <developer_information/shell_coding_conventions.html#TestBuilt-in>`__
   #. `Single-line conditional
      statements <developer_information/shell_coding_conventions.html#Single-lineconditionalstatements>`__
   #. `Infinite
      Loops <developer_information/shell_coding_conventions.html#InfiniteLoops>`__
   #. `Exit Status and If/While
      Statements <developer_information/shell_coding_conventions.html#ExitStatusandIfWhileStatements>`__
   #. `Variable
      References <developer_information/shell_coding_conventions.html#VariableReferences>`__
   #. `Variable
      Naming <developer_information/shell_coding_conventions.html#VariableNaming>`__
   #. `Quoting <developer_information/shell_coding_conventions.html#Quoting>`__
   #. `Variable
      Assignments <developer_information/shell_coding_conventions.html#VariableAssignments>`__
   #. `Testing for (Non-)Empty
      Strings <developer_information/shell_coding_conventions.html#TestingforNon-EmptyStrings>`__
   #. `Commenting <developer_information/shell_coding_conventions.html#Commenting>`__
   #. `Pathnames <developer_information/shell_coding_conventions.html#Pathnames>`__
   #. `Interpreter
      Magic <developer_information/shell_coding_conventions.html#InterpreterMagic>`__

#. `Package
   Development <developer_information/package_development.html#PackageDevelopment>`__

   #. `Persistent Package
      Settings <developer_information/package_development.html#PersistentPackageSettings>`__

#. `Erstellen einer GUI für Pakete in
   Freetz <create_gui.html#ErstelleneinerGUIfürPaketeinFreetz>`__

   #. `Motivation <create_gui.html#Motivation>`__
   #. `Grundlagen <create_gui.html#Grundlagen>`__
   #. `Wie funktioniert das mit der
      GUI? <create_gui.html#WiefunktioniertdasmitderGUI>`__

#. `Flash Partitionierung <flash.html#FlashPartitionierung>`__

   #. `Hidden SquashFS <flash.html#HiddenSquashFS>`__
   #. `Contiguous SquashFS <flash.html#ContiguousSquashFS>`__
   #. `Hidden Root <flash.html#HiddenRoot>`__
   #. `NAND Root <flash.html#NANDRoot>`__
   #. `Dateisystem <flash.html#Dateisystem>`__
   #. `Kernel <flash.html#Kernel>`__
   #. `Weblinks <flash.html#Weblinks>`__

#. `Trac
   Hooks <developer_information/post_commit_hook.html#TracHooks>`__

   #. `trac-post-commit-hook <developer_information/post_commit_hook.html#trac-post-commit-hook>`__
   #. `trac-post-revprop-change-hook <developer_information/post_commit_hook.html#trac-post-revprop-change-hook>`__

#. `Package Developing - Advanced
   Topics <developer_information/package_development_advanced.html#PackageDeveloping-AdvancedTopics>`__

   #. `Adding conditional
      patches <developer_information/package_development_advanced.html#Addingconditionalpatches>`__
   #. `Adding multi-binary
      packages <developer_information/package_development_advanced.html#Addingmulti-binarypackages>`__

#. `Eigene Dateien in die Firmware
   integrieren <integrate_own_files.html#EigeneDateienindieFirmwareintegrieren>`__

   #. `Feste Integration über das Freetz
      Image <integrate_own_files.html#FesteIntegrationüberdasFreetzImage>`__
   #. `Erzeugen der Dateien aus der
      debug.cfg <integrate_own_files.html#ErzeugenderDateienausderdebug.cfg>`__
   #. `Nachladen vom
      Webserver <integrate_own_files.html#NachladenvomWebserver>`__
   #. `Nachladen vom
      USB-Stick <integrate_own_files.html#NachladenvomUSB-Stick>`__
   #. `WebDAV Share
      mounten <integrate_own_files.html#WebDAVSharemounten>`__
   #. `NFS-Share mounten <integrate_own_files.html#NFS-Sharemounten>`__

#. `Freetz Build-Prozeß <freetz_make.html#FreetzBuild-Prozeß>`__

   #. `Vorwort und Motivation <freetz_make.html#VorwortundMotivation>`__
   #. `Grundsätzliches <freetz_make.html#Grundsätzliches>`__

#. `Flash-Partitionen von außen mit FTP
   sichern <save_mtd_2.html#Flash-PartitionenvonaußenmitFTPsichern>`__

   #. `Motivation <save_mtd_2.html#Motivation>`__
   #. `Voraussetzungen <save_mtd_2.html#Voraussetzungen>`__
   #. `Allgemeine Informationen zur
      Datensicherung <save_mtd_2.html#AllgemeineInformationenzurDatensicherung>`__
   #. `Sicherung mit Linux-Standard-FTP
      (ftp) <save_mtd_2.html#SicherungmitLinux-Standard-FTPftp>`__
   #. `Sicherung mit Linux-NcFTP
      (ncftpget) <save_mtd_2.html#SicherungmitLinux-NcFTPncftpget>`__
   #. `Sicherung mit Cygwin-NcFTP
      (ncftpget) <save_mtd_2.html#SicherungmitCygwin-NcFTPncftpget>`__
   #. `Uploads via FTP <save_mtd_2.html#UploadsviaFTP>`__

#. `libmodcgi.sh <developer_information/webif/libmodcgi.html#libmodcgi.sh>`__

   #. `cgi <developer_information/webif/libmodcgi.html#cgi>`__
   #. `cgi_begin <developer_information/webif/libmodcgi.html#cgi_begin>`__
   #. `cgi_end <developer_information/webif/libmodcgi.html#cgi_end>`__
   #. `sec_begin <developer_information/webif/libmodcgi.html#sec_begin>`__
   #. `sec_end <developer_information/webif/libmodcgi.html#sec_end>`__
   #. `html <developer_information/webif/libmodcgi.html#html>`__
   #. `check,
      select <developer_information/webif/libmodcgi.html#checkselect>`__
   #. `href <developer_information/webif/libmodcgi.html#href>`__
   #. `back_button <developer_information/webif/libmodcgi.html#back_button>`__
   #. `sec_level <developer_information/webif/libmodcgi.html#sec_level>`__
   #. `stat_bar <developer_information/webif/libmodcgi.html#stat_bar>`__
   #. `cgi_param <developer_information/webif/libmodcgi.html#cgi_param>`__
   #. `cgi_error,
      print_error <developer_information/webif/libmodcgi.html#cgi_errorprint_error>`__
   #. `path_info <developer_information/webif/libmodcgi.html#path_info>`__
   #. `valid <developer_information/webif/libmodcgi.html#valid>`__

#. `Cross-Compiler / Toolchain
   erstellen <create_cross-compiler_toolchain.html#Cross-CompilerToolchainerstellen>`__
#. `Eigene Download-Toolchain
   erstellen <create_cross-compiler_toolchain.html#EigeneDownload-Toolchainerstellen>`__
#. `Target/Native-Compiler-Toolchain
   erstellen <create_cross-compiler_toolchain.html#TargetNative-Compiler-Toolchainerstellen>`__

   #. `Using the dev-tools package to install compiler and
      tools <create_cross-compiler_toolchain.html#Usingthedev-toolspackagetoinstallcompilerandtools>`__

.. _WiedieFritzBoxManipulationenerkennt:

Wie die FritzBox Manipulationen erkennt
=======================================

Wer kennt sie nicht, diese schöne Meldung auf der Startseite des
Web-Interface?

   **In Ihrer FRITZBox wurden vom Hersteller nicht unterstützte
   Änderungen durchgeführt.**

.. _Ursachen:

Ursachen
--------

Was haben wir Böses gemacht, um diese Meldung zu verdienen? Da kommen
i.a. zwei Dinge in Frage:

-  **Telnet-Login:** Sobald der Benutzer sich auch nur ein einziges Mal
   via Telnet angemeldet hat, merkt sich die Box diesen Umstand - wie
   nachtragend - bis zum nächsten Recover, also normalerweise für alle
   Zeiten. Wer macht schon deswegen einen Recover?
-  **Nicht autorisiertes Firmware-Update:** Des Modding-Freaks Freude
   ist offenbar der FritzBox Leid. Auch das Einspielen eines
   Firmware-Updates, egal ob echter (Freetz-)Mod oder Pseudo-Update ohne
   Firmware-Änderung (LCR-Updater, Telnet-Aktivierung usw.), wird mit
   einem Eintrag ins Klassenbuch geahndet und führt zur eingangs
   erwähnten Meldung.

.. _Diagnose:

Diagnose
--------

Für beide Arten der Manipulation schreibt die Box Flags persistent in
den Flash-Speicher, allerdings nicht in eine der unter ``/var/flash``
sicht- und änderbaren Konfigurationsdateien.

eventsdump
~~~~~~~~~~

Es gibt allerdings ein Werkzeug, um sich die gesetzten Flags anzeigen zu
lassen, wenn man auf der Box via Telnet oder SSH angemeldet ist:
``/sbin/eventsdump``.

.. code:: wiki

   eventsdump -d | head -n 1

*Eventsdump* gibt eigentlich eine Ereignisliste auf die Konsole aus, wie
man sie auch über das Web-Interface zu sehen bekommmt. Der Parameter
*-d* führt dazu, dass eventuell gesetzte Manipulations-Flags mit
ausgegeben werden, und zwar direkt in der ersten Zeile. Die filtern wir
mit ``head`` heraus. Mögliche Ausgaben sind

-  *DEBUGCFG*,
-  *TELNET*,
-  *NOT_SIGNED*,
-  *IMPORT*,
-  *NOT_SIGNED,IMPORT,TELNET* (oder andere Zusammenstellung/Reihenfolge,
   ohne Leerzeichen)
-  oder etwas anderes, also die erste Zeile des regulären Ereignis-Logs.

So sehen wir also, was wir alles Böses getan haben.

strace
~~~~~~

Wenn wir jetzt wissen wollen, woher ``eventsdump`` seine Informationen
nimmt, müssen wir mit einem Werkzeug wie
`​strace <http://sourceforge.net/projects/strace>`__ nachverfolgen,
welche Systemaufrufe ``eventsdump`` macht. Hier ist ein Ausschnitt aus
einem ``strace``-Log:

.. code:: wiki

   01  mkdir("/var", 0777) = -1 EEXIST (File exists)
   02  mkdir("/var/flash", 0777) = -1 EEXIST (File exists)
   03  unlink("/var/flash/fw_attrib") = -1 ENOENT (No such file or directory)
   04  mknod("/var/flash/fw_attrib", S_IFCHR|0666, makedev(240, 87)) = 0
   05  open("/var/flash/fw_attrib", O_RDONLY) = 3
   06  ioctl(3, TIOCNXCL, 0x7fc22230) = -1 EOPNOTSUPP (Operation not supported)
   07  read(3, "NOT_SIGNED,TELNET", 4096) = 17
   08  write(1, "NOT_SIGNED,TELNET\n", 3) = 18
   09  close(3) = 0
   10  unlink("/var/flash/fw_attrib") = 0

Den Ausschnitt habe ich leicht umformatiert. Links steht statt der
Zeilennummern normalerweise jeweils die PID des beobachteten Prozesses.
Rechts nach dem Gleichheitszeichen steht übrigens immer der Rückgabewert
des Aufrufs.

Was passiert hier im Einzelnen?

#. Verzeichnis ``/var`` wird angelegt, falls es noch nicht existiert.
#. Verzeichnis ``/var/flash`` wird angelegt, falls es noch nicht
   existiert.
#. Datei ``/var/flash/fw_attrib`` wird gelöscht, falls vorhanden.
#. ``/var/flash/fw_attrib`` wird als Character Device mit den
   Major/Minor-Nummern 240/87 neu angelegt. Mehr dazu später.
#. ``/var/flash/fw_attrib`` wird zum Lesen geöffnet. Der aufmerksame
   Leser fragt sich: zum Lesen?! Der Node wurde doch gerade erst
   angelegt.
#. Die Systemfunktion *ioctl* wird aufgerufen, vermutlich um das
   "magische Verhalten" von ``fw_attrib`` zu initialisieren. Worin
   dieses besteht, werden wir gleich sehen. Hintergründe zu *ioctl*
   finden sich z.B. in `​Linux-Gerätetreiber, 2. Auflage (OpenBook von
   O'Reilly) <http://www.oreilly.de/german/freebooks/linuxdrive2ger/book1.html>`__
   oder in der `​englischen
   Wikipedia <http://en.wikipedia.org/wiki/Ioctl>`__.
#. Es wird aus ``fw_attrib`` gelesen. 17 Zeichen werden gefunden, sie
   enthalten den Text *NOT_SIGNED,TELNET*. Bingo!
#. Genau dieser Text plus Zeilenvorschub wird auf die Standardausgabe
   des Prozesses geschrieben. (Das ist, was wir zu sehen bekommen, wenn
   wir ``eventsdump -d`` aufrufen.
#. ``fw_attrib`` wird wieder geschlossen.
#. ``fw_attrib`` wird gelöscht, genauer gesagt der Node entfernt. Die
   Daten im Flash-Speicher überleben das, denn sie sind immer noch da,
   wenn wir genau das gleiche Character Device mit der selben
   Major/Minor-Kombination erneut öffnen.

.. _CharacterDeviceNodes:

Character Device Nodes
~~~~~~~~~~~~~~~~~~~~~~

Wie versprochen, mehr zu Ziffer 4. Das Erzeugen des Character Device
Nodes kann man auch selbst nachvollziehen, indem man den Shell-Befehl
``mknod`` verwendet. Die Schritte 4 bis 8 sehen auf der Shell wie folgt
aus:

::

   mknod /var/flash/fw_attrib c 240 87
   cat /var/flash/fw_attrib

Ausgabe (ohne Zeilenvorschub):

.. code:: wiki

   NOT_SIGNED,TELNET

Vorsichtshalber sollte man aber die auf diesem Character Device
arbeitende Befehlssequenz mit vor- und nachherigem Löschen des Nodes
umschließen, wie im Trace zu sehen. Also einfach
``rm -f /var/flash/fw_attrib``.

.. _MajorNumber:

Major Number
^^^^^^^^^^^^

Offenbar ist nicht bei jeder Box bzw. jedem Firmware-Stand die Major
Number dieselbe. Statt 240 kann also auch 250 oder etwas anderes als
Major festgelegt sein. Darum wollen wir die Major Number allgemein
feststellen können. Wie man in */etc/init.d/rc.S* sehr schön sehen kann,
wird beim Systemstart die Major fürs *tffs* so bestimmt:

::

   major=$(grep tffs /proc/devices)
   tffs_major=${major%%tffs}

Das können wir in unserem Code weiter verwenden, um ihn allgemeiner zu
machen.

*Anmerkung: Ob die Minor Number auch geräte- oder firmwareabhängig ist,
ist momentan nicht bekannt. Im ersten Fall einer unterschiedlichen Major
war die Minor gleich.*

.. _Wannwirdfw_attribautomatischgelöscht:

Wann wird fw_attrib automatisch gelöscht?
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Interessantes Detail: Auch ohne manuelles Löschen der Datei wird diese
vom System alle paar Sekunden automatisch gelöscht, sofern das
Web-Interface im Browser geöffnet ist. Das liegt daran, daß sich die
Seite regelmäßig automatisch neu lädt, und dabei wird wegen des Aufrufs
von ``eventsdump -d`` abgeräumt - security by obscurity. AVM möchte wohl
nicht, daß die Benutzer die Datei sehen und manipulieren. Deshalb müssen
wir den Node jedesmal wieder neu erzeugen. Aber das stört ja nicht, wenn
man es erst einmal weiß.

Um das Löschen zu verhindern, kann man der Datei auch einfach einen
anderen Namen geben, z.B. ``/var/tmp/fw_attrib``. Wichtig sind die Major
und Minor Number.

.. _Lösungen:

Lösungen
--------

.. _InHandarbeit:

In Handarbeit
~~~~~~~~~~~~~

Wenn wir aus ``fw_attrib`` lesen können, wieso dann nicht auch hinein
schreiben? Andere Prozesse tun es ja auch, wenn sie
"Klassenbucheinträge" vornehmen. Das geht so:

::

   major=$(grep tffs /proc/devices)
   tffs_major=${major%%tffs}
   rm -f /var/flash/fw_attrib
   mknod /var/flash/fw_attrib c $tffs_major 87
   echo -n "" > /var/flash/fw_attrib
   rm -f /var/flash/fw_attrib

Beachten Sie, daß ``echo -n`` nichts, also auch keinen Zeilenvorschub in
die Datei schreibt. Das kommt einem Löschen des Inhalts gleich. Ein
Kontroll-Aufruf von ``eventsdump -d | head -n 1`` bestätigt das, und
wenn man jetzt `​http://fritz.box <http://fritz.box>`__ aufruft, ist auf
der Übersichtsseite die Meldung verschwunden - das Führungszeugnis ist
sozusagen wieder sauber. |:-)|

Aber freuen wir uns nicht zu früh, denn nach dem nächsten
unautorisierten FW-Update bzw. dem folgenden Telnet-Login ist die
Meldung wieder da. Was kann man also noch tun?

.. _SäuberungsaktionbeimSystemstart:

Säuberungsaktion beim Systemstart
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Obige Befehlssequenz kann man selbstverständlich auch
``/var/flash/debug.cfg`` ausführen lassen. Solange man sich nicht per
Telnet anmeldet, ist die Meldung damit weg, auch wenn man zuvor gerade
ein FW-Update eingespielt hat. Tip: Mit SSH zu arbeiten, stört die
FritzBox nicht, denn damit rechnet sie nicht und kreidet es uns somit
auch nicht als Manipulation an. Wer also ein Freetz mit
`Dropbear <../../../packages/dropbear.html>`__ hat, ist fein heraus.

.. _RegelmäßigesAufräumenmitcron:

Regelmäßiges Aufräumen mit cron
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Mit Freetz hat man auch die Möglichkeit, einen *cron*-Job nach dem
Rechten sehen und aufräumen zu lassen. Selbst wenn man also *Telnet*
benutzt, ist, je nach eingestellter Frequenz, nach ein paar Minuten
wieder das Flag gelöscht.

.. _TelnetruhigstellenperHex-Editor:

Telnet ruhig stellen per Hex-Editor
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Wenn wir uns ein wenig in den Eingeweiden der Firmware umschauen,
stellen wir fest, daß nicht ``telnetd`` selbst das entsprechende Flag
setzt. Nein, es ist ``/sbin/ar7login``. ``telnetd`` selbst wird ja wie
folgt aufgerufen, um eine Anmeldung zu ermöglichen:

::

   telnetd -l /sbin/ar7login

Wer mit einem Hex-Editor (unter Linux z.B. *hexedit* aus dem
gleichnamigen Paket) ``ar7login`` öffnet, findet schnell die
Zeichenkette "TELNET" in Großbuchstaben. Genau diese Zeichenkette
schreibt das Programm nach ``fw_attrib``. Ersetzt man den ersten
Buchstaben durch ein Null-Byte, entspricht das dem Ersetzen des Wortes
durch eine Zeichenkette der Länge null, Strings in C sind schließlich
null-terminiert. (Ziemlich oft das Wort "null", Entschuldigung.)
Abspeichern, Firmware neu bauen, flashen - fürderhin bleiben wir
verschont von Klassenbucheinträgen für Telnet-Logins.

.. _NachgelagertesAufräumenperProxy-SkriptFirmware-Variante:

Nachgelagertes Aufräumen per Proxy-Skript (Firmware-Variante)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Vielleicht traut sich nicht jeder die Arbeit mit dem Hex-Editor zu. Es
geht auch ohne. Anstatt ``ar7login`` binär zu manipulieren, wenden wir
einen Proxy-Ansatz an: Wir benennen ``/sbin/ar7login`` um in z.B.
``/sbin/ar7login-binary`` und setzen an seine Stelle ein Shell-Skript
``/sbin/ar7login``:

::

   #!/bin/sh
   /sbin/ar7login-binary $*
   major=$(grep tffs /proc/devices)
   tffs_major=${major%%tffs}
   rm -f /var/flash/fw_attrib
   mknod /var/flash/fw_attrib c $tffs_major 87
   echo -n "" > /var/flash/fw_attrib

Wir reichen also einfach alle Parameter durch an ``ar7login`` und
löschen danach umgehend wieder dessen Spuren im Klassenbuch. |;-)|
Anschließend gilt analog zu Variante 1: Firmware bauen, flashen,
glücklich sein. |/!\\| **Achtung: Das Flag wird erst gelöscht, nachdem
die Telnet-Sitzung wieder beendet wird.**

.. _NachgelagertesAufräumenperProxy-SkripttransienteVariante:

Nachgelagertes Aufräumen per Proxy-Skript (transiente Variante)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Wem das Firmware-Bauen zu umständlich ist, kann die Proxy-Methode auch
dynamisch zur Laufzeit einsetzen, indem folgende Sequenz in
``/var/flash/debug.cfg`` eingebaut wird:

::

   cat << EOF > /var/tmp/ar7login-proxy
   #!/bin/sh
   /var/tmp/ar7login-binary \$*
   major=\$(grep tffs /proc/devices)
   tffs_major=\${major%%tffs}
   rm -f /var/flash/fw_attrib
   mknod /var/flash/fw_attrib c \$tffs_major 87
   echo -n "" > /var/flash/fw_attrib
   EOF

   chmod +x /var/tmp/ar7login-proxy
   cp /sbin/ar7login /var/tmp/ar7login-binary
   mount -o bind /var/tmp/ar7login-proxy /sbin/ar7login

Wie man sieht, wird ``ar7login`` zunächst nach
``/var/tmp/ar7login-binary`` kopiert. Das dynamisch erzeugte Skript
``/var/tmp/ar7login-proxy`` wird ausführbar gemacht und überlagert durch
``mount - o bind`` die Datei ``/sbin/ar7login``, nur um als Proxy
wiederum auf das kopierte Binary zu verweisen und nach Ende der Sitzung
dann wieder das Telnet-Flag zu löschen.

.. _AufräumendirektnachdemLoginFirmware-Variante:

Aufräumen direkt nach dem Login (Firmware-Variante)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Die beiden Proxy-Varianten haben den Nachteil, während der Dauer der
Telnet-Sitzung auf deren Beendigung zu warten und erst anschließend das
Flag zu löschen. Wenn wir stattdessen unseren Aufräum-Code ins globale
Shell-Profil ``/etc/profile`` einbauen, wird er jeweils direkt nach dem
Login ausgeführt. Es gibt also keine signifikante Latenzzeit, in der die
Flags gesetzt sind, denn das Aufräumen erfolgt ja bereits zu Beginn der
Telnet-Sitzung.

::

   # ... normaler Inhalt von /etc/profile ...

   major=$(grep tffs /proc/devices)
   tffs_major=${major%%tffs}
   rm -f /var/flash/fw_attrib
   mknod /var/flash/fw_attrib c $tffs_major 87
   echo -n "" > /var/flash/fw_attrib

.. _AufräumendirektnachdemLogintransienteVariante:

Aufräumen direkt nach dem Login (transiente Variante)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Ebenso wie bei der Proxy-Methode gilt auch hier: Das Profil kann auch
beim Booten aus ``/var/flash/debug.cfg`` heraus umgeschrieben werden,
indem man es per ``mount`` der Original-Datei überlagert:

::

   cp /etc/profile /var/tmp/profile

   cat << EOF >> /var/tmp/profile
   major=\$(grep tffs /proc/devices)
   tffs_major=\${major%%tffs}
   rm -f /var/flash/fw_attrib
   mknod /var/flash/fw_attrib c \$tffs_major 87
   echo -n "" > /var/flash/fw_attrib
   EOF

   mount -o bind /var/tmp/profile /etc/profile

Man beachte, daß dieses Mal ``cat`` keine Datei erzeugt, sondern seine
Ausgabe an die zuvor kopierte Originaldatei anhängt. Da wir auch nicht
irgendwelche komplizierten Proxy-Konstrukte haben, brauchen wir uns auch
nicht zu verrenken mit der Namensgebung der Shell-Profile.

.. _FreetzPatch:

Freetz Patch
~~~~~~~~~~~~

Mit einem `Patch <../../../patches/signed.html>`__ für
`Freetz <../../../freetz.html>`__ lässt sich der ganze obige Stress
vermeiden, und die vermaledeite Meldung ist weg. Da unterstreicht das
"Free" in "Freetz" doch gleich, was es heißt |:-)|

.. _einfacheresLöschen:

einfacheres Löschen
~~~~~~~~~~~~~~~~~~~

Man kann tffs-Dateien auch über /proc/tffs löschen. In diesem Fall ist
der Befehl:

.. code:: wiki

   echo clear_id 87 > /proc/tffs

.. _SchlußwortundAusblick:

Schlußwort und Ausblick
-----------------------

Wozu die vielen Varianten, wenn es mit dem Patch doch so einfach geht?
Ich dachte mir, ich erkläre mal die unterschiedlichen Ansätze, wie man
beim FritzBox-Modding grundsätzlich vorgehen kann - von minimal-invasiv
aus der ``debug.cfg`` heraus über die Manipulation von Skripten in der
Firmware bis hin zum Patchen einer Binärdatei. Ich hoffe, meine
Anregungen helfen anderen Mitstreitern beim Entwickeln von Konzepten, um
die gute AVM-Firmware mit neuen Ideen noch ein bißchen besser, bequemer
oder einfach cooler zu machen - kurz: um zu erreichen, was auch AVM uns
nicht übel nehmen dürfte: optimale Ausnutzung der Hard- und Software,
die wir beim Hersteller oder einem seiner Vertriebspartner gekauft
haben.

Was bleibt bzgl. dieses Themas noch offen? Nun, da sind immer noch die
digitalen Signaturen, mit denen die Firmware-Images versehen sind. Sie
sind an sich nichts Schlechtes, im Gegenteil. AVM, T-Com und 1&1 tun gut
daran, ihre jeweiligen Firmware-Versionen eindeutig als solche zu
kennzeichnen und weisen mit Recht bei fehlerhafter Verifikation der
Signaturen darauf hin, daß Support-Ansprüche für modifizierte Firmwares
nicht mehr bestehen. Was ist aber, falls eines Tages der Hersteller oder
einer seiner OEM-Partner beschließen sollten, die Boxen so zu
konfigurieren, daß nicht korrekt signierte Firmware-Versionen nicht mehr
zum Flashen angenommen würden? Das wäre eine Beschneidung der
Benutzerrechte, für die es keinen triftigen Grund gäbe. Deswegen habe
ich mir kürzlich die Signatur-Mechanismen angeschaut und auch hier
Mittel und Wege gefunden, sie zu entschärfen. Mehr dazu gibt es ein
anderes Mal.

Weiterhin happy modding wünscht Euch

`​Alexander Kriegisch
(kriegaex) <http://www.ip-phone-forum.de/member.php?u=117253>`__

—-

Anmerkung: Ich habe eben in meiner neuen FBF 7170 (FW 29.4.32-7153) das
schreiben in ``/var/flash/fw_attrib`` versucht. Zunächst lies dies die
Meldung im Web-Interface jedoch vollkommen unbeeindruckt. Erst als ich
mit

::

   echo -n "\0\0\0\0\0\0" >/var/flash/fw_attrib

mein "TELNET" in dem fw_attrib überschrieben habe, verschwand die
Meldung im Web-Interface! Kann es sein, daß es notwendig ist die
betreffenden Daten zu überschreiben (mit binär 0 = Stringende)?

Harald Becker (ralda)

.. |:-)| image:: ../../../../chrome/wikiextras-icons-16/smiley.png
.. |;-)| image:: ../../../../chrome/wikiextras-icons-16/smiley-wink.png
.. |/!\\| image:: ../../../../chrome/wikiextras-icons-16/exclamation.png

