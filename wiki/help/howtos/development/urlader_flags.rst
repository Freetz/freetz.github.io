help/howtos/development/urlader_flags
=====================================
Howtos: Entwicklung
^^^^^^^^^^^^^^^^^^^

#. `Entpacken und Packen von
   Firmware-Images <repack_fw.html#EntpackenundPackenvonFirmware-Images>`__

   #. `Tools und Syntax <repack_fw.html#ToolsundSyntax>`__
   #. `Vorgehensweise <repack_fw.html#Vorgehensweise>`__
   #. `Verwendung von fwmod im "no
      freetz"-Modus <repack_fw.html#Verwendungvonfwmodimnofreetz-Modus>`__

#. `Patches in Freetz
   einspielen <integrate_patches.html#PatchesinFreetzeinspielen>`__
#. `Example 3:
   NZBGet <developer_information/package_development_start/example_3.html#Example3:NZBGet>`__

   #. `Build
      manually <developer_information/package_development_start/example_3.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_3.html#AddpackagetoFreetz>`__
   #. `Create new image with added
      package <developer_information/package_development_start/example_3.html#Createnewimagewithaddedpackage>`__
   #. `Testing <developer_information/package_development_start/example_3.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_3.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. `Example 2:
   par2cmdline <developer_information/package_development_start/example_2.html#Example2:par2cmdline>`__

   #. `Build
      manually <developer_information/package_development_start/example_2.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_2.html#AddpackagetoFreetz>`__
   #. `Create new image with added
      package <developer_information/package_development_start/example_2.html#Createnewimagewithaddedpackage>`__
   #. `Testing <developer_information/package_development_start/example_2.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_2.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. `Example 1:
   Httptunnel <developer_information/package_development_start/example_1.html#Example1:Httptunnel>`__

   #. `Build
      manually <developer_information/package_development_start/example_1.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_1.html#AddpackagetoFreetz>`__
   #. `Call Procedures "make menuconfig" and
      "make" <developer_information/package_development_start/example_1.html#CallProceduresmakemenuconfigandmake>`__
   #. `Testing <developer_information/package_development_start/example_1.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_1.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. 

   #. `Signieren von Firmware <sign_image.html#SignierenvonFirmware>`__
   #. `Konkrete Anwendung in
      Freetz <sign_image.html#KonkreteAnwendunginFreetz>`__

#. `Ablauf eines
   Firmware-Updates <firmware_update_details.html#AblaufeinesFirmware-Updates>`__
#. `Eigene Programme
   kompilieren <compile_own_progs.html#EigeneProgrammekompilieren>`__
#. `Dynamische Bandbreitenanzeige per
   SVG <bandwidth_svg.html#DynamischeBandbreitenanzeigeperSVG>`__

   #. `Anleitung zur
      Test-Installation <bandwidth_svg.html#AnleitungzurTest-Installation>`__

#. `Platz sparen im Dateisystem der
   FritzBox <make_room.html#PlatzsparenimDateisystemderFritzBox>`__

   #. `Vorwort und Motivation <make_room.html#VorwortundMotivation>`__
   #. `Bestandsaufnahme: Wo stecken die
      Platzfresser? <make_room.html#Bestandsaufnahme:WosteckendiePlatzfresser>`__
   #. `Weitere Spartricks <make_room.html#WeitereSpartricks>`__
   #. `Schlußwort <make_room.html#Schlußwort>`__

#. `Flash-Partitionen im laufenden Betrieb
   sichern <save_mtd_1.html#Flash-PartitionenimlaufendenBetriebsichern>`__

   #. `Motivation <save_mtd_1.html#Motivation>`__
   #. `Voraussetzungen <save_mtd_1.html#Voraussetzungen>`__
   #. `Lösungsweg <save_mtd_1.html#Lösungsweg>`__
   #. `Wege, sich schnell einen Überblick zu
      verschaffen <save_mtd_1.html#WegesichschnelleinenÜberblickzuverschaffen>`__
   #. `Zusammenfassung <save_mtd_1.html#Zusammenfassung>`__

#. `Release Management <release_management.html#ReleaseManagement>`__

   #. `Subversion
      Repository <release_management.html#SubversionRepository>`__
   #. `Checklists <release_management.html#Checklists>`__
   #. `GIT <release_management.html#GIT>`__
   #. `Downloads <release_management.html#Downloads>`__
   #. `References <release_management.html#References>`__

#. `First steps - How to start your first freetz
   package <developer_information/package_development_start.html#Firststeps-Howtostartyourfirstfreetzpackage>`__

   #. `Info <developer_information/package_development_start.html#Info>`__
   #. `Build
      Environment <developer_information/package_development_start.html#BuildEnvironment>`__
   #. `File
      Structure <developer_information/package_development_start.html#FileStructure>`__
   #. `Examples Binary
      Package <developer_information/package_development_start.html#ExamplesBinaryPackage>`__
   #. `Configuration
      Handling <developer_information/package_development_start.html#ConfigurationHandling>`__
   #. `Examples
      Web-Interface <developer_information/package_development_start.html#ExamplesWeb-Interface>`__
   #. `Trouble
      shooting <developer_information/package_development_start.html#Troubleshooting>`__

#. `Kernel konfigurieren und
   kompilieren <make_kernel.html#Kernelkonfigurierenundkompilieren>`__
#. `Menükonfiguration
   pflegen <menuconfig.html#Menükonfigurationpflegen>`__

   #. `Einstieg <menuconfig.html#Einstieg>`__
   #. `Beispiel-Konfiguration für ein neues
      Paket <menuconfig.html#Beispiel-KonfigurationfüreinneuesPaket>`__
   #. `Menuconfig-Warnungen
      beheben <menuconfig.html#Menuconfig-Warnungenbeheben>`__
   #. `Erklärung und Anwendung der erweiterten
      MK-Targets <menuconfig.html#ErklärungundAnwendungdererweitertenMK-Targets>`__
   #. `Syntax-Fehler in MK-Dateien
      finden <menuconfig.html#Syntax-FehlerinMK-Dateienfinden>`__
   #. `Syntax-Hervorhebung für
      MK-Dateien <menuconfig.html#Syntax-HervorhebungfürMK-Dateien>`__

#. `ADAM2-Bootloader <adam2.html#ADAM2-Bootloader>`__

   #. `Bootloader-Backup
      anlegen <adam2.html#Bootloader-Backupanlegen>`__
   #. `Bootloader überschreiben <adam2.html#Bootloaderüberschreiben>`__
   #. `Bootloader-Befehle <adam2.html#Bootloader-Befehle>`__
   #. `Bootloader-Quelltext <adam2.html#Bootloader-Quelltext>`__
   #. `Aufbau des Bootloaders <adam2.html#AufbaudesBootloaders>`__
   #. `Bootloader und Freetz <adam2.html#BootloaderundFreetz>`__

#. `Einstellungen speichern im
   Urlader-Environment <urlader_flags.html#EinstellungenspeichernimUrlader-Environment>`__

   #. `Vorwort und
      Motivation <urlader_flags.html#VorwortundMotivation>`__
   #. `Lösungsmöglichkeiten <urlader_flags.html#Lösungsmöglichkeiten>`__
   #. `Bootloader
      Environment <urlader_flags.html#BootloaderEnvironment>`__
   #. `Variable
      "kernel_args" <urlader_flags.html#Variablekernel_args>`__
   #. `Kernel_Args-API <urlader_flags.html#Kernel_Args-API>`__
   #. `Mögliche
      Anwendungsfälle <urlader_flags.html#MöglicheAnwendungsfälle>`__

#. `Busybox konfigurieren und
   kompilieren <make_busybox.html#Busyboxkonfigurierenundkompilieren>`__
#. `Wie baue ich ein eigenes Paket für
   Freetz? <package_creation.html#WiebaueicheineigenesPaketfürFreetz>`__
#. `Firmware-Image-Namen analysieren und
   interpretieren <analyse_image_names.html#Firmware-Image-Namenanalysierenundinterpretieren>`__

   #. `Einleitung <analyse_image_names.html#Einleitung>`__
   #. `Skript-Code <analyse_image_names.html#Skript-Code>`__
   #. `Daten im Rohformat <analyse_image_names.html#DatenimRohformat>`__
   #. `Ausgabe grundlegender
      Informationen <analyse_image_names.html#AusgabegrundlegenderInformationen>`__
   #. `Ausgabe erweiterter
      Informationen <analyse_image_names.html#AusgabeerweiterterInformationen>`__

#. 

   #. `Web-interface
      HTTPTunnel <developer_information/package_development_start/webinterface_example_1.html#Web-interfaceHTTPTunnel>`__

#. `Developer
   Information <developer_information.html#DeveloperInformation>`__
#. `Addon Paket
   installieren <install_addon.html#AddonPaketinstallieren>`__
#. `Paketverwaltung für
   Freetz <developer_information/package_development_dynamic.html#PaketverwaltungfürFreetz>`__

   #. `Erweiterung des
      Dateisystems <developer_information/package_development_dynamic.html#ErweiterungdesDateisystems>`__
   #. `Paketverwaltung <developer_information/package_development_dynamic.html#Paketverwaltung>`__
   #. `Links <developer_information/package_development_dynamic.html#Links>`__
   #. `Kommentare <developer_information/package_development_dynamic.html#Kommentare>`__

#. `Wie die FritzBox Manipulationen
   erkennt <manipulation_detection.html#WiedieFritzBoxManipulationenerkennt>`__

   #. `Ursachen <manipulation_detection.html#Ursachen>`__
   #. `Diagnose <manipulation_detection.html#Diagnose>`__
   #. `Lösungen <manipulation_detection.html#Lösungen>`__
   #. `Schlußwort und
      Ausblick <manipulation_detection.html#SchlußwortundAusblick>`__

#. `Shell Coding
   Conventions <developer_information/shell_coding_conventions.html#ShellCodingConventions>`__

   #. `Shell
      Language <developer_information/shell_coding_conventions.html#ShellLanguage>`__
   #. `Basic
      Format <developer_information/shell_coding_conventions.html#BasicFormat>`__
   #. `If, For, and
      While <developer_information/shell_coding_conventions.html#IfForandWhile>`__
   #. `Test
      Built-in <developer_information/shell_coding_conventions.html#TestBuilt-in>`__
   #. `Single-line conditional
      statements <developer_information/shell_coding_conventions.html#Single-lineconditionalstatements>`__
   #. `Infinite
      Loops <developer_information/shell_coding_conventions.html#InfiniteLoops>`__
   #. `Exit Status and If/While
      Statements <developer_information/shell_coding_conventions.html#ExitStatusandIfWhileStatements>`__
   #. `Variable
      References <developer_information/shell_coding_conventions.html#VariableReferences>`__
   #. `Variable
      Naming <developer_information/shell_coding_conventions.html#VariableNaming>`__
   #. `Quoting <developer_information/shell_coding_conventions.html#Quoting>`__
   #. `Variable
      Assignments <developer_information/shell_coding_conventions.html#VariableAssignments>`__
   #. `Testing for (Non-)Empty
      Strings <developer_information/shell_coding_conventions.html#TestingforNon-EmptyStrings>`__
   #. `Commenting <developer_information/shell_coding_conventions.html#Commenting>`__
   #. `Pathnames <developer_information/shell_coding_conventions.html#Pathnames>`__
   #. `Interpreter
      Magic <developer_information/shell_coding_conventions.html#InterpreterMagic>`__

#. `Package
   Development <developer_information/package_development.html#PackageDevelopment>`__

   #. `Persistent Package
      Settings <developer_information/package_development.html#PersistentPackageSettings>`__

#. `Erstellen einer GUI für Pakete in
   Freetz <create_gui.html#ErstelleneinerGUIfürPaketeinFreetz>`__

   #. `Motivation <create_gui.html#Motivation>`__
   #. `Grundlagen <create_gui.html#Grundlagen>`__
   #. `Wie funktioniert das mit der
      GUI? <create_gui.html#WiefunktioniertdasmitderGUI>`__

#. `Flash Partitionierung <flash.html#FlashPartitionierung>`__

   #. `Hidden SquashFS <flash.html#HiddenSquashFS>`__
   #. `Contiguous SquashFS <flash.html#ContiguousSquashFS>`__
   #. `Hidden Root <flash.html#HiddenRoot>`__
   #. `NAND Root <flash.html#NANDRoot>`__
   #. `Dateisystem <flash.html#Dateisystem>`__
   #. `Kernel <flash.html#Kernel>`__
   #. `Weblinks <flash.html#Weblinks>`__

#. `Trac
   Hooks <developer_information/post_commit_hook.html#TracHooks>`__

   #. `trac-post-commit-hook <developer_information/post_commit_hook.html#trac-post-commit-hook>`__
   #. `trac-post-revprop-change-hook <developer_information/post_commit_hook.html#trac-post-revprop-change-hook>`__

#. `Package Developing - Advanced
   Topics <developer_information/package_development_advanced.html#PackageDeveloping-AdvancedTopics>`__

   #. `Adding conditional
      patches <developer_information/package_development_advanced.html#Addingconditionalpatches>`__
   #. `Adding multi-binary
      packages <developer_information/package_development_advanced.html#Addingmulti-binarypackages>`__

#. `Eigene Dateien in die Firmware
   integrieren <integrate_own_files.html#EigeneDateienindieFirmwareintegrieren>`__

   #. `Feste Integration über das Freetz
      Image <integrate_own_files.html#FesteIntegrationüberdasFreetzImage>`__
   #. `Erzeugen der Dateien aus der
      debug.cfg <integrate_own_files.html#ErzeugenderDateienausderdebug.cfg>`__
   #. `Nachladen vom
      Webserver <integrate_own_files.html#NachladenvomWebserver>`__
   #. `Nachladen vom
      USB-Stick <integrate_own_files.html#NachladenvomUSB-Stick>`__
   #. `WebDAV Share
      mounten <integrate_own_files.html#WebDAVSharemounten>`__
   #. `NFS-Share mounten <integrate_own_files.html#NFS-Sharemounten>`__

#. `Freetz Build-Prozeß <freetz_make.html#FreetzBuild-Prozeß>`__

   #. `Vorwort und Motivation <freetz_make.html#VorwortundMotivation>`__
   #. `Grundsätzliches <freetz_make.html#Grundsätzliches>`__

#. `Flash-Partitionen von außen mit FTP
   sichern <save_mtd_2.html#Flash-PartitionenvonaußenmitFTPsichern>`__

   #. `Motivation <save_mtd_2.html#Motivation>`__
   #. `Voraussetzungen <save_mtd_2.html#Voraussetzungen>`__
   #. `Allgemeine Informationen zur
      Datensicherung <save_mtd_2.html#AllgemeineInformationenzurDatensicherung>`__
   #. `Sicherung mit Linux-Standard-FTP
      (ftp) <save_mtd_2.html#SicherungmitLinux-Standard-FTPftp>`__
   #. `Sicherung mit Linux-NcFTP
      (ncftpget) <save_mtd_2.html#SicherungmitLinux-NcFTPncftpget>`__
   #. `Sicherung mit Cygwin-NcFTP
      (ncftpget) <save_mtd_2.html#SicherungmitCygwin-NcFTPncftpget>`__
   #. `Uploads via FTP <save_mtd_2.html#UploadsviaFTP>`__

#. `libmodcgi.sh <developer_information/webif/libmodcgi.html#libmodcgi.sh>`__

   #. `cgi <developer_information/webif/libmodcgi.html#cgi>`__
   #. `cgi_begin <developer_information/webif/libmodcgi.html#cgi_begin>`__
   #. `cgi_end <developer_information/webif/libmodcgi.html#cgi_end>`__
   #. `sec_begin <developer_information/webif/libmodcgi.html#sec_begin>`__
   #. `sec_end <developer_information/webif/libmodcgi.html#sec_end>`__
   #. `html <developer_information/webif/libmodcgi.html#html>`__
   #. `check,
      select <developer_information/webif/libmodcgi.html#checkselect>`__
   #. `href <developer_information/webif/libmodcgi.html#href>`__
   #. `back_button <developer_information/webif/libmodcgi.html#back_button>`__
   #. `sec_level <developer_information/webif/libmodcgi.html#sec_level>`__
   #. `stat_bar <developer_information/webif/libmodcgi.html#stat_bar>`__
   #. `cgi_param <developer_information/webif/libmodcgi.html#cgi_param>`__
   #. `cgi_error,
      print_error <developer_information/webif/libmodcgi.html#cgi_errorprint_error>`__
   #. `path_info <developer_information/webif/libmodcgi.html#path_info>`__
   #. `valid <developer_information/webif/libmodcgi.html#valid>`__

#. `Cross-Compiler / Toolchain
   erstellen <create_cross-compiler_toolchain.html#Cross-CompilerToolchainerstellen>`__
#. `Eigene Download-Toolchain
   erstellen <create_cross-compiler_toolchain.html#EigeneDownload-Toolchainerstellen>`__
#. `Target/Native-Compiler-Toolchain
   erstellen <create_cross-compiler_toolchain.html#TargetNative-Compiler-Toolchainerstellen>`__

   #. `Using the dev-tools package to install compiler and
      tools <create_cross-compiler_toolchain.html#Usingthedev-toolspackagetoinstallcompilerandtools>`__

.. _EinstellungenspeichernimUrlader-Environment:

Einstellungen speichern im Urlader-Environment
==============================================

.. _VorwortundMotivation:

Vorwort und Motivation
----------------------

Es kann von Vorteil sein, während des Boot-Prozesses oder evtl. auch
danach noch gewisse Schalter (engl. flags) abfragen zu können, ohne
deswegen gleich auf ``/var/flash/debug.cfg`` zugreifen zu müssen. Dafür
gibt es folgende Gründe:

-  Die Character Devices unter ``/var/flash`` sind erst nach Ablauf von
   ``/etc/init.d/rc.S`` verfügbar, weil sie in diesem Skript erst
   mittels ``mknod`` erzeugt werden - speziell ``debug.cfg`` übrigens
   erst separat am Ende des Skripts.
-  Gewisse Funktionalitäten würden wir gerne aufrufen, **bevor**
   *``rc.S``* läuft. Bestes Beispiel sind Root-Mounts, z.B. das
   Freetz-Paket `mini_fo <../../../packages/mini_fo.html>`__, dessen
   Init-Skript sich in ``/etc/inittab`` vor ``rc.S`` einträgt. Würden
   wir jetzt gerne einen Schalter haben, der das Laden von ``mini_fo``
   verhindern kann, hätten wir ein Problem.

.. _Lösungsmöglichkeiten:

Lösungsmöglichkeiten
--------------------

Kein Problem ohne Lösung. Wir könnten innerhalb von ``rc.mini_fo``
selbst ``mknod`` verwenden, um ``debug.cfg`` temporär zugreifbar zu
machen und nach Abfragen der gewünschten Information wieder aufräumen
mit ``rm``, damit später ``rc.S`` nicht irritiert wird beim erneuten
Erzeugen des Nodes. Es gibt tatsächlich ein Paket
(`NFS-Root <../../../packages/nfs.html>`__), welches diese Technik
verwendet, um auf AVM-Konfigurationsdaten aus dem TFFS zuzugreifen,
zusätzlich aber auch noch Informationen von woanders einholt, und zwar
aus dem sog. Bootloader Environment (Urlader-Umgebungsvariablen). Schon
seit 15.0 greifen auch zwei (noch) undokumentierte Logging-Werkzeuge des
DS-Mod, `Inotify-Tools <../../../packages/inotify-tools.html>`__ und
*Dmesg-Recording*, auf diese Umgebungsvariablen zu, die beiden Letzteren
sogar über ein kleines, funktional auf bestimmte Anwendungsfälle
eingegrenztes Shell-API, das ich mir habe einfallen lassen. Dazu später
mehr.

.. _BootloaderEnvironment:

Bootloader Environment
----------------------

Der Urlader (engl. bootloader), je nach Version auch bekannt unter
`ADAM2 <adam2.html>`__ oder EVA, besitzt ein sog. Environment, also
einen kleinen Speicherbereich für globale Einstellungen, welche absolut
erforderlich sind, damit die Box überhaupt funktioniert. Das ist ja
bekannt, aber zur Auffrischung nochmals die (mit "#" anonymisierte)
Ausgabe, generiert auf meiner 7170 mit Kernel 2.6:

.. code:: wiki

   $ cat /proc/sys/urlader/environment
   HWRevision      94.1.1.0
   ProductID       Fritz_Box_7170
   SerialNumber    0000000000000000
   annex   B
   autoload        yes
   bootloaderVersion       1.153
   bootserport     tty0
   bluetooth       ##:##:##:##:##:##
   cpufrequency    211968000
   firstfreeaddress        0x946AE530
   firmware_version        1und1
   firmware_info   29.04.29
   flashsize       0x00800000
   maca    ##:##:##:##:##:##
   macb    ##:##:##:##:##:##
   macwlan ##:##:##:##:##:##
   macdsl  ##:##:##:##:##:##
   memsize 0x02000000
   modetty0        38400,n,8,1,hw
   modetty1        38400,n,8,1,hw
   mtd0    0x90000000,0x90000000
   mtd1    0x90010000,0x90780000
   mtd2    0x90000000,0x90010000
   mtd3    0x90780000,0x907C0000
   mtd4    0x907C0000,0x90800000
   my_ipaddress    192.168.178.1
   prompt  AVM_Ar7
   ptest
   reserved        ##:##:##:##:##:##
   req_fullrate_freq       125000000
   sysfrequency    125000000
   urlader-version 1153
   usb_board_mac   ##:##:##:##:##:##
   usb_rndis_mac   ##:##:##:##:##:##
   usb_device_id   0x3D00
   usb_revision_id 0x0200
   usb_device_name USB DSL Device
   usb_manufacturer_name   AVM
   wlan_key        ################
   wlan_cal        ####,####,####,####,####,####,####,####,####

Das Schöne an diesem Environment ist, dass es nicht nur lesbar, sondern
auch (teilweise) beschreibbar ist. Das wird gern verwendet, um
Anpassungen am Annex oder am Branding vorzunehmen, insbesondere bei
OEM-Boxen, deren Besitzer gern eine vollwertige FritzBox daraus machen
möchten, um die entsprechenden Original-Firmware oder Freetz darauf zu
installieren, bzw. auch, um eine deutsche Box im Ausland lauffähig zu
machen oder umgekehrt.

Es ist bei den allermeisten Werten im Environment absolut nicht ratsam,
sie für andere Zwecke zu missbrauchen, aber es gibt eine oben gar nicht
sichtbare Variable, die dafür geschaffen wurde, dem Linux-Kernel
Parameter für den Boot-Vorgang mitzugeben. Diese Parameter werden später
weitergereicht an die Startskripte, aber auch gleichzeitig persistent
gespeichert und sind somit ideal geeignet, um Werte von dort abzufragen.

.. _Variablekernel_args:

Variable "kernel_args"
----------------------

Die Variable, von der hier die Rede ist, heißt ``kernel_args``, fasst
maximal 64 Zeichen an Informationen und sollte daher mit Bedacht
verwendet werden. Man kann folgendermaßen etwas hinein schreiben:

::

   echo "kernel_args tea=Darjeeling quality=FTGFOP1" > /proc/sys/urlader/environment

Damit würden wir ein eigens dafür entworfenes (leider fiktives)
Startskript der FritzBox anweisen, beim Hochfahren der Box Tee zu
kochen, und zwar Darjeeling der Qualitätsstufe FTGFOP1 (Finest Tippy
Golden Flowery Orange Pekoe 1).

Wenn man sich jetzt das Environment nochmals anzeigen lässt, findet man
plötzlich dort die Variable ``kernel_args`` vor:

::

   $ cat /proc/sys/urlader/environment | grep kernel_args
   kernel_args     tea=Darjeeling quality=FTGFOP1

Mit ein bisschen Zeichenketten-Manipulation können wir den Wert von
``kernel_args`` isolieren und dann weiter zerlegen in unsere beiden
Schlüssel-Werte-Paare. Darauf will ich an dieser Stelle nicht weiter
eingehen, das sind Grundlagen der Shell-Programmierung.

Jedoch wichtig zu wissen ist, wie man während des Boot-Vorgangs an diese
Variable heran kommt. Die Antwort hängt davon ab, zu welchem Zeitpunkt
man den Zugriff benötigt. Sofern das virtuelle Dateisystem unter
``/proc`` bereits zugreifbar, das sog. *procfs* also bereits ins
Root-Dateisystem per ``mount`` eingehängt wurde, können wir so vorgehen
wie oben gezeigt. Andernfalls müssen wir zunächst mittels

::

   [ -e /proc/mounts ] || mount proc

*procfs* selbst einhängen, falls es noch nicht da ist. Nach Benutzung
loswerden können wir es entsprechend über ``umount proc``

.. _Kernel_Args-API:

Kernel_Args-API
---------------

Für einfache, auf Debugging oder Logging ausgerichtete Anwendungsfälle,
die innerhalb von ``kernel_args`` auskommen mit den Werten

-  aktiv/ja,
-  inaktiv/nein,
-  Countdown-Zähler > 0,

gibt es das Shell-Skript ``kernel_args``, welches man mit
``. /usr/bin/kernel_args`` in ein laufendes Skript inkludieren und
daraufhin auf verschiedene vorgefertigte Funktionen zur Manipulation von
innerhalb der Bootloader-Variablen ``kernel_args`` gespeicherten
Schlüssel-Werte-Paaren zugreifen kann. Das Skript ist in den enthaltenen
Kommentarzeilen gut dokumentiert, daher hier nur eine kurze Auflistung
der aktuell (ds26-15.2) verfügbaren Funktionen:

-  **ka_mountProc:** ``/proc`` mounten, falls notwendig
-  **ka_getArgs:** ``kernel_args`` komplett auslesen
-  **ka_getKeyValuePair:** Schlüssel-Wert-Paar zu geg. Schlüssel
   ermitteln
-  **ka_isValidName:** Schlüsselnamen auf Validität prüfen
-  **ka_isValidValue:** Wert auf Validität (y, n, Zahl > 0) prüfen
-  **ka_getValue:** Wert zu einem Schlüssel ermitteln
-  **ka_setValue:** Wer zu einem Schlüssel setzen
-  **ka_removeVariable:** Schlüssel-Wert-Paar löschen
-  **ka_removeVariableNoUpdate:** wie oben, aber nur neuen Wert von
   ``kernel_args`` nach angenommener Entfernung eines Paares anzeigen,
   nicht direkt ins Environment schreiben
-  **ka_isPositiveInteger:** Hilfsfunktion zum Prüfen numerischer Werte
-  **ka_isActiveVariable:** Prüfen, ob Wert > 0 oder "y" (aktiv)
-  **ka_decreaseValue:** Positiven Ganzzahlwert um 1 vermindern. Falls
   er 0 werden würde, Wert durch "n" (inaktiv) ersetzen

.. _Countdown-Trick:

Countdown-Trick
~~~~~~~~~~~~~~~

Gerade die letzten beiden Aufrufe ermöglichen ein hilfreiches Konstrukt
beim Entwickeln von Startskripten: Man kann eine Variable z.B. auf 5
setzen und bei jedem Startvorgang um 1 vermindern, bis sie nach fünf
Durchläufen auf "n" (inaktiv) gesetzt wird. Abhängig davon könnte man
den weiteren Verlauf eines Skripts beeinflussen, es also fortsetzen oder
vorzeitig beenden. Sollte im weiteren Verlauf des Skripts also ein
Fehler auftauchen, der den Startvorgang der Box torpediert, so daß man
nicht mehr an sie heran kommt ohne Recover, wäre dieser Countdown eine
praktische Hilfe, denn spätestens beim sechsten Anlauf würde ja die
fehlerhafte Funktion nicht mehr aktiviert sein und die Box normal weiter
gestartet werden. Wir retten uns hiermit also vor uns selbst und ziehen
uns an den eigenen Haaren aus dem Sumpf! |;-)|

.. _Grenzendeskernel_args-API:

Grenzen des kernel_args-API
~~~~~~~~~~~~~~~~~~~~~~~~~~~

Sobald wir andere Arten von Werten in ``kernel_args`` speichern wollen,
z.B. etwas wie ``my_path=/usr/bin/my_script``, versagt das API in der
momentanen Version seinen Dienst, weil es ja nur die Werte "y", "n",
positive Ganzzahl zulässt. Aber oben steht ja, wie man auch damit
umgehen kann durch Direktzugriff. Eines Tages erweitere ich vielleicht
auch das API.

.. _MöglicheAnwendungsfälle:

Mögliche Anwendungsfälle
------------------------

**Root-Mounts:** Dienste wie ``mini_fo`` zur virtuellen Überlagerung des
Root-Dateisystems durch eine RAM-Disk oder einen externen Speicher, um
Schreibzugriffe zu ermöglichen oder *NFS-Root*, also der vollständige
Ersatz des Root-Dateisystems durch einen voll beschreibbaren und
größenmäßig quasi unbegrenzten Netzwerk-Mount könnten von Schaltern im
Bootloader Environment profitieren, weil man sie bei Bedarf ein- und
ausschalten könnte. (Anm.: NFS-Root zum [De-]Aktivieren tatsächlich
einen Eintrag in kernel_args, allerdings ohne API. Zusätzlich wird der
zu mountende NFS-Pfad in einer anderen Bootloader-Variablen Namens
``nfsroot`` abgelegt, die der Linux-Kernel sowieso kennt und die wir
quasi missbrauchen.)

**Debugging/Logging:** Bei Bedarf zuschaltebare Funktionen, um
Dateizugriffe beim Booten zu protokollieren, um z.B. festzustellen,
welchen Binaries beim Starten *nicht* angerührt werden und die man
deshalb via Downloader-CGI auslagern könnte, um Platz für mehr früher
benötigte DS-Mod-Pakete zu schaffen, oder um das Kernel-Log in eine
Datei zu sichern, bevor der Ringpuffer überläuft und der Anfang verloren
geht, sind Beispiele für weitere sinnvolle Anwendungsbereiche von
``kernel_args``, ob nun mit oder ohne API. Der Entwickler braucht keine
Debug-Version seiner FW zu flashen, um etwas zu probieren, sondern er
baut die notwendigen Dinge fest in seine FW ein, macht den Start aber
abhängig von einem oder mehreren Schaltern (Berücksichtigung in den
Init-Skripten). Sehr bequem!

Weitere Schweinereien überlasse ich Eurer geschätzten Phantasie.

Diskussionen zum Thema bitte unter
`​http://www.ip-phone-forum.de/showthread.php?t=134976 <http://www.ip-phone-forum.de/showthread.php?t=134976>`__,
wo zu Beginn noch die Rede davon ist, die Variable *SerialNumber* zu
verwenden, um Werte dort zu speichern. Allerdings hat sich später
herausgestellt, daß man diese Variable zwar dem Anschein nach ändern
kann, die Änderungen aber einen Neustart der Box nicht überleben. Also
bitte nicht verwirren lassen, "state of the art" ist momentan
``kernel_args``.

`​Alexander Kriegisch
(kriegaex) <http://www.ip-phone-forum.de/member.php?u=117253>`__

-  Tags
-  `überarbeiten </tags/%C3%BCberarbeiten>`__

.. |;-)| image:: ../../../../chrome/wikiextras-icons-16/smiley-wink.png

