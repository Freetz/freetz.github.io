help/howtos/development/adam2
=============================
Howtos: Entwicklung
^^^^^^^^^^^^^^^^^^^

#. `Entpacken und Packen von
   Firmware-Images <repack_fw.html#EntpackenundPackenvonFirmware-Images>`__

   #. `Tools und Syntax <repack_fw.html#ToolsundSyntax>`__
   #. `Vorgehensweise <repack_fw.html#Vorgehensweise>`__
   #. `Verwendung von fwmod im "no
      freetz"-Modus <repack_fw.html#Verwendungvonfwmodimnofreetz-Modus>`__

#. `Patches in Freetz
   einspielen <integrate_patches.html#PatchesinFreetzeinspielen>`__
#. `Example 3:
   NZBGet <developer_information/package_development_start/example_3.html#Example3:NZBGet>`__

   #. `Build
      manually <developer_information/package_development_start/example_3.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_3.html#AddpackagetoFreetz>`__
   #. `Create new image with added
      package <developer_information/package_development_start/example_3.html#Createnewimagewithaddedpackage>`__
   #. `Testing <developer_information/package_development_start/example_3.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_3.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. `Example 2:
   par2cmdline <developer_information/package_development_start/example_2.html#Example2:par2cmdline>`__

   #. `Build
      manually <developer_information/package_development_start/example_2.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_2.html#AddpackagetoFreetz>`__
   #. `Create new image with added
      package <developer_information/package_development_start/example_2.html#Createnewimagewithaddedpackage>`__
   #. `Testing <developer_information/package_development_start/example_2.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_2.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. `Example 1:
   Httptunnel <developer_information/package_development_start/example_1.html#Example1:Httptunnel>`__

   #. `Build
      manually <developer_information/package_development_start/example_1.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_1.html#AddpackagetoFreetz>`__
   #. `Call Procedures "make menuconfig" and
      "make" <developer_information/package_development_start/example_1.html#CallProceduresmakemenuconfigandmake>`__
   #. `Testing <developer_information/package_development_start/example_1.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_1.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. 

   #. `Signieren von Firmware <sign_image.html#SignierenvonFirmware>`__
   #. `Konkrete Anwendung in
      Freetz <sign_image.html#KonkreteAnwendunginFreetz>`__

#. `Ablauf eines
   Firmware-Updates <firmware_update_details.html#AblaufeinesFirmware-Updates>`__
#. `Eigene Programme
   kompilieren <compile_own_progs.html#EigeneProgrammekompilieren>`__
#. `Dynamische Bandbreitenanzeige per
   SVG <bandwidth_svg.html#DynamischeBandbreitenanzeigeperSVG>`__

   #. `Anleitung zur
      Test-Installation <bandwidth_svg.html#AnleitungzurTest-Installation>`__

#. `Platz sparen im Dateisystem der
   FritzBox <make_room.html#PlatzsparenimDateisystemderFritzBox>`__

   #. `Vorwort und Motivation <make_room.html#VorwortundMotivation>`__
   #. `Bestandsaufnahme: Wo stecken die
      Platzfresser? <make_room.html#Bestandsaufnahme:WosteckendiePlatzfresser>`__
   #. `Weitere Spartricks <make_room.html#WeitereSpartricks>`__
   #. `Schlußwort <make_room.html#Schlußwort>`__

#. `Flash-Partitionen im laufenden Betrieb
   sichern <save_mtd_1.html#Flash-PartitionenimlaufendenBetriebsichern>`__

   #. `Motivation <save_mtd_1.html#Motivation>`__
   #. `Voraussetzungen <save_mtd_1.html#Voraussetzungen>`__
   #. `Lösungsweg <save_mtd_1.html#Lösungsweg>`__
   #. `Wege, sich schnell einen Überblick zu
      verschaffen <save_mtd_1.html#WegesichschnelleinenÜberblickzuverschaffen>`__
   #. `Zusammenfassung <save_mtd_1.html#Zusammenfassung>`__

#. `Release Management <release_management.html#ReleaseManagement>`__

   #. `Subversion
      Repository <release_management.html#SubversionRepository>`__
   #. `Checklists <release_management.html#Checklists>`__
   #. `GIT <release_management.html#GIT>`__
   #. `Downloads <release_management.html#Downloads>`__
   #. `References <release_management.html#References>`__

#. `First steps - How to start your first freetz
   package <developer_information/package_development_start.html#Firststeps-Howtostartyourfirstfreetzpackage>`__

   #. `Info <developer_information/package_development_start.html#Info>`__
   #. `Build
      Environment <developer_information/package_development_start.html#BuildEnvironment>`__
   #. `File
      Structure <developer_information/package_development_start.html#FileStructure>`__
   #. `Examples Binary
      Package <developer_information/package_development_start.html#ExamplesBinaryPackage>`__
   #. `Configuration
      Handling <developer_information/package_development_start.html#ConfigurationHandling>`__
   #. `Examples
      Web-Interface <developer_information/package_development_start.html#ExamplesWeb-Interface>`__
   #. `Trouble
      shooting <developer_information/package_development_start.html#Troubleshooting>`__

#. `Kernel konfigurieren und
   kompilieren <make_kernel.html#Kernelkonfigurierenundkompilieren>`__
#. `Menükonfiguration
   pflegen <menuconfig.html#Menükonfigurationpflegen>`__

   #. `Einstieg <menuconfig.html#Einstieg>`__
   #. `Beispiel-Konfiguration für ein neues
      Paket <menuconfig.html#Beispiel-KonfigurationfüreinneuesPaket>`__
   #. `Menuconfig-Warnungen
      beheben <menuconfig.html#Menuconfig-Warnungenbeheben>`__
   #. `Erklärung und Anwendung der erweiterten
      MK-Targets <menuconfig.html#ErklärungundAnwendungdererweitertenMK-Targets>`__
   #. `Syntax-Fehler in MK-Dateien
      finden <menuconfig.html#Syntax-FehlerinMK-Dateienfinden>`__
   #. `Syntax-Hervorhebung für
      MK-Dateien <menuconfig.html#Syntax-HervorhebungfürMK-Dateien>`__

#. `ADAM2-Bootloader <adam2.html#ADAM2-Bootloader>`__

   #. `Bootloader-Backup
      anlegen <adam2.html#Bootloader-Backupanlegen>`__
   #. `Bootloader überschreiben <adam2.html#Bootloaderüberschreiben>`__
   #. `Bootloader-Befehle <adam2.html#Bootloader-Befehle>`__
   #. `Bootloader-Quelltext <adam2.html#Bootloader-Quelltext>`__
   #. `Aufbau des Bootloaders <adam2.html#AufbaudesBootloaders>`__
   #. `Bootloader und Freetz <adam2.html#BootloaderundFreetz>`__

#. `Einstellungen speichern im
   Urlader-Environment <urlader_flags.html#EinstellungenspeichernimUrlader-Environment>`__

   #. `Vorwort und
      Motivation <urlader_flags.html#VorwortundMotivation>`__
   #. `Lösungsmöglichkeiten <urlader_flags.html#Lösungsmöglichkeiten>`__
   #. `Bootloader
      Environment <urlader_flags.html#BootloaderEnvironment>`__
   #. `Variable
      "kernel_args" <urlader_flags.html#Variablekernel_args>`__
   #. `Kernel_Args-API <urlader_flags.html#Kernel_Args-API>`__
   #. `Mögliche
      Anwendungsfälle <urlader_flags.html#MöglicheAnwendungsfälle>`__

#. `Busybox konfigurieren und
   kompilieren <make_busybox.html#Busyboxkonfigurierenundkompilieren>`__
#. `Wie baue ich ein eigenes Paket für
   Freetz? <package_creation.html#WiebaueicheineigenesPaketfürFreetz>`__
#. `Firmware-Image-Namen analysieren und
   interpretieren <analyse_image_names.html#Firmware-Image-Namenanalysierenundinterpretieren>`__

   #. `Einleitung <analyse_image_names.html#Einleitung>`__
   #. `Skript-Code <analyse_image_names.html#Skript-Code>`__
   #. `Daten im Rohformat <analyse_image_names.html#DatenimRohformat>`__
   #. `Ausgabe grundlegender
      Informationen <analyse_image_names.html#AusgabegrundlegenderInformationen>`__
   #. `Ausgabe erweiterter
      Informationen <analyse_image_names.html#AusgabeerweiterterInformationen>`__

#. 

   #. `Web-interface
      HTTPTunnel <developer_information/package_development_start/webinterface_example_1.html#Web-interfaceHTTPTunnel>`__

#. `Developer
   Information <developer_information.html#DeveloperInformation>`__
#. `Addon Paket
   installieren <install_addon.html#AddonPaketinstallieren>`__
#. `Paketverwaltung für
   Freetz <developer_information/package_development_dynamic.html#PaketverwaltungfürFreetz>`__

   #. `Erweiterung des
      Dateisystems <developer_information/package_development_dynamic.html#ErweiterungdesDateisystems>`__
   #. `Paketverwaltung <developer_information/package_development_dynamic.html#Paketverwaltung>`__
   #. `Links <developer_information/package_development_dynamic.html#Links>`__
   #. `Kommentare <developer_information/package_development_dynamic.html#Kommentare>`__

#. `Wie die FritzBox Manipulationen
   erkennt <manipulation_detection.html#WiedieFritzBoxManipulationenerkennt>`__

   #. `Ursachen <manipulation_detection.html#Ursachen>`__
   #. `Diagnose <manipulation_detection.html#Diagnose>`__
   #. `Lösungen <manipulation_detection.html#Lösungen>`__
   #. `Schlußwort und
      Ausblick <manipulation_detection.html#SchlußwortundAusblick>`__

#. `Shell Coding
   Conventions <developer_information/shell_coding_conventions.html#ShellCodingConventions>`__

   #. `Shell
      Language <developer_information/shell_coding_conventions.html#ShellLanguage>`__
   #. `Basic
      Format <developer_information/shell_coding_conventions.html#BasicFormat>`__
   #. `If, For, and
      While <developer_information/shell_coding_conventions.html#IfForandWhile>`__
   #. `Test
      Built-in <developer_information/shell_coding_conventions.html#TestBuilt-in>`__
   #. `Single-line conditional
      statements <developer_information/shell_coding_conventions.html#Single-lineconditionalstatements>`__
   #. `Infinite
      Loops <developer_information/shell_coding_conventions.html#InfiniteLoops>`__
   #. `Exit Status and If/While
      Statements <developer_information/shell_coding_conventions.html#ExitStatusandIfWhileStatements>`__
   #. `Variable
      References <developer_information/shell_coding_conventions.html#VariableReferences>`__
   #. `Variable
      Naming <developer_information/shell_coding_conventions.html#VariableNaming>`__
   #. `Quoting <developer_information/shell_coding_conventions.html#Quoting>`__
   #. `Variable
      Assignments <developer_information/shell_coding_conventions.html#VariableAssignments>`__
   #. `Testing for (Non-)Empty
      Strings <developer_information/shell_coding_conventions.html#TestingforNon-EmptyStrings>`__
   #. `Commenting <developer_information/shell_coding_conventions.html#Commenting>`__
   #. `Pathnames <developer_information/shell_coding_conventions.html#Pathnames>`__
   #. `Interpreter
      Magic <developer_information/shell_coding_conventions.html#InterpreterMagic>`__

#. `Package
   Development <developer_information/package_development.html#PackageDevelopment>`__

   #. `Persistent Package
      Settings <developer_information/package_development.html#PersistentPackageSettings>`__

#. `Erstellen einer GUI für Pakete in
   Freetz <create_gui.html#ErstelleneinerGUIfürPaketeinFreetz>`__

   #. `Motivation <create_gui.html#Motivation>`__
   #. `Grundlagen <create_gui.html#Grundlagen>`__
   #. `Wie funktioniert das mit der
      GUI? <create_gui.html#WiefunktioniertdasmitderGUI>`__

#. `Flash Partitionierung <flash.html#FlashPartitionierung>`__

   #. `Hidden SquashFS <flash.html#HiddenSquashFS>`__
   #. `Contiguous SquashFS <flash.html#ContiguousSquashFS>`__
   #. `Hidden Root <flash.html#HiddenRoot>`__
   #. `NAND Root <flash.html#NANDRoot>`__
   #. `Dateisystem <flash.html#Dateisystem>`__
   #. `Kernel <flash.html#Kernel>`__
   #. `Weblinks <flash.html#Weblinks>`__

#. `Trac
   Hooks <developer_information/post_commit_hook.html#TracHooks>`__

   #. `trac-post-commit-hook <developer_information/post_commit_hook.html#trac-post-commit-hook>`__
   #. `trac-post-revprop-change-hook <developer_information/post_commit_hook.html#trac-post-revprop-change-hook>`__

#. `Package Developing - Advanced
   Topics <developer_information/package_development_advanced.html#PackageDeveloping-AdvancedTopics>`__

   #. `Adding conditional
      patches <developer_information/package_development_advanced.html#Addingconditionalpatches>`__
   #. `Adding multi-binary
      packages <developer_information/package_development_advanced.html#Addingmulti-binarypackages>`__

#. `Eigene Dateien in die Firmware
   integrieren <integrate_own_files.html#EigeneDateienindieFirmwareintegrieren>`__

   #. `Feste Integration über das Freetz
      Image <integrate_own_files.html#FesteIntegrationüberdasFreetzImage>`__
   #. `Erzeugen der Dateien aus der
      debug.cfg <integrate_own_files.html#ErzeugenderDateienausderdebug.cfg>`__
   #. `Nachladen vom
      Webserver <integrate_own_files.html#NachladenvomWebserver>`__
   #. `Nachladen vom
      USB-Stick <integrate_own_files.html#NachladenvomUSB-Stick>`__
   #. `WebDAV Share
      mounten <integrate_own_files.html#WebDAVSharemounten>`__
   #. `NFS-Share mounten <integrate_own_files.html#NFS-Sharemounten>`__

#. `Freetz Build-Prozeß <freetz_make.html#FreetzBuild-Prozeß>`__

   #. `Vorwort und Motivation <freetz_make.html#VorwortundMotivation>`__
   #. `Grundsätzliches <freetz_make.html#Grundsätzliches>`__

#. `Flash-Partitionen von außen mit FTP
   sichern <save_mtd_2.html#Flash-PartitionenvonaußenmitFTPsichern>`__

   #. `Motivation <save_mtd_2.html#Motivation>`__
   #. `Voraussetzungen <save_mtd_2.html#Voraussetzungen>`__
   #. `Allgemeine Informationen zur
      Datensicherung <save_mtd_2.html#AllgemeineInformationenzurDatensicherung>`__
   #. `Sicherung mit Linux-Standard-FTP
      (ftp) <save_mtd_2.html#SicherungmitLinux-Standard-FTPftp>`__
   #. `Sicherung mit Linux-NcFTP
      (ncftpget) <save_mtd_2.html#SicherungmitLinux-NcFTPncftpget>`__
   #. `Sicherung mit Cygwin-NcFTP
      (ncftpget) <save_mtd_2.html#SicherungmitCygwin-NcFTPncftpget>`__
   #. `Uploads via FTP <save_mtd_2.html#UploadsviaFTP>`__

#. `libmodcgi.sh <developer_information/webif/libmodcgi.html#libmodcgi.sh>`__

   #. `cgi <developer_information/webif/libmodcgi.html#cgi>`__
   #. `cgi_begin <developer_information/webif/libmodcgi.html#cgi_begin>`__
   #. `cgi_end <developer_information/webif/libmodcgi.html#cgi_end>`__
   #. `sec_begin <developer_information/webif/libmodcgi.html#sec_begin>`__
   #. `sec_end <developer_information/webif/libmodcgi.html#sec_end>`__
   #. `html <developer_information/webif/libmodcgi.html#html>`__
   #. `check,
      select <developer_information/webif/libmodcgi.html#checkselect>`__
   #. `href <developer_information/webif/libmodcgi.html#href>`__
   #. `back_button <developer_information/webif/libmodcgi.html#back_button>`__
   #. `sec_level <developer_information/webif/libmodcgi.html#sec_level>`__
   #. `stat_bar <developer_information/webif/libmodcgi.html#stat_bar>`__
   #. `cgi_param <developer_information/webif/libmodcgi.html#cgi_param>`__
   #. `cgi_error,
      print_error <developer_information/webif/libmodcgi.html#cgi_errorprint_error>`__
   #. `path_info <developer_information/webif/libmodcgi.html#path_info>`__
   #. `valid <developer_information/webif/libmodcgi.html#valid>`__

#. `Cross-Compiler / Toolchain
   erstellen <create_cross-compiler_toolchain.html#Cross-CompilerToolchainerstellen>`__
#. `Eigene Download-Toolchain
   erstellen <create_cross-compiler_toolchain.html#EigeneDownload-Toolchainerstellen>`__
#. `Target/Native-Compiler-Toolchain
   erstellen <create_cross-compiler_toolchain.html#TargetNative-Compiler-Toolchainerstellen>`__

   #. `Using the dev-tools package to install compiler and
      tools <create_cross-compiler_toolchain.html#Usingthedev-toolspackagetoinstallcompilerandtools>`__

.. _ADAM2-Bootloader:

ADAM2-Bootloader
================

ADAM2 ist ein Bootloader von Texas Intruments, der ähnliche Aufgaben
übernimmt wie ein BIOS beim PC. ADAM2 wurde in abgewandelter Form von
AVM in frühen FRITZBox-Modellen mit Kernel 2.4 eingesetzt, und wich noch
vor Einführung des Kernels 2.6 der aus Nutzersicht nahezu
funktionsgleichen Eigenentwicklung EVA. Wegen der vielen Parallelen
können beide Varianten als "der Bootloader" betrachtet werden, und
müssen nur in Einzelfällen unterschieden werden.

Die Aufgaben des Bootloaders sind:

-  die Hardware zu initialisieren
-  das Flash zu erkennen
-  das RAM zu erkennen und zu prüfen
-  die Partitionierung und grundlegende Werkseinstellungen zu verwalten
-  eine Serielle Konsole bereitzustellen
-  einen kleinen FTP-Server bereitzustellen (für Recovery)
-  das Environment im TFFS zu verwalten
-  das installierte Kernel zu booten

.. _Bootloader-Backupanlegen:

Bootloader-Backup anlegen
-------------------------

Wer will kann sich ein Bootloader-Backup anlegen sollte sich aber
dringend merken von \*genau welcher\* Box das war (MAC-Adresse). Mehr
dazu um nächsten Abschnitt.

Die Grösse des Bootloaders wird in der Environment-Variable ``mtd2``
gespeichert, die fest im Bootloader selbst eingestellt ist.

Aus Linux heraus hat diese Partition oft eine von ``2`` abweichende
Nummer die man mit folgendem Befehl ausfindig macht:

.. code:: wiki

   cat /proc/mtd

Eine der dort genannten Partitionen nennt sich ``bootloader`` oder
``urlader``. Mit deren Nummer (hier z.B. ``3``) liesst man dann die
zugehörige ``mtdblock`` Device aus:

.. code:: wiki

   cat /dev/mtdblock3 > bootloader.bin

Siehe auch `Flash-Partitionen im laufenden Betrieb
sichern <save_mtd_1.html>`__.

ADAM2 ist immer 64KB gross, EVA bei älteren Modellen 64KB, bei neueren
Modellen 128KB oder 256KB. Beim IAD 7570 ist die ``mtd2`` Partition zwar
256KB, die oberen 128KB sind jedoch leer (0xFF). Dies könnte auf eine
geplante (aber technisch nicht durchführbare) zweite Instanz des
Bootloaders deuten. Die Grösse des Bootloader sollte unbedingt beim
Entwickeln von Aliens beachtet werden. Ein nicht angepasstes ``install``
Script für 64KB Bootloader zerstört einen 128KB Bootloader ohne
Vorwarnung! Das gilt dann auch für das AVM Webinteface - die Box wird
vorhersagbar zum Brick.

Daher, wer Aliens entwickelt ohne das Environment des Zielgerätes
geprüft und mit dem ``install`` Script verglichen zu haben gefährdet
Geräte. Auch im Trunk sollten daher solche riskanten Experimente nur mit
Aufwand freischaltbar sein (implementiert: neuer nicht per GUI
aktivierbarer "Real Developer" Risiko-Modus).

.. _Bootloaderüberschreiben:

Bootloader überschreiben
------------------------

Kurz: **NEIN!**

Der Bootloader enthält zahlreiche Informationen die eine Box einmalig
machen, bei vielen WLAN-Modellen auch Kalibrierung ohne die das Gerät
nicht mehr das selbe ist.

Eine Übertragung ist daher grober Unfug. Auch wenn man diese Angaben
korrekt anpassen würde gibt es ein noch fataleres Problem:

Selbst gleiche Modelle wurden je nach Verfügbarkeit mit
unterschiedlichen Flash- und RAM-Chips bestückt, besonders bei RAM auch
mit Bausteinen mit erheblich abweichenden Eigenschaften (wie Anzahl der
Banks und Timing etc.). Diese Unterschiede werden durch undokumentierte
Konfiguration im Bootloader gesichert. Bootloader-Updates von AVM
übertragen diese Information.

**Ein Bootloader ist auch zwischen gleichen Modellen nicht gefahrlos
übertragbar!.**

Ohne RAM funktioniert auch ein intakter Bootloader nicht ⇒ Brick.

Um die oben erstellte Sicherung \*auf genau die selbe Box\*
zurückzuspielen \*wäre\* dies der Weg:

.. code:: wiki

   cat bootloader.bin > /dev/mtdblock3

Selbst dann besteht Brickgefahr. Die MTD Treiber blockieren nicht das
OS. Greift ein anderer Prozess währenddessen z.B. über die ADAM2 API auf
das Environment zu hängt sich das System eventuell während des Schreib-
oder Löschvorgangs auf ⇒ Brick.

Grundsätzlich sollte man daher den Bootloader nur mit geeigneter AVM
Firmware schreiben oder wenn man über Werkzeuge zum debricken (EJTAG)
verfügt.

.. _Bootloader-Befehle:

Bootloader-Befehle
------------------

-  Die über die Serielle Konsole nutzbaren Befehle findet man im `​ADAM2
   Shell <http://www.wehavemorefun.de/fritzbox/ADAM2_Shell>`__ Artikel
-  Die per FTP nutzbaren Befehle findet man im
   `​TinyFTP <http://www.wehavemorefun.de/fritzbox/TinyFTP>`__ Artikel

Bei einigen Modellen wurde aus Sicherheitsgründen die ADAM2 Shell
entfernt. Dies betrifft keine im freien Handel befindliches Geräte, nur
Providermodelle wie die FRITZBox Cable.

Per FTP sind nur Modelle mit mindestens einem LAN-Port erreichbar (und
recoverbar). Daher eignen sich Modelle ohne LAN (einige Repeater) nicht
zum Experimentieren oder Freetzen. Grobe Faustregel: Wenn AVM eine
Recovery bereitstellt ist ein Gerät perfekt zum Freetzen geeignet. Dies
gilt nicht automatisch für von kleineren Providern bereitgestellte
Geräte! Diese können sogenannte "Provider Additive" enthalten die einen
Werksreset überstehen. Neuere Recoveries verweigern bei solchen Geräten
ihre Funktion, ältere Recoveries zerstören das Additiv (ohne "vor Ort"
Hilfe des Providers irreparabel). Dies dürfte der Grund sein warum AVM
die `​7570
Recovery <ftp://ftp.avm.de/fritz.box/fritzbox.fon_wlan_7570/x_misc/english/>`__
vom FTP-Server entfernte.

Für AVM Speedports gab es nur werksinterne Recoveries für den
Telekom-Service. Diese wurden leider nie veröffentlicht.

**Achtung: Im Netz kursieren auch defekte Speedport (sp2fr) Recoveries
die jeden Speedport bricken!**

Speedports lassen sich mit geringem Aufwand auch sauber mit Freetz
recovern. Achtung: Howtos, Forenpostings und Windows Tools die MTD3/4
clean empfehlen sind entweder uralt oder ein stümperhafter
Faulheitshack! Details zu den teilweise fatalen Folgen dieser fossilen
Unsitte folgen.

.. _Bootloader-Quelltext:

Bootloader-Quelltext
--------------------

ADAM2 wurde vielen Abnehmern von TI-Chips bereitgestellt und war
eigentlich nie quelloffen. Jeder Hersteller von Geräten modifizierte ihn
dann nach eigenen Bedürfnissen und hielt den Quelltext geschlossen, so
auch AVM. Auch Linksys nutzte eine modifizierte ADAM2 Version, leakte
den Quelltext aber versehentlich in einem wag54g Tarball. Damit änderte
sich nicht der proprietäre Status von ADAM2, er wurde aber zumindest in
der Linksys Variante "Visible Source" und kann
`​hier <http://gpl.back2roots.org/source/WAG54GV2/src/Adam2/>`__
gestöbert werden. Diese Variante ist aber nur sehr beschränkt für die
FRITZBox aussagekräftig.

Der Quelltext der AVM Variante von ADAM2 wurde nie veröffentlicht.
Lediglich die `​ADAM2
API <http://gpl.back2roots.org/source/fritzbox/ALL_4.06/GPL-release_kernel/linux/drivers/adam2/>`__
zum Erreichen des Environments war quelloffen.

Der Nachfolger EVA basiert nicht auf ADAM2 und ist ein kompletter
funktionskompatibler Rewrite. Im Gegensatz zu ADAM2 unterstützt EVA
direkt komprimierte Kernels und wurde bisher auf mindestens 8
Architekturen portiert. ADAM2 kam nur auf AR7-Modellen mit Kernel 2.4
zum Einsatz. Alle von Freetz erzeugte Firmware benötigt Kernel 2.6 und
EVA.

.. _AufbaudesBootloaders:

Aufbau des Bootloaders
----------------------

Am Anfang eines jeden MIPS-Bootloaders befindet sich eine 8-Byte
"Signatur". In Wirklichkeit handelt es sich um Assembler-Code zur
Initialisierung des MIPS-Kerns die MIPS netterweise bittet nicht zu
ändern. Diese Befehlssequenz löscht 2 Hälften eines Debug-Registers
(Watchpoint Exception bei "Berührung" einer Adresse) die im
Normalbetrieb nicht genutzt werden und eignen sich auch wegen der Länge
hervorragend als zuverlässige Signatur. Siehe in diesem
`​Quelltext <http://gpl.back2roots.org/source/WAG54GV2/src/Adam2/src/avreset.S>`__
den Kommentar "First thing: clear watch regs".

Für Litte Endian Modelle (AR7, UR8) assembliert dies zur Hexfolge
``00 90 80 40 00 98 80 40`` die immer am Anfang von ``mtd2`` (also vom
gesamten Flash) zu finden ist. Bei Big Endian Modellen (AR9, AR10, VR9,
Fusiv) entspricht es der 32-bit gespiegelten Hexfolge
``40 80 90 00 40 80 98 00`` und es befinden sich grundsätzlich weitere
Daten davor. Dies ist eine bis zu 1024 Bytes grosse
`​Vektortabelle <https://dev.openwrt.org/browser/trunk/package/uboot-ifxmips/files/cpu/mips/danube/start.S>`__
oder Kalt- und Warmstartvektoren und Code zur Initialisierung der `​hier
ab Zeile
44 <http://code.metager.de/source/xref/denx/u-boot/arch/mips/cpu/mips32/start.S#44>`__
genannten EBU-Einheit. Beim AR9, AR10 und VR9 sind dies 24 Bytes (Offset
0x18), beim Fusiv die vollen 1024 Bytes (Offset 0x400). Diese Bytes
gehören natürlich zum Bootloader, die beiden "Signatur-Befehle"
verschieben sich dadurch lediglich.

Zum Ausmaskieren von ARM Bootloadern sind diese Signaturen nicht
geeignet, da ARM Assembler andere Häufigkeitsverteilungen hat. Ein
zuverlässiger Detektor muss also zuerst ARM Code erkennen. Zum Erkennen
von Puma5 (ARM1176BE) Bootloadern gibt es auch eine zuverlässige
Assemblersequenz aus der Lowlevel-Initialisierung. Siehe in
`​diesem <http://gpl.back2roots.org/source/puma5/netgear/CMD31T_GPL/ti/psp_uboot/src/u-boot-1.2.0/cpu/arm1176/puma5/puma5.h>`__
und
`​diesem <http://gpl.back2roots.org/source/puma5/netgear/CMD31T_GPL/ti/psp_uboot/src/u-boot-1.2.0/board/tnetc550/lowlevel_init.S>`__
Quelltext den Kommentar "Unlock CFG MMR region". Dies assembliert zu
Code der die Hexfolge ``08 61 1A 38 83 E7 0B 13 08 61 1A 3C`` enthält.
Diese Signatur ist leider nicht am Anfang des Bootloaders zu finden. Bei
der 6360 mit EVA 2070 befindet sie sich an Offset 0xF1AC, also noch in
den ersten 64KB von Puma5 EVA. Leider stehen keine Recoveries zum Testen
der Signatur zur Verfügung. Mit Puma5 EVA oder `​U-Boot
Code <http://gpl.back2roots.org/source/puma5/netgear/CMD31T_GPL/ti/psp_uboot/src/u-boot-1.2.0/board/tnetc550/lowlevel_init.o>`__
funktioniert sie einwandfrei.

Ungeachtet des Offsets erkennt man EVA am 32-bit Wert ``0x00000002``
oder ``0x00000003`` im jeweiligen Endian an Offset 0x580. Dies ist die
Version (fast immer 2, bei brandaktuellen Modellen auch 3) der EVA
`​Urlader-Konfig <http://www.wehavemorefun.de/fritzbox/ADAM2#Urlader-Konfig>`__
in der Teile der Grundeinstellungen im Werk eingetragen werden. Da
EVA-Images in Firmware keine Konfiguration enthalten ist der Wert dort
``0xFFFFFFFF``. Auch ADAM2 enthielt Teile dieser Einstellungen, jedoch
einkompiliert ohne festen Offset.

In beiden Bootloadern sind 8 Default-MAC-Adressen ``00:04:0E:FF:FF:01``
- ``00:04:0E:FF:FF:08`` einkompiliert, die Mindestanforderung für eine
Kommunikation, sollte die Urlader-Konfig defekt oder noch nicht
vorhanden sein. Seit Entwicklung des `​VoIP Gateway
5188 <http://www.wehavemorefun.de/fritzbox/5188>`__ findet man in EVA
auch das Environment der zweiten CPU fest einkompiliert, da diese über
kein eigenes Flash und daher auch kein TFFS und Environment verfügt und
über NFSRoot bootet. Environment-Variablen können intern nicht nur per
Name angesprochen werden sondern auch per numerischem Index. Dazu wurde
eine Liste numerisch ansprechbarer Variablen einkompiliert die immer mit
``AutoMDIX`` anfängt. Bei älteren ADAM2 Urladern endet die Liste nach
der letzten Variable (z.B. ``wlan_key``), bei neueren ADAM2 und EVA mit
``zuende``. Diese Tabelle ist quelloffen, da sie auch die Namenstabelle
des TFFS ist, siehe "#if defined(URLADER)" und "_TFFS_Name_Table" in
`​tffs.h <http://gpl.back2roots.org/source/fritzbox/7270_5.05/GPL-release_kernel/linux/include/linux/tffs.h>`__.

In allen Recoveries finden sich Fragmente von mindestens einem
Bootloader. In den Anfängen der FRITZBox wurde identische Firmware für
mehrere Modelle umbenannt, die Bootloader jedes dieser Modelle waren
jedoch noch nicht harmonisiert. Entsprechend findet man in Recoveries
aus dieser Zeit multiple Bootloader-Signaturen, da der modellspezifische
Teil mehrfach enthalten war, die modellübergreifende Teil jedoch nicht.

Grundsätzlich ist die Extraktion eines funktionierenden Bootloaders aus
einer Recovery nicht möglich, da der Bootloader aus in der Recovery
enthaltenen Codefragmenten und auf der Box befindlichen
Werkseinstellungen intelligent zusammengebaut wird. Für die
Modellforschung ist die Auffindbarkeit der Fragmente und deren
Grundeinstellungen jedoch interessant. Von 436 analysierten Recoveries
waren etwa 14% ADAM2-MIPSLE, 50% EVA-MIPSLE und die restlichen 36%
EVA-MIPSBE. Bei allen Proben genügte die Auswertung der letzten 256 KB
des mit 7zip isolierbaren ``.data`` Segments jeder Recovery.exe.

Bei der Umstellung auf Kernel 2.6 mussten einige Modelle auf EVA
umgestellt werden. Daher enthalten einige Firmware-Updates ein
``urlader.image`` und passende Programme zur Aktualisierung. In den
Anfängen gab es auch einige ADAM2-Updates, in denen der Dateiname
Modell- und Versionsinformation wie
``urlader.Fritz_Box_4MB.97.adam2.image`` enthielt. Im Gegensatz zu den
Fragmenten in Recoveries sind diese immer "fixed-size" Bootloader mit
Leerbereichen für zu übertragende Konfiguration.

In ADAM2 ist die Version des Urladers als Integer in der Form
``urlader-version \x00 99 \x00`` einkompiliert, bevor es diese Variable
gab in der Form ``$ProjectRevision: 1.24 $``, auch mit mehrstelliger
Version wie in
`​diesem <http://www.akk.org/~enrik/fbox/OLD/boot-06.01.116.txt>`__
Bootlog. Bei EVA findet man die Version mit bis zu 3 Bytes Abstand vor
oder hinter der Zeichenfolge ``%d.%s`` und es muss 1000 hinzugezählt
werden. Ein zusätzliches ``M`` signalisiert eine modifizierte Variante.
In neueren Recoveries findet man zudem einen ``.eva`` Dateinamen, z.B.
für die 7360v2 mit EVA 2717M den String ``1717M.eva``. In 436
analysierten Recoveries wurden ADAM2 der Versionen 1.20, 1.24, 50 bis 99
und EVA der Versionen 1124 bis 2970 entdeckt (Stand 2014-01). Bei 5 EVA
1190 Recoveries 04.30/31 funktioniert die Versionserkennung nicht, die
Nummer ist dort irgendwo ab Offset 0xF000 relativ zur Signatur zu
finden. Diese müssen per MD5 erkannt werden.

Der älteste in Firmware gefundene Bootloader, ADAM2 Version 1.24, wurde
in der bisher ältesten bekannten Firmware fritz.box_sl.05.01.63.image
vom 30. April 2004 (1 Monat nach Vorstellung der ersten FRITZBox auf der
CeBIT) entdeckt. 4 englische Bootloader der Version 1.20 sind neuer.
Durch getrennte Weiterentwicklung je Modell können ADAM2 Versionen nicht
kalendarisch sortiert werden. Der älteste in Firmware gefundene EVA
Bootloader Version 1124 befindet sich in einer frühen 7170 Recovery.
EVA-Versionen lassen sich auch erst ab etwa 1600 modellübergreifend
kalendarisch sortieren.

Recoveries enthalten zwei weitere leicht zu findende Versionsangaben für
den Programmteil. Über die enthaltenen Firmwarekomponenten sagen sie
nichts aus. Je 2 Beispiele:

-  FW 3.37:
   ``AVM Berlin recover-tool-version:[RECOVER:53][IO_CSP:11] compiled at Feb 18 2005 on 14:24:36``
-  FW 6.01:
   ``AVM Berlin recover-tool-version:[RECOVER:378M][IO_CSP:248] compiled at Aug 23 2013 on 13:52:14``
-  FW 3.37:
   ``[AVM Berlin Wizard Base Project, $ProjectRevision: 1.7 $, $Date: 2005/02/11 10:47:18Z $, kompiliert am Feb 14 2005 um 10:10:13]``
-  FW 6.01:
   ``[AVM Berlin Wizard Base Project, $ProjectRevision: 1.63 $, $Date: 2011/07/04 11:49:20Z $, kompiliert am Jul  8 2013 um 11:45:45]``

Wie man sieht werden die Komponenten GUI (Wizard), Recover- und I/O-Teil
getrennt entwickelt und kompiliert. Eine heutige Recovery besteht also
aus mindestens 6 Projekten. Auf älteren FRITZBox CDs (z.B. 3020)
befindet sich eine recover.exe ohne integrierte Firmware (etwa 100KB)
der noch ein externes Image bereitgestellt werden musste. Das Programm
nennt sich ``ar7recover`` und stammt vom Februar 2004, 1 Monat vor
Vorstellung der ersten FRITZBox. Dies dürfte wohl die älteste
veröffentlichte Recovery-Lösung von AVM sein.

Jede Recovery erkennt eine Box an der Urlader-Variable ``HWRevision``.
Da der Urlader keinen Zugriff auf den vollständigen Namen eines Modells
hat enthält jede Recovery eine Liste aller bis zum Erstellungsdatum
bekannten HWRevisions und deren Modellnamen. Die Liste befindet sich im
mit ``7zip`` isolierbaren ``.rdata`` Segment, bei älteren Recoveries bis
etwa 04.43 ist sie im ``.data`` Segment oder nicht vorhanden (bisher nur
bei einer 03.14). Zweck der Liste ist die menschenlesbare Anzeige des
gefundenen Modells in der GUI, unabhängig davon ob die Recovery passt.

Die Liste ist bis zu 3 KB gross und fängt immer mit dem String
``unknown`` an, gefolgt von nullterminierten Paaren HWR / Boxname, mit
32-bit Padding je String. Der letzte Eintrag ist immer die
``FRITZ!Box SL`` und ihre HWR ``F``. Einige Listen ordnen ``unknown``
die HWR ``K`` zu, bei anderen folgt direkt der erste Modellname. Die
Zuordnungpaare sind leider nicht konsistent. So enthält die Liste auch 2
aufeinanderfolgende Namen oder Nummern, aber auch Firmennamen wie AVM
und Telekom. Sie muss also intelligent interpretiert werden. Obwohl die
HWR-Liste auch in aktuellen Recoveries enhalten ist pflegt AVM sie seit
HWR 190 nicht weiter. Recoveries höherer Werte haben zusätzlich den
Zuordnungseintrag für das unterstützte Modell im ``.data`` Segment, die
HWR gefolgt von mehreren Nullbytes gefolgt vom Namen. Da bei allen
neueren Recoveries das ``.data`` Segment mit der nullterminierten HWR
anfängt kann diese als Suchstring in den letzten 256 KB des Segments
genutzt werden. Ob und wie bei diesen Recoveries Fremdmodelle mit HWR >
190 erkannt werden muss noch geprüft werden.

Bei der Analyse von 419 Recoveries mit obigem Wissen wurde `diese
Häufigkeitsverteilung </attachment/wiki/help/howtos/development/adam2/hwr.txt>`__\ `​ </raw-attachment/wiki/help/howtos/development/adam2/hwr.txt>`__
(tab delimited csv) ermittelt. Um Konsistenzfehler auszumaskieren
enthält die Liste nur Zuordnungen die in mindesten 5 Recoveries gefunden
wurden. Die Zähler für HWR > 190 wurden zuvor mit 10 multipliziert.

Die HWR am Anfang des ``.data`` Segments ist Teil einer Struktur, die in
jeder Recovery mit Kernel 2.6 zu finden ist. Bei neueren Recoveries
findet sie sich an Offset 0, bei älteren an Offset 64 (0x40). Sie
Struktur enthält die unterstützte HWR an Offset 0, die Sprache an Offset
16 (0x10) und die mit Leerzeichen getrennte Liste der unterstützten
Brandings an Offset 32 (0x20). Dies ist sehr nützlich da z.B. EWE
Recoveries nicht am Dateinamen erkennbar sind. Ein vierter String dessen
genauer Zweck noch unklar ist fängt normalerweise an Offset 0x30 an und
verschiebt sich um jeweils 8 Bytes wenn der Brandings-String länger als
8 Bytes ist. Bei Congstar (und vermutlich auch Telekom) Recoveries
enthält er ``tcom``, bei allen anderen enthält er unabhängig von Sprache
und Anbieter immer ``avm``.

In allen Kernel 2.4 Recoveries befindet sich am Ende des ``.data``
Segments eine Reihe von mit einem oder mehreren Nullbytes terminierten
Strings. Dies ist eine 2- oder 3-stellige Zahl unbekannten Zwecks
(leider nicht die HWR) oder der String ``IE``, der optionale String
``en`` oder ``de`` und die Firmwareversion in punktierter Schreibweise
(z.B. ``29.04.01``) mit dem optionalen Zusatz
``-prerelease-<checkpoint>``. Dahinter steht der optionale String
``avm`` oder ``freenet``, gefolgt von der optionalen Liste der
unterstützten Brandings. Lediglich die älteste bekannte Recovery mit
integrierter Firmware (03.14) enthält diese Information nicht. Sie ist
deutsch und kannte noch kein Branding. Die HWR muss bei Kernel 2.4
Recoveries aus dem Urlader ermittelt werden.

Der Vergleich der ermittelten Brandings mit den /etc Defaults bestätigt
die Zuverlässigkeit obiger Methoden, sowohl bei Release- als auch bei
Labor-Recoveries. Es existieren allerdings 2 Labor-Recoveries die einen
falschen Bootloader enthalten. Die Datei
``FRITZ.Box_2110.04.47-9457.recover-image.exe`` enthält einen HWR 130
Bootloader einer nie auf den Markt gekommenen 2121, die Datei
``fritz.box_fon_wlan_7050.04.50.B.telnet.recover-image.exe`` den HWR 94
Bootloader einer 7170.

.. _BootloaderundFreetz:

Bootloader und Freetz
---------------------

Da Freetz EVA benötigt sind einige Modelle schon vom Bootloader her
nicht für Freetz geeignet. Grundsätzlich sollte jede Box vor dem
Freetzen mit Originalfirmware aktualisiert werden. Dies aktualisiert
ggf. auch den Bootloader. Für einige ältere Modelle ist evtl. ein
`​Zwischenupdate <ftp://service.avm.de/Zwischenupdate/>`__ notwendig.

Für folgende Modelle existiert kein EVA Update:

-  FRITZBox (alle Versionen)
-  FRITZBox SL
-  FRITZBox 2030
-  FRITZBox Fon (Deutsch A/CH Annex A+B) - mit Tricks evtl. deutsch oder
   englisch aktualisierbar
-  FRITZBox Fon ata (alle Versionen)
-  FRITZBox Fon WLAN (Deutsch A/CH Annex A+B) - mit Tricks evtl. deutsch
   oder englisch aktualisierbar

Für einige dieser Modelle könnte Freetz ein EVA Update einer anderen Box
Alien patchen. Bei der FRITZBox SL und 2030 mit 2MB Flash und 8MB RAM
wird es wohl nie Freetz geben.

Anhänge (1)
~~~~~~~~~~~

-  `hwr.txt </attachment/wiki/help/howtos/development/adam2/hwr.txt>`__\ `​ </raw-attachment/wiki/help/howtos/development/adam2/hwr.txt>`__
   (4.0 KB) - hinzugefügt von *hippie2000* `vor 4
   Jahren </timeline?from=2014-01-19T21%3A15%3A59Z&precision=second>`__.
   “Komplette HWR-Liste aller 419 bekannten Recoveries, CSV”

Alle Anhänge herunterladen als:
`.zip </zip-attachment/wiki/help/howtos/development/adam2/>`__
