help/howtos/development/flash
=============================
Howtos: Entwicklung
^^^^^^^^^^^^^^^^^^^

#. `Entpacken und Packen von
   Firmware-Images <repack_fw.html#EntpackenundPackenvonFirmware-Images>`__

   #. `Tools und Syntax <repack_fw.html#ToolsundSyntax>`__
   #. `Vorgehensweise <repack_fw.html#Vorgehensweise>`__
   #. `Verwendung von fwmod im "no
      freetz"-Modus <repack_fw.html#Verwendungvonfwmodimnofreetz-Modus>`__

#. `Patches in Freetz
   einspielen <integrate_patches.html#PatchesinFreetzeinspielen>`__
#. `Example 3:
   NZBGet <developer_information/package_development_start/example_3.html#Example3:NZBGet>`__

   #. `Build
      manually <developer_information/package_development_start/example_3.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_3.html#AddpackagetoFreetz>`__
   #. `Create new image with added
      package <developer_information/package_development_start/example_3.html#Createnewimagewithaddedpackage>`__
   #. `Testing <developer_information/package_development_start/example_3.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_3.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. `Example 2:
   par2cmdline <developer_information/package_development_start/example_2.html#Example2:par2cmdline>`__

   #. `Build
      manually <developer_information/package_development_start/example_2.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_2.html#AddpackagetoFreetz>`__
   #. `Create new image with added
      package <developer_information/package_development_start/example_2.html#Createnewimagewithaddedpackage>`__
   #. `Testing <developer_information/package_development_start/example_2.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_2.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. `Example 1:
   Httptunnel <developer_information/package_development_start/example_1.html#Example1:Httptunnel>`__

   #. `Build
      manually <developer_information/package_development_start/example_1.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_1.html#AddpackagetoFreetz>`__
   #. `Call Procedures "make menuconfig" and
      "make" <developer_information/package_development_start/example_1.html#CallProceduresmakemenuconfigandmake>`__
   #. `Testing <developer_information/package_development_start/example_1.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_1.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. 

   #. `Signieren von Firmware <sign_image.html#SignierenvonFirmware>`__
   #. `Konkrete Anwendung in
      Freetz <sign_image.html#KonkreteAnwendunginFreetz>`__

#. `Ablauf eines
   Firmware-Updates <firmware_update_details.html#AblaufeinesFirmware-Updates>`__
#. `Eigene Programme
   kompilieren <compile_own_progs.html#EigeneProgrammekompilieren>`__
#. `Dynamische Bandbreitenanzeige per
   SVG <bandwidth_svg.html#DynamischeBandbreitenanzeigeperSVG>`__

   #. `Anleitung zur
      Test-Installation <bandwidth_svg.html#AnleitungzurTest-Installation>`__

#. `Platz sparen im Dateisystem der
   FritzBox <make_room.html#PlatzsparenimDateisystemderFritzBox>`__

   #. `Vorwort und Motivation <make_room.html#VorwortundMotivation>`__
   #. `Bestandsaufnahme: Wo stecken die
      Platzfresser? <make_room.html#Bestandsaufnahme:WosteckendiePlatzfresser>`__
   #. `Weitere Spartricks <make_room.html#WeitereSpartricks>`__
   #. `Schlußwort <make_room.html#Schlußwort>`__

#. `Flash-Partitionen im laufenden Betrieb
   sichern <save_mtd_1.html#Flash-PartitionenimlaufendenBetriebsichern>`__

   #. `Motivation <save_mtd_1.html#Motivation>`__
   #. `Voraussetzungen <save_mtd_1.html#Voraussetzungen>`__
   #. `Lösungsweg <save_mtd_1.html#Lösungsweg>`__
   #. `Wege, sich schnell einen Überblick zu
      verschaffen <save_mtd_1.html#WegesichschnelleinenÜberblickzuverschaffen>`__
   #. `Zusammenfassung <save_mtd_1.html#Zusammenfassung>`__

#. `Release Management <release_management.html#ReleaseManagement>`__

   #. `Subversion
      Repository <release_management.html#SubversionRepository>`__
   #. `Checklists <release_management.html#Checklists>`__
   #. `GIT <release_management.html#GIT>`__
   #. `Downloads <release_management.html#Downloads>`__
   #. `References <release_management.html#References>`__

#. `First steps - How to start your first freetz
   package <developer_information/package_development_start.html#Firststeps-Howtostartyourfirstfreetzpackage>`__

   #. `Info <developer_information/package_development_start.html#Info>`__
   #. `Build
      Environment <developer_information/package_development_start.html#BuildEnvironment>`__
   #. `File
      Structure <developer_information/package_development_start.html#FileStructure>`__
   #. `Examples Binary
      Package <developer_information/package_development_start.html#ExamplesBinaryPackage>`__
   #. `Configuration
      Handling <developer_information/package_development_start.html#ConfigurationHandling>`__
   #. `Examples
      Web-Interface <developer_information/package_development_start.html#ExamplesWeb-Interface>`__
   #. `Trouble
      shooting <developer_information/package_development_start.html#Troubleshooting>`__

#. `Kernel konfigurieren und
   kompilieren <make_kernel.html#Kernelkonfigurierenundkompilieren>`__
#. `Menükonfiguration
   pflegen <menuconfig.html#Menükonfigurationpflegen>`__

   #. `Einstieg <menuconfig.html#Einstieg>`__
   #. `Beispiel-Konfiguration für ein neues
      Paket <menuconfig.html#Beispiel-KonfigurationfüreinneuesPaket>`__
   #. `Menuconfig-Warnungen
      beheben <menuconfig.html#Menuconfig-Warnungenbeheben>`__
   #. `Erklärung und Anwendung der erweiterten
      MK-Targets <menuconfig.html#ErklärungundAnwendungdererweitertenMK-Targets>`__
   #. `Syntax-Fehler in MK-Dateien
      finden <menuconfig.html#Syntax-FehlerinMK-Dateienfinden>`__
   #. `Syntax-Hervorhebung für
      MK-Dateien <menuconfig.html#Syntax-HervorhebungfürMK-Dateien>`__

#. `ADAM2-Bootloader <adam2.html#ADAM2-Bootloader>`__

   #. `Bootloader-Backup
      anlegen <adam2.html#Bootloader-Backupanlegen>`__
   #. `Bootloader überschreiben <adam2.html#Bootloaderüberschreiben>`__
   #. `Bootloader-Befehle <adam2.html#Bootloader-Befehle>`__
   #. `Bootloader-Quelltext <adam2.html#Bootloader-Quelltext>`__
   #. `Aufbau des Bootloaders <adam2.html#AufbaudesBootloaders>`__
   #. `Bootloader und Freetz <adam2.html#BootloaderundFreetz>`__

#. `Einstellungen speichern im
   Urlader-Environment <urlader_flags.html#EinstellungenspeichernimUrlader-Environment>`__

   #. `Vorwort und
      Motivation <urlader_flags.html#VorwortundMotivation>`__
   #. `Lösungsmöglichkeiten <urlader_flags.html#Lösungsmöglichkeiten>`__
   #. `Bootloader
      Environment <urlader_flags.html#BootloaderEnvironment>`__
   #. `Variable
      "kernel_args" <urlader_flags.html#Variablekernel_args>`__
   #. `Kernel_Args-API <urlader_flags.html#Kernel_Args-API>`__
   #. `Mögliche
      Anwendungsfälle <urlader_flags.html#MöglicheAnwendungsfälle>`__

#. `Busybox konfigurieren und
   kompilieren <make_busybox.html#Busyboxkonfigurierenundkompilieren>`__
#. `Wie baue ich ein eigenes Paket für
   Freetz? <package_creation.html#WiebaueicheineigenesPaketfürFreetz>`__
#. `Firmware-Image-Namen analysieren und
   interpretieren <analyse_image_names.html#Firmware-Image-Namenanalysierenundinterpretieren>`__

   #. `Einleitung <analyse_image_names.html#Einleitung>`__
   #. `Skript-Code <analyse_image_names.html#Skript-Code>`__
   #. `Daten im Rohformat <analyse_image_names.html#DatenimRohformat>`__
   #. `Ausgabe grundlegender
      Informationen <analyse_image_names.html#AusgabegrundlegenderInformationen>`__
   #. `Ausgabe erweiterter
      Informationen <analyse_image_names.html#AusgabeerweiterterInformationen>`__

#. 

   #. `Web-interface
      HTTPTunnel <developer_information/package_development_start/webinterface_example_1.html#Web-interfaceHTTPTunnel>`__

#. `Developer
   Information <developer_information.html#DeveloperInformation>`__
#. `Addon Paket
   installieren <install_addon.html#AddonPaketinstallieren>`__
#. `Paketverwaltung für
   Freetz <developer_information/package_development_dynamic.html#PaketverwaltungfürFreetz>`__

   #. `Erweiterung des
      Dateisystems <developer_information/package_development_dynamic.html#ErweiterungdesDateisystems>`__
   #. `Paketverwaltung <developer_information/package_development_dynamic.html#Paketverwaltung>`__
   #. `Links <developer_information/package_development_dynamic.html#Links>`__
   #. `Kommentare <developer_information/package_development_dynamic.html#Kommentare>`__

#. `Wie die FritzBox Manipulationen
   erkennt <manipulation_detection.html#WiedieFritzBoxManipulationenerkennt>`__

   #. `Ursachen <manipulation_detection.html#Ursachen>`__
   #. `Diagnose <manipulation_detection.html#Diagnose>`__
   #. `Lösungen <manipulation_detection.html#Lösungen>`__
   #. `Schlußwort und
      Ausblick <manipulation_detection.html#SchlußwortundAusblick>`__

#. `Shell Coding
   Conventions <developer_information/shell_coding_conventions.html#ShellCodingConventions>`__

   #. `Shell
      Language <developer_information/shell_coding_conventions.html#ShellLanguage>`__
   #. `Basic
      Format <developer_information/shell_coding_conventions.html#BasicFormat>`__
   #. `If, For, and
      While <developer_information/shell_coding_conventions.html#IfForandWhile>`__
   #. `Test
      Built-in <developer_information/shell_coding_conventions.html#TestBuilt-in>`__
   #. `Single-line conditional
      statements <developer_information/shell_coding_conventions.html#Single-lineconditionalstatements>`__
   #. `Infinite
      Loops <developer_information/shell_coding_conventions.html#InfiniteLoops>`__
   #. `Exit Status and If/While
      Statements <developer_information/shell_coding_conventions.html#ExitStatusandIfWhileStatements>`__
   #. `Variable
      References <developer_information/shell_coding_conventions.html#VariableReferences>`__
   #. `Variable
      Naming <developer_information/shell_coding_conventions.html#VariableNaming>`__
   #. `Quoting <developer_information/shell_coding_conventions.html#Quoting>`__
   #. `Variable
      Assignments <developer_information/shell_coding_conventions.html#VariableAssignments>`__
   #. `Testing for (Non-)Empty
      Strings <developer_information/shell_coding_conventions.html#TestingforNon-EmptyStrings>`__
   #. `Commenting <developer_information/shell_coding_conventions.html#Commenting>`__
   #. `Pathnames <developer_information/shell_coding_conventions.html#Pathnames>`__
   #. `Interpreter
      Magic <developer_information/shell_coding_conventions.html#InterpreterMagic>`__

#. `Package
   Development <developer_information/package_development.html#PackageDevelopment>`__

   #. `Persistent Package
      Settings <developer_information/package_development.html#PersistentPackageSettings>`__

#. `Erstellen einer GUI für Pakete in
   Freetz <create_gui.html#ErstelleneinerGUIfürPaketeinFreetz>`__

   #. `Motivation <create_gui.html#Motivation>`__
   #. `Grundlagen <create_gui.html#Grundlagen>`__
   #. `Wie funktioniert das mit der
      GUI? <create_gui.html#WiefunktioniertdasmitderGUI>`__

#. `Flash Partitionierung <flash.html#FlashPartitionierung>`__

   #. `Hidden SquashFS <flash.html#HiddenSquashFS>`__
   #. `Contiguous SquashFS <flash.html#ContiguousSquashFS>`__
   #. `Hidden Root <flash.html#HiddenRoot>`__
   #. `NAND Root <flash.html#NANDRoot>`__
   #. `Dateisystem <flash.html#Dateisystem>`__
   #. `Kernel <flash.html#Kernel>`__
   #. `Weblinks <flash.html#Weblinks>`__

#. `Trac
   Hooks <developer_information/post_commit_hook.html#TracHooks>`__

   #. `trac-post-commit-hook <developer_information/post_commit_hook.html#trac-post-commit-hook>`__
   #. `trac-post-revprop-change-hook <developer_information/post_commit_hook.html#trac-post-revprop-change-hook>`__

#. `Package Developing - Advanced
   Topics <developer_information/package_development_advanced.html#PackageDeveloping-AdvancedTopics>`__

   #. `Adding conditional
      patches <developer_information/package_development_advanced.html#Addingconditionalpatches>`__
   #. `Adding multi-binary
      packages <developer_information/package_development_advanced.html#Addingmulti-binarypackages>`__

#. `Eigene Dateien in die Firmware
   integrieren <integrate_own_files.html#EigeneDateienindieFirmwareintegrieren>`__

   #. `Feste Integration über das Freetz
      Image <integrate_own_files.html#FesteIntegrationüberdasFreetzImage>`__
   #. `Erzeugen der Dateien aus der
      debug.cfg <integrate_own_files.html#ErzeugenderDateienausderdebug.cfg>`__
   #. `Nachladen vom
      Webserver <integrate_own_files.html#NachladenvomWebserver>`__
   #. `Nachladen vom
      USB-Stick <integrate_own_files.html#NachladenvomUSB-Stick>`__
   #. `WebDAV Share
      mounten <integrate_own_files.html#WebDAVSharemounten>`__
   #. `NFS-Share mounten <integrate_own_files.html#NFS-Sharemounten>`__

#. `Freetz Build-Prozeß <freetz_make.html#FreetzBuild-Prozeß>`__

   #. `Vorwort und Motivation <freetz_make.html#VorwortundMotivation>`__
   #. `Grundsätzliches <freetz_make.html#Grundsätzliches>`__

#. `Flash-Partitionen von außen mit FTP
   sichern <save_mtd_2.html#Flash-PartitionenvonaußenmitFTPsichern>`__

   #. `Motivation <save_mtd_2.html#Motivation>`__
   #. `Voraussetzungen <save_mtd_2.html#Voraussetzungen>`__
   #. `Allgemeine Informationen zur
      Datensicherung <save_mtd_2.html#AllgemeineInformationenzurDatensicherung>`__
   #. `Sicherung mit Linux-Standard-FTP
      (ftp) <save_mtd_2.html#SicherungmitLinux-Standard-FTPftp>`__
   #. `Sicherung mit Linux-NcFTP
      (ncftpget) <save_mtd_2.html#SicherungmitLinux-NcFTPncftpget>`__
   #. `Sicherung mit Cygwin-NcFTP
      (ncftpget) <save_mtd_2.html#SicherungmitCygwin-NcFTPncftpget>`__
   #. `Uploads via FTP <save_mtd_2.html#UploadsviaFTP>`__

#. `libmodcgi.sh <developer_information/webif/libmodcgi.html#libmodcgi.sh>`__

   #. `cgi <developer_information/webif/libmodcgi.html#cgi>`__
   #. `cgi_begin <developer_information/webif/libmodcgi.html#cgi_begin>`__
   #. `cgi_end <developer_information/webif/libmodcgi.html#cgi_end>`__
   #. `sec_begin <developer_information/webif/libmodcgi.html#sec_begin>`__
   #. `sec_end <developer_information/webif/libmodcgi.html#sec_end>`__
   #. `html <developer_information/webif/libmodcgi.html#html>`__
   #. `check,
      select <developer_information/webif/libmodcgi.html#checkselect>`__
   #. `href <developer_information/webif/libmodcgi.html#href>`__
   #. `back_button <developer_information/webif/libmodcgi.html#back_button>`__
   #. `sec_level <developer_information/webif/libmodcgi.html#sec_level>`__
   #. `stat_bar <developer_information/webif/libmodcgi.html#stat_bar>`__
   #. `cgi_param <developer_information/webif/libmodcgi.html#cgi_param>`__
   #. `cgi_error,
      print_error <developer_information/webif/libmodcgi.html#cgi_errorprint_error>`__
   #. `path_info <developer_information/webif/libmodcgi.html#path_info>`__
   #. `valid <developer_information/webif/libmodcgi.html#valid>`__

#. `Cross-Compiler / Toolchain
   erstellen <create_cross-compiler_toolchain.html#Cross-CompilerToolchainerstellen>`__
#. `Eigene Download-Toolchain
   erstellen <create_cross-compiler_toolchain.html#EigeneDownload-Toolchainerstellen>`__
#. `Target/Native-Compiler-Toolchain
   erstellen <create_cross-compiler_toolchain.html#TargetNative-Compiler-Toolchainerstellen>`__

   #. `Using the dev-tools package to install compiler and
      tools <create_cross-compiler_toolchain.html#Usingthedev-toolspackagetoinstallcompilerandtools>`__

.. _FlashPartitionierung:

Flash Partitionierung
=====================

Im Flash der Fritzbox befinden sich bei jedem Modell folgende
funktionale Einheiten:

-  Bootloader: `ADAM2 <adam2.html>`__ / EVA (+ Werkseinstellungen)
-  Kernel: Linux 2.4.17_mvl21-malta-mips_fp_le, 2.6.13.1-ar7/ohio oder
   höher *(gzip oder lzma komprimiert)*
-  Dateisystem: `​SquashFS <http://de.wikipedia.org/wiki/Squashfs>`__
   *(gzip oder lzma)* oder
   `​YAFFS2 <http://de.wikipedia.org/wiki/YAFFS2>`__
-  Konfigurations-Dateien + Environment: TFFS

Bei der Flash Einteilung der Fritzboxen entstanden über die Jahre einige
"Geschmacksrichtungen". Das Grundkonzept entspringt TI und deren ADAM2
Bootloader, der die Partitionstabellen verwaltet. Unabhängig von der
Reihenfolge im Speicher wurde festgelegt dass ``mtd0`` das root
Dateisystem enthalten soll, ``mtd1`` das Kernel, ``mtd2`` ADAM2 selbst
und ``mtd3`` die Konfiguration. Letztere muss häufig geschrieben werden
und trotzdem fehlerfrei sein und nutzt dabei das Flash ab. Um dies
sicherer zu gestalten entwickelte AVM das TFFS, das durch doppelte
"Pufferung" zwei gleich grosse Partitionen ``mtd3`` und ``mtd4``
benötigt.

ADAM2 bzw später AVM's funktionsgleicher Ersatz EVA wird ab Werk
installiert und wurde nur in eher seltenen Sonderfällen aktualisiert.
Ein Firmware Update aktualisiert dagegen immer Kernel und root
Dateisystem, beim ursprünglichen Konzept mit den enthaltenen Dateien
``filesystem.image`` für ``mtd0`` und ``kernel.image`` für ``mtd1``.

Uber die Jahre stellte sich heraus dass der Platzbedarf für Kernel und
Dateisystem kaum dauerhaft vorhersagbar ist und dass die Partitionierung
gar eine Hürde wurde da beide Komponenten verschieden stark wuchsen. Es
entstanden einige trickreiche Abwandelungen die diese Barriere
aushebelten. Ab Kernel 2.6 verzichtete man dann ganz auf die Trennung um
die Problematik zu umgehen. Bei neuen Modellen mit im Vergleich fast
unbegrenztem NAND-Flash führte man die Trennung wieder ein.

**Achtung:** Alle in diesem Artikel genannten mtd Nummern beziehen sich
auf die im Environment gespeicherten Partitionstabellen. Die Nummern der
im Linux erreichbaren mtd Devices werden vom Kernel vergeben und weichen
oft von den ADAM2/EVA Numerierung ab!

Um aus dem Linux heraus auf das Environment zugreifen zu können gibt es
die ADAM2 API, die je nach Kernel Version an verschiedenen Stellen in
/proc erreichbar ist.

Um die Environment mtd Tabelle unter Kernel 2.4 zu lesen kann

.. code:: wiki

   cat /proc/sys/dev/adam2/environment | grep mtd

abgerufen werden. Ab Kernel 2.6 muss es so aussehen:

.. code:: wiki

   cat /proc/sys/urlader/environment | grep mtd

Die Liste aller Linux mtd Devices erhält man mit:

.. code:: wiki

   cat /proc/mtd

Da die Linux Partitionen von den MTD Treibern im Kernel ermittelt werden
weichen Nummerierung und Größen teilweise erheblich von der
Partitionierung im Environment ab.

Im Folgenden werden alle verwendeten Partitionsschemata einzeln
beleuchtet.

.. _HiddenSquashFS:

Hidden SquashFS
---------------

.. figure:: /screenshots/55.png
   :alt: Flash Legende

   Flash Legende

Folgende Firmware verwendet Hidden SquashFS im NOR-Flash mit Kernel 2.4:

-  2 MB Flash

   -  Fritzbox SL (03.48 bis 03.73)
   -  Fritzbox 2030 (03.73 bis 03.80)

-  4 MB Flash

   -  Eumex 300 IP (alte)
   -  Fritzbox (03.29 bis 4.02, auch int)
   -  Fritzbox SL WLAN (03.65 bis 04.15)
   -  Fritzbox WLAN 3030 (03.65 bis 04.15)
   -  Fritzbox WLAN 3050 (03.63 bis 04.07)
   -  Fritzbox Fon (03.37 bis 04.27, auch int)
   -  Fritzbox Fon 5050 (03.69 bis 04.26)
   -  Fritzbox Fon ATA (03.64 bis 04.28-Beta, auch int)
   -  Fritzbox Fon WLAN (03.42 bis 04.27, auch int)
   -  Fritzbox Fon WLAN 7050 (03.58 bis 4.01)

Das Hidden SquashFS beginnt direkt hinter dem Kernel (256 Byte Padding)
und enthält vor allem Treiber. Es wird während des Bootvorgangs im
Startskript ``rc.S`` gemounted. Der Kernel und das Hidden SquashFS
befinden sich in ``kernel.image``, das root Dateisystem in
``filesystem.image``. Diese Technik wurde verwendet um proprietäre
Binär-Module von TI vom root Dateisystem zu separieren. Das Hidden
SquashFS enthält Dateien wie ``avalanche_cpmac.o``, ``avalanche_usb.o``,
``tiatm.o`` ohne jegliche Unterverzeichnisse und wird nach
``/lib/modules/2.4.17_mvl21-malta-mips_fp_le/kernel/hidden`` gemountet.

.. figure:: /screenshots/56.png
   :alt: Flash Hidden Squashfs

   Flash Hidden Squashfs

.. _ContiguousSquashFS:

Contiguous SquashFS
-------------------

.. figure:: /screenshots/55.png
   :alt: Flash Legende

   Flash Legende

Folgende Firmware verwendet Contiguous SquashFS im NOR-Flash mit Kernel
2.4:

-  2 MB Flash

   -  Fritzbox SL (03.92 bis 03.94)
   -  Fritzbox 2030 (03.92 bis 03.93)

-  4 MB Flash

   -  Fritzbox Fon WLAN 7050 (04.03-Beta bis 04.26, auch int)

Beim Contiguous SquashFS fängt das root Dateisystem direkt nach dem
Kernel an (256 Byte Padding). Da das root Dateisystem nun über ``mtd0``
und ``mtd1`` verteilt liegt, muss es im Firmware Update auch
dementsprechend auf die Dateien ``kernel.image`` (Kernel + Anfang des
root Dateisystems) und ``filesystem.image`` (Rest des root Dateisystems)
aufgeteilt werden. Diese Technik wurde verwendet um ohne
Umpartitionierung Platz für das wachsende root Dateisystem aus der
Kernel Partition zu borgen.

.. figure:: /screenshots/57.png
   :alt: Flash Contiguous

   Flash Contiguous

.. _HiddenRoot:

Hidden Root
-----------

.. figure:: /screenshots/55.png
   :alt: Flash Legende

   Flash Legende

Folgende Firmware verwendet Hidden Root im NOR- oder Serial-Flash mit
Kernel 2.6:

-  alle Firmware ab Kernel 2.6.13.1 die kein NAND Root nutzt

Bei Hidden Root befindet sich das root Dateisystem — ähnlich wie bei
`Contiguous SquashFS <flash.html#ContiguousSquashFS>`__ — direkt hinter
dem Kernel (256 Byte Padding). Diese Boxen kann man daran erkennen, dass
die Start- und End-Adresse von ``mtd0`` in der mtd Tabelle gleich 0 und
die Datei ``filesystem.image`` im Firmware Update leer ist.
``kernel.image`` enthält sowohl den Kernel als auch das root
Dateisystem. Diese Technik wurde verwendet um ohne Behinderung durch
Partitionsgrenzen den vorhandenen Platz dynamisch zwischen Kernel und
root Dateisystem aufzuteilen.

.. figure:: /screenshots/58.png
   :alt: Flash Hidden Root

   Flash Hidden Root

.. _NANDRoot:

NAND Root
---------

.. figure:: /screenshots/55.png
   :alt: Flash Legende

   Flash Legende

Folgende Modelle verwenden NAND Root mit Kernel 2.6:

-  Fritzbox 3272
-  Fritzbox 3370
-  Fritzbox 3390
-  Fritzbox 6840 LTE
-  Fritzbox 7272
-  Fritzbox 7362 SL
-  Fritzbox 7490

Alle bisher genannten Partitionsschemata basieren auf parallelem oder
seriellem NOR-Flash mit vorhersagbarem Speicherplatz.
`​NAND-Flash <https://de.wikipedia.org/wiki/NAND-Flash>`__ kann dagegen
bereits ab Werk Fehler aufweisen und daher nur mit
Fehlererkennungsmechanismen zuverlässig genutzt werden. Dies erfordert
spezielle Controller oder Dateisysteme die Listen defekter Blöcke
verwalten. Der Speicherplatz ist also nicht mehr zwingend durchgehend
nutzbar und kann nicht mehr ohne Intelligenz geschrieben werden ohne die
Liste defekter Blöcke zu zerstören (was sehr dumm wäre).

Bei Modellen die NAND nur als Datenspeicher für den NAS nutzen (z.B. die
7390) ist das kein Problem. Dieser Speicher wird nur intelligent aus
Linux heraus angesprochen und enthält normalerweise keine Systemteile.
Alle Partitionen die über den Bootloader recovered werden liegen im
NOR-Flash.

Modelle bei denen auch das System im NAND-Flash liegt haben nur noch ein
kleines serielles NOR-Flash für den Bootloader ``mtd2`` und zwei TFFS
Partitionen ``mtd3`` und ``mtd4``. Alle weiteren Partitionen befinden
sich im NAND-Flash. Da es bei NAND keinen Platzmangel gibt wurden je 2
Partitionen für Kernel und Dateisystem vorhesehen. Dies hat den Vorteil
aus dem kaufenden System heraus aktualisieren zu können (hot flashable).
Dabei werden die beiden jeweils nicht in Betrieb befindlichen
Partitionen geschrieben, als aktiv markiert, und das System
neugestartet. Beim nächsten Update wechselt der Vorgang wieder die
aktiven Partitionen. Das Kernel befindet sich auf ``mtd1``, das
Dateisystem wieder getrennt auf ``mtd0``. Welche beiden Partitionen
damit gemeint sind definiert die EVA Variable ``linux_fs_start``.

.. figure:: /screenshots/277.png
   :alt: 

Um unabhängig vom verwendeten Dateisystem die Vorteile des effizient
komprimierbaren SquashFS weiter nutzen zu können entschied sich AVM für
ein interessantes Konzept. Auf die Filesystem-Partition wird ein
minimales Wrapper-System installiert, das nur aus 190 inodes und dem
eigentlichen System ``filesystem_core.squashfs`` besteht. Letzteres wird
als Loop-Device als / gemountet. Dies benötigt natürlich mehr
RAM-Speicher, hat aber zusätzlich den Vorteil schneller zu sein und das
NAND-Flash erheblich weniger zu beanspruchen.

Die beiden (sehr spartanischen) TFFS Partitionen im NOR-Flash dienen nur
der Werkseinrichtung, EVA und der Recovery. Im Betrieb wird eine neue
Config-Partition im NAND-Flash verwendet, die YAFFS2 zur Speicherung der
Konfiguration nutzt.

Diese "NAND Root" Modelle erforderten auch einen komplett überdachten
Mechanismus zur Aktualisierung und zur Recovery.

WIP

.. _Dateisystem:

Dateisystem
-----------

Grundsätzlich enthält jedes FRITZ!OS basierte Firmware-Image mindestens
ein `​SquashFS <http://de.wikipedia.org/wiki/Squashfs>`__ Dateisystem.
Dieses ist nahezu immer lzma oder gzip komprimiert, selten auch
unkomprimiert. Modelle mit Hidden SquashFS enthalten 2 Dateisysteme
nebeneinander in der Firmware, bei Modellen mit NAND Root sind es 2
ineinander verschachtelte Dateisysteme.

Ein SquashFS Image enthält einen immer unkomprimierten Superblock, der
mit der Signatur ``sqsh`` für Big Endian oder ``hsqs`` für Little Endian
anfängt. Diese Unterscheidung ist sehr wichtig, da alle weiteren Daten
den jeweiligen Endian nutzen. Der Superblock kann mit jeder Variante mit
``unsquashfs -s`` gelesen werden. Leider gibt es viele Varianten von
SquashFS, keinen globalen Standard und kein Werkzeug das für alle
Varianten funktioniert. Auf der FRITZBox 3 SquashFS Generationen
verwendet, Version 1 bis 3. Diese Versionsnummer wird im Superblock als
``versionmajor`` gespeichert. ``versionminor`` dient als Ersatz für das
vergessene Feld zur Angabe der Kompressionsart. 0 und 1 bedeutet gzip
Kompression die jedes Standard ``unsquashfs`` unterstützt - 76 ist bei
der FRITZBox der häufigste Wert, der lzma Kompression symbolisiert. Da
dies kein Standard ist baut Freetz ``tools/unsquashfs3-lzma``. Um es
nicht mit einer reinen Versionsnummer zu verwechseln hat sich sie
Schreibweise mit ':' zur Trennumg von major/minor eingebürgert - z.B.
``3:76``.

Bei der Analyse von 1800 verschiedenen unmodifizierten Firmware-, Labor-
und Recovery-Images ergab sich folgende Verteilung:

-  1:0 - SquashFS 1, gzip komprimiert - ca. 0,1%
-  2:0 - SquashFS 2, gzip komprimiert - ca. 0,5%
-  2:1 - SquashFS 2, gzip komprimiert - ca. 8%
-  2:76 - SquashFS 2, lzma komprimiert - ca. 23%
-  3:0 - SquashFS 3, gzip komprimiert - ca. 12,2%
-  3:76 - SquashFS 3, lzma komprimiert - ca. 56,5%

Die als 3:0 genannten Images sind die ``filesystem.image`` und die darin
enthaltenen ``filesystem_core.squashfs`` der NAND-Root Modelle, die
beide gzip komprimiert sind. Es gibt auch neuere SquashFS 4 Varianten
die auch ``xz`` Kompression unterstützen. Auf der FRITZBox kamen diese
jedoch bisher nicht zum Einsatz.

Auch Recoveries enthalten das SquashFS in binärer Form, in der ``.data``
Sektion die leicht mit 7zip isolierbar ist. Darin kann man nach den
beiden Signaturen suchen und Fehlfunde mit nicht plausiblen major/minor
Werten ausmaskieren. Die Grösse des SquashFS steht normalerweise im
Superblock als ``bytesused``, der Wert kann jedoch auch 0 sein. Dies ist
nicht wirklich ein Problem, da ein SquashFS nicht durch überflüssige
Daten am Ende gestört wird.

Es gibt einen (ca 5%) Anteil (leider auch 3 neuerer) Recoveries die eine
Extraktion nicht ermöglichen. So wurden runlength encoded Firmwareteile
entdeckt die auf überoptimierende Compiler hindeuten. In einigen älteren
Recoveries mit Contiguous SquashFS befindet sich die SquashFS Signatur
am Ende des ``.data`` Segments, das beschnittene SquashFS befindet sich
also nicht automatisch auffindbar vor dem Kernel. In beiden Fällen ist
das extrahierte Datenmaterial dann unbrauchbar.

Recoveries mit Contiguous SquashFS (bisher sind 10 bekannt) lassen sich
mit Kenntnis von Position und Länge des größeren SquashFS-Teils
extrahieren, runlength encoded Recoveries nur mit ``bsdiff`` generierten
Binärpatches des extrahierten Datenmaterials. Letztere sind recht klein
(1,5-3,5KB), lassen sich aber nur erstellen wenn eine Firmware oder ein
Partitionsdump der selben Version existiert. Dumps sehr alter Versionen
sind nur schwer erstellbar, da sie zum Einspielen meist einen älteren
Bootloader benötigen.

.. _Kernel:

Kernel
------

Das FRITZ!OS Kernel ist immer komprimiert. Hierbei kommen 3 Techniken
zum Einsatz, die vom installierten Bootloader abhängen.

Alle Kernels die auf ADAM2 lauffähig sind fangen mit der Hexfolge
``42 FA ED FE`` an (0xFEEDFA42), die ADAM2 Signatur für MIPS-LE. Da
ADAM2 noch keine eingebaute Unterstützung für komprimierte Kernels hatte
enthalten diese einen ``zimage`` Dekompressor (`​TI Avalanche
Inflater <http://gpl.back2roots.org/source/fritzbox/ALL_4.06/GPL-release_kernel/linux/arch/mips/mips-boards/ti_avalanche/inflater/>`__,
8,5-12,5 KB) vor dem eigentlichen gzip komprimierten Kernel. Man erkennt
diesen auch am String ``zimage`` innerhalb der ersten 13 KB des Kernels.
Der Anfang der Kerneldaten ist durch die gzip Signatur ``1F 8B 08``
auffindbar. ADAM2-Kernels sind auch auf EVA lauffähig.

Alle Kernels die EVA benötigen fangen mit der Hexfolge ``81 12 ED FE``
an, unabhängig vom Endian. Eine zweite Signatur ab Offset 12 (0x0C)
signalisiert die Art der Kompression der folgenden Kerneldaten. Die
Hexfolge ``01 02 5A 07`` bedeutet ``lzma``, die Folge ``10 20 5A 70``
bedeutet ``zlib`` Kompression, auch hier unabhängig vom Endian.

Bei der Analyse von 1800 verschiedenen unmodifizierten Firmware-, Labor-
und Recovery-Images ergab sich folgende Verteilung:

-  zimage - gzip komprimiertes Kernel 2.4 für ADAM2 oder EVA - ca. 10,2%
-  zlib - roher zlib Stream mit Kernel 2.6 für EVA - ca. 0,1%
-  lzma - lzma Stream mit Kernel 2.4 oder 2.6 für EVA - ca. 89,5%

EVA wurde also bereits unter Kernel 2.4 eingeführt. Von allen
untersuchten Kernel 2.4 Proben waren etwa 75% zimage komprimiert, der
Rest benötigt bereits EVA wegen lzma. Alle Kernel 2.6 Firmware benötigt
EVA.

Mit den beiden Signaturen lassen sich ADAM2- und EVA-Kernels in
Recoveries finden. Durch Prüfen der 3 Kompressions-Signaturen können
Fehlfunde ausmaskiert werden. Wie beim SquashFS funktioniert dies bei
runlength encoded Recoveries (bisher sind 11 bekannt) nur mit ``bsdiff``
generierten Binärpatches des extrahierten Datenmaterials. Interessant
ist, dass die Patches für das Kernel 3x grösser sind als die Patches für
das sehr viel umfangreichere SquashFS. Hier besteht offensichtlich noch
Forschungsbedarf.

.. _Weblinks:

Weblinks
--------

-  `​Avalanche MTD Treiber, Kernel
   2.4 <http://gpl.back2roots.org/source/fritzbox/ALL_4.06/GPL-release_kernel/linux/drivers/mtd/maps/avalanche-flash.c>`__
