help/howtos/development/make_room
=================================
Howtos: Entwicklung
^^^^^^^^^^^^^^^^^^^

#. `Entpacken und Packen von
   Firmware-Images <repack_fw.html#EntpackenundPackenvonFirmware-Images>`__

   #. `Tools und Syntax <repack_fw.html#ToolsundSyntax>`__
   #. `Vorgehensweise <repack_fw.html#Vorgehensweise>`__
   #. `Verwendung von fwmod im "no
      freetz"-Modus <repack_fw.html#Verwendungvonfwmodimnofreetz-Modus>`__

#. `Patches in Freetz
   einspielen <integrate_patches.html#PatchesinFreetzeinspielen>`__
#. `Example 3:
   NZBGet <developer_information/package_development_start/example_3.html#Example3:NZBGet>`__

   #. `Build
      manually <developer_information/package_development_start/example_3.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_3.html#AddpackagetoFreetz>`__
   #. `Create new image with added
      package <developer_information/package_development_start/example_3.html#Createnewimagewithaddedpackage>`__
   #. `Testing <developer_information/package_development_start/example_3.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_3.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. `Example 2:
   par2cmdline <developer_information/package_development_start/example_2.html#Example2:par2cmdline>`__

   #. `Build
      manually <developer_information/package_development_start/example_2.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_2.html#AddpackagetoFreetz>`__
   #. `Create new image with added
      package <developer_information/package_development_start/example_2.html#Createnewimagewithaddedpackage>`__
   #. `Testing <developer_information/package_development_start/example_2.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_2.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. `Example 1:
   Httptunnel <developer_information/package_development_start/example_1.html#Example1:Httptunnel>`__

   #. `Build
      manually <developer_information/package_development_start/example_1.html#Buildmanually>`__
   #. `Add package to
      Freetz <developer_information/package_development_start/example_1.html#AddpackagetoFreetz>`__
   #. `Call Procedures "make menuconfig" and
      "make" <developer_information/package_development_start/example_1.html#CallProceduresmakemenuconfigandmake>`__
   #. `Testing <developer_information/package_development_start/example_1.html#Testing>`__
   #. `Preparing New Package for Public Integration to Freetz
      Trunk <developer_information/package_development_start/example_1.html#PreparingNewPackageforPublicIntegrationtoFreetzTrunk>`__

#. 

   #. `Signieren von Firmware <sign_image.html#SignierenvonFirmware>`__
   #. `Konkrete Anwendung in
      Freetz <sign_image.html#KonkreteAnwendunginFreetz>`__

#. `Ablauf eines
   Firmware-Updates <firmware_update_details.html#AblaufeinesFirmware-Updates>`__
#. `Eigene Programme
   kompilieren <compile_own_progs.html#EigeneProgrammekompilieren>`__
#. `Dynamische Bandbreitenanzeige per
   SVG <bandwidth_svg.html#DynamischeBandbreitenanzeigeperSVG>`__

   #. `Anleitung zur
      Test-Installation <bandwidth_svg.html#AnleitungzurTest-Installation>`__

#. `Platz sparen im Dateisystem der
   FritzBox <make_room.html#PlatzsparenimDateisystemderFritzBox>`__

   #. `Vorwort und Motivation <make_room.html#VorwortundMotivation>`__
   #. `Bestandsaufnahme: Wo stecken die
      Platzfresser? <make_room.html#Bestandsaufnahme:WosteckendiePlatzfresser>`__
   #. `Weitere Spartricks <make_room.html#WeitereSpartricks>`__
   #. `Schlußwort <make_room.html#Schlußwort>`__

#. `Flash-Partitionen im laufenden Betrieb
   sichern <save_mtd_1.html#Flash-PartitionenimlaufendenBetriebsichern>`__

   #. `Motivation <save_mtd_1.html#Motivation>`__
   #. `Voraussetzungen <save_mtd_1.html#Voraussetzungen>`__
   #. `Lösungsweg <save_mtd_1.html#Lösungsweg>`__
   #. `Wege, sich schnell einen Überblick zu
      verschaffen <save_mtd_1.html#WegesichschnelleinenÜberblickzuverschaffen>`__
   #. `Zusammenfassung <save_mtd_1.html#Zusammenfassung>`__

#. `Release Management <release_management.html#ReleaseManagement>`__

   #. `Subversion
      Repository <release_management.html#SubversionRepository>`__
   #. `Checklists <release_management.html#Checklists>`__
   #. `GIT <release_management.html#GIT>`__
   #. `Downloads <release_management.html#Downloads>`__
   #. `References <release_management.html#References>`__

#. `First steps - How to start your first freetz
   package <developer_information/package_development_start.html#Firststeps-Howtostartyourfirstfreetzpackage>`__

   #. `Info <developer_information/package_development_start.html#Info>`__
   #. `Build
      Environment <developer_information/package_development_start.html#BuildEnvironment>`__
   #. `File
      Structure <developer_information/package_development_start.html#FileStructure>`__
   #. `Examples Binary
      Package <developer_information/package_development_start.html#ExamplesBinaryPackage>`__
   #. `Configuration
      Handling <developer_information/package_development_start.html#ConfigurationHandling>`__
   #. `Examples
      Web-Interface <developer_information/package_development_start.html#ExamplesWeb-Interface>`__
   #. `Trouble
      shooting <developer_information/package_development_start.html#Troubleshooting>`__

#. `Kernel konfigurieren und
   kompilieren <make_kernel.html#Kernelkonfigurierenundkompilieren>`__
#. `Menükonfiguration
   pflegen <menuconfig.html#Menükonfigurationpflegen>`__

   #. `Einstieg <menuconfig.html#Einstieg>`__
   #. `Beispiel-Konfiguration für ein neues
      Paket <menuconfig.html#Beispiel-KonfigurationfüreinneuesPaket>`__
   #. `Menuconfig-Warnungen
      beheben <menuconfig.html#Menuconfig-Warnungenbeheben>`__
   #. `Erklärung und Anwendung der erweiterten
      MK-Targets <menuconfig.html#ErklärungundAnwendungdererweitertenMK-Targets>`__
   #. `Syntax-Fehler in MK-Dateien
      finden <menuconfig.html#Syntax-FehlerinMK-Dateienfinden>`__
   #. `Syntax-Hervorhebung für
      MK-Dateien <menuconfig.html#Syntax-HervorhebungfürMK-Dateien>`__

#. `ADAM2-Bootloader <adam2.html#ADAM2-Bootloader>`__

   #. `Bootloader-Backup
      anlegen <adam2.html#Bootloader-Backupanlegen>`__
   #. `Bootloader überschreiben <adam2.html#Bootloaderüberschreiben>`__
   #. `Bootloader-Befehle <adam2.html#Bootloader-Befehle>`__
   #. `Bootloader-Quelltext <adam2.html#Bootloader-Quelltext>`__
   #. `Aufbau des Bootloaders <adam2.html#AufbaudesBootloaders>`__
   #. `Bootloader und Freetz <adam2.html#BootloaderundFreetz>`__

#. `Einstellungen speichern im
   Urlader-Environment <urlader_flags.html#EinstellungenspeichernimUrlader-Environment>`__

   #. `Vorwort und
      Motivation <urlader_flags.html#VorwortundMotivation>`__
   #. `Lösungsmöglichkeiten <urlader_flags.html#Lösungsmöglichkeiten>`__
   #. `Bootloader
      Environment <urlader_flags.html#BootloaderEnvironment>`__
   #. `Variable
      "kernel_args" <urlader_flags.html#Variablekernel_args>`__
   #. `Kernel_Args-API <urlader_flags.html#Kernel_Args-API>`__
   #. `Mögliche
      Anwendungsfälle <urlader_flags.html#MöglicheAnwendungsfälle>`__

#. `Busybox konfigurieren und
   kompilieren <make_busybox.html#Busyboxkonfigurierenundkompilieren>`__
#. `Wie baue ich ein eigenes Paket für
   Freetz? <package_creation.html#WiebaueicheineigenesPaketfürFreetz>`__
#. `Firmware-Image-Namen analysieren und
   interpretieren <analyse_image_names.html#Firmware-Image-Namenanalysierenundinterpretieren>`__

   #. `Einleitung <analyse_image_names.html#Einleitung>`__
   #. `Skript-Code <analyse_image_names.html#Skript-Code>`__
   #. `Daten im Rohformat <analyse_image_names.html#DatenimRohformat>`__
   #. `Ausgabe grundlegender
      Informationen <analyse_image_names.html#AusgabegrundlegenderInformationen>`__
   #. `Ausgabe erweiterter
      Informationen <analyse_image_names.html#AusgabeerweiterterInformationen>`__

#. 

   #. `Web-interface
      HTTPTunnel <developer_information/package_development_start/webinterface_example_1.html#Web-interfaceHTTPTunnel>`__

#. `Developer
   Information <developer_information.html#DeveloperInformation>`__
#. `Addon Paket
   installieren <install_addon.html#AddonPaketinstallieren>`__
#. `Paketverwaltung für
   Freetz <developer_information/package_development_dynamic.html#PaketverwaltungfürFreetz>`__

   #. `Erweiterung des
      Dateisystems <developer_information/package_development_dynamic.html#ErweiterungdesDateisystems>`__
   #. `Paketverwaltung <developer_information/package_development_dynamic.html#Paketverwaltung>`__
   #. `Links <developer_information/package_development_dynamic.html#Links>`__
   #. `Kommentare <developer_information/package_development_dynamic.html#Kommentare>`__

#. `Wie die FritzBox Manipulationen
   erkennt <manipulation_detection.html#WiedieFritzBoxManipulationenerkennt>`__

   #. `Ursachen <manipulation_detection.html#Ursachen>`__
   #. `Diagnose <manipulation_detection.html#Diagnose>`__
   #. `Lösungen <manipulation_detection.html#Lösungen>`__
   #. `Schlußwort und
      Ausblick <manipulation_detection.html#SchlußwortundAusblick>`__

#. `Shell Coding
   Conventions <developer_information/shell_coding_conventions.html#ShellCodingConventions>`__

   #. `Shell
      Language <developer_information/shell_coding_conventions.html#ShellLanguage>`__
   #. `Basic
      Format <developer_information/shell_coding_conventions.html#BasicFormat>`__
   #. `If, For, and
      While <developer_information/shell_coding_conventions.html#IfForandWhile>`__
   #. `Test
      Built-in <developer_information/shell_coding_conventions.html#TestBuilt-in>`__
   #. `Single-line conditional
      statements <developer_information/shell_coding_conventions.html#Single-lineconditionalstatements>`__
   #. `Infinite
      Loops <developer_information/shell_coding_conventions.html#InfiniteLoops>`__
   #. `Exit Status and If/While
      Statements <developer_information/shell_coding_conventions.html#ExitStatusandIfWhileStatements>`__
   #. `Variable
      References <developer_information/shell_coding_conventions.html#VariableReferences>`__
   #. `Variable
      Naming <developer_information/shell_coding_conventions.html#VariableNaming>`__
   #. `Quoting <developer_information/shell_coding_conventions.html#Quoting>`__
   #. `Variable
      Assignments <developer_information/shell_coding_conventions.html#VariableAssignments>`__
   #. `Testing for (Non-)Empty
      Strings <developer_information/shell_coding_conventions.html#TestingforNon-EmptyStrings>`__
   #. `Commenting <developer_information/shell_coding_conventions.html#Commenting>`__
   #. `Pathnames <developer_information/shell_coding_conventions.html#Pathnames>`__
   #. `Interpreter
      Magic <developer_information/shell_coding_conventions.html#InterpreterMagic>`__

#. `Package
   Development <developer_information/package_development.html#PackageDevelopment>`__

   #. `Persistent Package
      Settings <developer_information/package_development.html#PersistentPackageSettings>`__

#. `Erstellen einer GUI für Pakete in
   Freetz <create_gui.html#ErstelleneinerGUIfürPaketeinFreetz>`__

   #. `Motivation <create_gui.html#Motivation>`__
   #. `Grundlagen <create_gui.html#Grundlagen>`__
   #. `Wie funktioniert das mit der
      GUI? <create_gui.html#WiefunktioniertdasmitderGUI>`__

#. `Flash Partitionierung <flash.html#FlashPartitionierung>`__

   #. `Hidden SquashFS <flash.html#HiddenSquashFS>`__
   #. `Contiguous SquashFS <flash.html#ContiguousSquashFS>`__
   #. `Hidden Root <flash.html#HiddenRoot>`__
   #. `NAND Root <flash.html#NANDRoot>`__
   #. `Dateisystem <flash.html#Dateisystem>`__
   #. `Kernel <flash.html#Kernel>`__
   #. `Weblinks <flash.html#Weblinks>`__

#. `Trac
   Hooks <developer_information/post_commit_hook.html#TracHooks>`__

   #. `trac-post-commit-hook <developer_information/post_commit_hook.html#trac-post-commit-hook>`__
   #. `trac-post-revprop-change-hook <developer_information/post_commit_hook.html#trac-post-revprop-change-hook>`__

#. `Package Developing - Advanced
   Topics <developer_information/package_development_advanced.html#PackageDeveloping-AdvancedTopics>`__

   #. `Adding conditional
      patches <developer_information/package_development_advanced.html#Addingconditionalpatches>`__
   #. `Adding multi-binary
      packages <developer_information/package_development_advanced.html#Addingmulti-binarypackages>`__

#. `Eigene Dateien in die Firmware
   integrieren <integrate_own_files.html#EigeneDateienindieFirmwareintegrieren>`__

   #. `Feste Integration über das Freetz
      Image <integrate_own_files.html#FesteIntegrationüberdasFreetzImage>`__
   #. `Erzeugen der Dateien aus der
      debug.cfg <integrate_own_files.html#ErzeugenderDateienausderdebug.cfg>`__
   #. `Nachladen vom
      Webserver <integrate_own_files.html#NachladenvomWebserver>`__
   #. `Nachladen vom
      USB-Stick <integrate_own_files.html#NachladenvomUSB-Stick>`__
   #. `WebDAV Share
      mounten <integrate_own_files.html#WebDAVSharemounten>`__
   #. `NFS-Share mounten <integrate_own_files.html#NFS-Sharemounten>`__

#. `Freetz Build-Prozeß <freetz_make.html#FreetzBuild-Prozeß>`__

   #. `Vorwort und Motivation <freetz_make.html#VorwortundMotivation>`__
   #. `Grundsätzliches <freetz_make.html#Grundsätzliches>`__

#. `Flash-Partitionen von außen mit FTP
   sichern <save_mtd_2.html#Flash-PartitionenvonaußenmitFTPsichern>`__

   #. `Motivation <save_mtd_2.html#Motivation>`__
   #. `Voraussetzungen <save_mtd_2.html#Voraussetzungen>`__
   #. `Allgemeine Informationen zur
      Datensicherung <save_mtd_2.html#AllgemeineInformationenzurDatensicherung>`__
   #. `Sicherung mit Linux-Standard-FTP
      (ftp) <save_mtd_2.html#SicherungmitLinux-Standard-FTPftp>`__
   #. `Sicherung mit Linux-NcFTP
      (ncftpget) <save_mtd_2.html#SicherungmitLinux-NcFTPncftpget>`__
   #. `Sicherung mit Cygwin-NcFTP
      (ncftpget) <save_mtd_2.html#SicherungmitCygwin-NcFTPncftpget>`__
   #. `Uploads via FTP <save_mtd_2.html#UploadsviaFTP>`__

#. `libmodcgi.sh <developer_information/webif/libmodcgi.html#libmodcgi.sh>`__

   #. `cgi <developer_information/webif/libmodcgi.html#cgi>`__
   #. `cgi_begin <developer_information/webif/libmodcgi.html#cgi_begin>`__
   #. `cgi_end <developer_information/webif/libmodcgi.html#cgi_end>`__
   #. `sec_begin <developer_information/webif/libmodcgi.html#sec_begin>`__
   #. `sec_end <developer_information/webif/libmodcgi.html#sec_end>`__
   #. `html <developer_information/webif/libmodcgi.html#html>`__
   #. `check,
      select <developer_information/webif/libmodcgi.html#checkselect>`__
   #. `href <developer_information/webif/libmodcgi.html#href>`__
   #. `back_button <developer_information/webif/libmodcgi.html#back_button>`__
   #. `sec_level <developer_information/webif/libmodcgi.html#sec_level>`__
   #. `stat_bar <developer_information/webif/libmodcgi.html#stat_bar>`__
   #. `cgi_param <developer_information/webif/libmodcgi.html#cgi_param>`__
   #. `cgi_error,
      print_error <developer_information/webif/libmodcgi.html#cgi_errorprint_error>`__
   #. `path_info <developer_information/webif/libmodcgi.html#path_info>`__
   #. `valid <developer_information/webif/libmodcgi.html#valid>`__

#. `Cross-Compiler / Toolchain
   erstellen <create_cross-compiler_toolchain.html#Cross-CompilerToolchainerstellen>`__
#. `Eigene Download-Toolchain
   erstellen <create_cross-compiler_toolchain.html#EigeneDownload-Toolchainerstellen>`__
#. `Target/Native-Compiler-Toolchain
   erstellen <create_cross-compiler_toolchain.html#TargetNative-Compiler-Toolchainerstellen>`__

   #. `Using the dev-tools package to install compiler and
      tools <create_cross-compiler_toolchain.html#Usingthedev-toolspackagetoinstallcompilerandtools>`__

.. _PlatzsparenimDateisystemderFritzBox:

Platz sparen im Dateisystem der FritzBox
========================================

.. _VorwortundMotivation:

Vorwort und Motivation
----------------------

Dass der Speicherplatz im Dateisystem der FritzBox - insbesondere bei
den heute noch verbreiteten "kleinen" Routern wie der 5050 oder der 7050
- begrenzt ist, dürfte jedem Modder klar sein, der schon einmal
entsprechende Fehlermeldungen von ``fwmod`` während des Zusammenbauens
der Firmware (FW) gesehen hat und daraufhin anfangen mußte zu überlegen,
welche Freetz-Pakete er weglässt. Diskutiert wird über dieses Problem
bspw. im IPPF-Thread `​7050 zu eng: DS-Mod-Teile manuell auf externe
Platte
auslagern <http://www.ip-phone-forum.de/showthread.php?t=132936>`__,
aber auch woanders.

Ohne ein hier ein fertiges "Abspeck-Werkzeug" präsentieren zu wollen,
möchte ich an dieser Stelle einfach mal übersichtshalber zusammenfassen,
welche Mittel und Wege mir derzeit einfallen würden, wenn ich Platz
sparen müsste auf meiner Box. Es geht darum, Hilfe zur Selbsthilfe zu
leisten und ein paar Gedanken mit auf den Weg zu geben, um es jedem zu
ermöglichen, die ihm am erfolgversprechendsten erscheinenden Wege weiter
zu verfolgen. Weder erhebt diese kleine Übersicht Anspruch auf
Vollständigkeit noch auf absolute Korrektheit oder Praxiserprobtheit.
Mit meiner 7170 habe ich momentan keine Platzprobleme, da ich auch nicht
der Typ bin, der "alles" auf seiner Box laufen haben möchte - übrigens
schon der erste und mit effektivste Weg zum Sparen: nicht übertriebene,
aber angemessene Bescheidenheit und Konzentration aufs Notwendige.

.. _Bestandsaufnahme:WosteckendiePlatzfresser:

Bestandsaufnahme: Wo stecken die Platzfresser?
----------------------------------------------

Bevor wir darüber nachdenken, an welchen Ecken wir sparen können,
sollten wir uns zunächst einen Überblick darüber verschaffen, wo am
meisten Platz verbraucht wird. Im zweiten Schritt unterscheiden wir dann
zwischen notwendigen und überflüssigen Platzfressern, im Folgenden PFs
genannt. Schließlich gehen wir nach dem
`​Pareto-Prinzip <http://de.wikipedia.org/wiki/Pareto-Verteilung#Pareto-Prinzip>`__
vor, um mit überschaubarem Aufwand einen möglichst hohen Effekt zu
erzielen.

.. _Schritt1:UntersuchungOriginal-Firmware:

Schritt 1: Untersuchung Original-Firmware
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Welche Dateien verbrauchen am meisten Platz in der Original-Firmware?
Dazu schauen wir uns am einfachsten nach einem ``make`` das Verzeichnis
an, in welchem die entpackten Firmware-Dateien abgelegt sind:
``build/original/filesystem``. Mit folgendem Befehl durchsuchen wir das
Verzeichnis nach Dateien (``find -type f``) und übergeben all diese
Dateien dem ``ls``-Befehl, um diesen dazu veranlassen, sie nach ihrer
Größe absteigend zu sortieren. Als Beispiel diene hier die AVM-FW
29.04.29 für die Box vom Typ 7170. (Der Übersicht halber lasse ich
unwichtige Spalten der Ergebnisliste weg.)

.. code:: wiki

   $ cd build/original/filesystem
   $ find . -type f | xargs ls -lSR | more

   1291372 lib/libcrypto.so.0.9.8
    858208 lib/modules/2.6.13.1-ohio/kernel/drivers/isdn/isdn_fon4/zzz/isdn_fbox.ko
    730844 lib/modules/2.6.13.1-ohio/kernel/drivers/dsld/kdsldmod.ko
    551944 usr/bin/telefon
    473772 lib/modules/2.6.13.1-ohio/kernel/drivers/net/wireless/avm_wlan/wlan/tiap.ko
    425652 lib/libuClibc-0.9.28.so
    416632 bin/busybox
    314836 lib/libavmcsock.so.2.0.0
    303784 lib/modules/microvoip-dsl.bin
    283853 lib/modules/microvoip_isdn_top.bit1
    274704 usr/bin/ctlmgr
    274352 lib/libsiplib.so.2.0.0
    259052 lib/libssl.so.0.9.8
    252344 usr/share/ctlmgr/libtr069.so
    234684 usr/share/ctlmgr/libfon.so
    212468 lib/modules/microvoip_isdn_top.bit
    212432 sbin/dsld
    202684 lib/libmscodex.so.2.0.0
    167180 sbin/fsck.ext2
    163360 sbin/multid
    158332 lib/modules/2.6.13.1-ohio/kernel/drivers/usb/core/usbcore.ko
    154224 usr/bin/wpa_authenticator
    142624 lib/modules/2.6.13.1-ohio/kernel/drivers/atm/avm_atm/tiatm.ko
    142104 lib/libosipparser2.so.4.0.0
    134308 lib/modules/2.6.13.1-ohio/kernel/drivers/scsi/scsi_mod.ko
    132296 lib/libar7cfg.so.1.0.0
    117056 lib/libm-0.9.28.so
    116804 bin/voipd
    106192 lib/modules/fw_dcrhp_1150_ap.bin
    102712 usr/lib/libext2fs.so.2.4
    102472 sbin/fdisk

Jetzt kann man anfangen zu überlegen, was wohl verzichtbar wäre. Eine
Busybox oder den DSL-Daemon wegzulassen, ergibt keinen Sinn - eher
schon, bei der Busybox auf unnötige Applets zu verzichten. Mancher mag
sich überlegen, dass er die WLAN-Bestandteile nicht braucht, stattdessen
vielleicht lieber mehr Platz für OpenVPN schaffen möchte. Das ist nur
ein Beispiel und unabhängig davon, ob die Box ohne die WLAN-Binaries
überhaupt sauber startet (Kommentar: Das WLAN-Modul, tiap.ko, lässt sich
ohne Probleme entfernen). Wenn man die Dateien weglässt, sollte man z.B.
dafür sorgen, daß die entsprechenden Dienste deaktiviert werden oder in
den entsprechenden Startskripten ggf. Dinge zur Sicherheit
auskommentiert werden. Bei anderen Programmen fällt die Entscheidung
wieder leichter: ``fdisk`` braucht man beispielsweise im Normalfall
nicht, solange man nicht mit ``mkfs.ext2`` ein Dateisystem anlegen
möchte. Ein bisschen sparen kann man also, indem man es weglässt,
vielleicht die entscheidenden KB, damit eine andere Erweiterung auf die
Box passt. Für andere Kandidaten wie die
`libtr069 <../../../patches/remove_tr069.html>`__ gibt es bei den
kleinen Boxen sogar schon Schalter in der
`Menükonfiguration <../common/install/menuconfig.html>`__ von Freetz, um
sie wegzulassen. Im Allgemeinen untersucht man die Startdateien unter
``/etc/init.d``, um herauszufinden, ob und wann eine bestimmte Datei
geladen wird. Bei benötigten Bibliotheken ist die Analyse etwas
schwieriger, aber auch möglich.

.. _Schritt2:UntersuchungMod-Firmware:

Schritt 2: Untersuchung Mod-Firmware
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Das Gleiche, was wir gerade für die Original-Firmware gemacht haben, tun
wir nun für die nach unseren Wünschen konfigurierte Mod-Firmware. Selbst
wenn diese evtl. nicht erfolgreich gebaut werden konnte, weil z.B. der
Platz nicht genügte, sehen wir doch das erzeugte Dateisystem unter
``build/modified/filesystem``. Es folgt ein Beispiel von meiner 7170 mit
Mod-Version ds-0.2.9_26-14.2 und, grob gesprochen, folgenden aktivierten
Optionen und Erweiterungen: 1&1-Branding, keine Hilfetexte und
Assistenten, Original-Kernel, Bftp, Callmonitor, Cifsmount, Dropbear
(nur Server), MC, Mini_fo, Samba, Screen, Syslogd-CGI, WoL-CGI, Lua,
Matrixtunnel. Das sieht dann so aus:

.. code:: wiki

   $ cd build/modified/filesystem
   $ find . -type f | xargs ls -lSR | more

   1291372 lib/libcrypto.so.0.9.8
    913456 usr/sbin/smbd
    858208 lib/modules/2.6.13.1-ohio/kernel/drivers/isdn/isdn_fon4/zzz/isdn_fbox.ko
    779956 usr/bin/mc.bin
    730844 lib/modules/2.6.13.1-ohio/kernel/drivers/dsld/kdsldmod.ko
    599740 bin/busybox
    551944 usr/bin/telefon
    473772 lib/modules/2.6.13.1-ohio/kernel/drivers/net/wireless/avm_wlan/wlan/tiap.ko
    436344 usr/sbin/nmbd
    413184 lib/libuClibc-0.9.28.so
    372060 usr/bin/screen.bin
    323371 lib/modules/2.6.13.1-ohio/kernel/fs/cifs/cifs.ko
    314836 lib/libavmcsock.so.2.0.0
    303784 lib/modules/microvoip-dsl.bin
    283853 lib/modules/microvoip_isdn_top.bit1
    274704 usr/bin/ctlmgr
    274352 lib/libsiplib.so.2.0.0
    273900 usr/lib/libncurses.so.5.5
    259052 lib/libssl.so.0.9.8
    252344 usr/share/ctlmgr/libtr069.so
    234684 usr/share/ctlmgr/libfon.so
    212468 lib/modules/microvoip_isdn_top.bit
    212432 sbin/dsld
    204336 usr/bin/lua
    202684 lib/libmscodex.so.2.0.0
    200256 usr/lib/libreadline.so.5.2
    183224 usr/sbin/dropbearmulti
    167180 sbin/fsck.ext2
    163360 sbin/multid
    155037 lib/modules/2.6.13.1-ohio/kernel/drivers/usb/core/usbcore.ko
    154224 usr/bin/wpa_authenticator
    142624 lib/modules/2.6.13.1-ohio/kernel/drivers/atm/avm_atm/tiatm.ko
    142104 lib/libosipparser2.so.4.0.0
    132296 lib/libar7cfg.so.1.0.0
    132124 lib/modules/2.6.13.1-ohio/kernel/drivers/scsi/scsi_mod.ko
    131614 usr/share/samba/unicode_map.850
    117746 usr/lib/mc/mc.hlp
    116804 bin/voipd
    116148 lib/libm-0.9.28.so
    106192 lib/modules/fw_dcrhp_1150_ap.bin
    102712 usr/lib/libext2fs.so.2.4
    102472 sbin/fdisk

Wir erkennen: Samba, MC und Screen scheinen recht groß zu sein, aber so
richtig übersichtlich ist das Ganze nicht, denn die zuvor analysierten
Dateien der Original-Firmware sind ja immer noch in der Liste. Wenn wir
nur die exklusiv im Mod vorkommenden sehen wollen, müssen wir erst ein
bißchen aussieben:

::

   $ cd build
   $ find original/filesystem -type f | sed 's/^original\/filesystem\///' > orig-files
   $ find modified/filesystem -type f | sed 's/^modified\/filesystem\///' > modi-files
   $ diff -u orig-files modi-files | \
       grep '^+' | grep -v '^+++' | sed 's/^+/modified\/filesystem\//' > new-files
   $ cat new-files | xargs ls -lSR | more

    913456 usr/sbin/smbd
    779956 usr/bin/mc.bin
    436344 usr/sbin/nmbd
    372060 usr/bin/screen.bin
    323371 lib/modules/2.6.13.1-ohio/kernel/fs/cifs/cifs.ko
    273900 usr/lib/libncurses.so.5.5
    204336 usr/bin/lua
    200256 usr/lib/libreadline.so.5.2
    183224 usr/sbin/dropbearmulti
    131614 usr/share/samba/unicode_map.850
    117746 usr/lib/mc/mc.hlp
     85680 lib/modules/2.6.13.1-ohio/kernel/fs/mini_fo/mini_fo.ko
     85072 usr/lib/libmatrixssl.so
     68816 usr/sbin/bftpd
     57005 lib/modules/2.6.13.1-ohio/kernel/net/ipv4/netfilter/ip_conntrack.ko
     34309 usr/lib/mc/syntax/html.syntax
     31232 lib/modules/2.6.13.1-ohio/kernel/net/ipv4/netfilter/ip_tables.ko
     26432 usr/lib/libhistory.so.5.2
     24544 usr/bin/haserl
     23940 usr/sbin/matrixtunnel
     21708 usr/sbin/mount.cifs
     20392 lib/modules/2.6.13.1-ohio/kernel/drivers/block/loop.ko
     11461 usr/lib/mc/syntax/perl.syntax
     10684 lib/modules/2.6.13.1-ohio/kernel/net/ipv4/netfilter/ipt_LOG.ko

Wir sehen Verschiedenes: *Samba* ist tatsächlich ein Platzfresser, wenn
man *smbd* und *nmbd* zusammenzählt. *MC* mit *ncurses* ist auch nicht
zu verachten - evtl. könnten wir wenigstens die Hilfedatei *mc.hlp*
weglassen. Allerdings muß man bei textlastigen Dateien wie der MC-Hilfe
aufpassen und die Erwartungen nicht zu hoch schrauben: **Unsere
Vergleiche hinken im Grunde alle, denn wir müßten uns die Dateien
LZMA-komprimiert anschauen, um einen Eindruck davon zu erhalten, wieviel
Platz sie in einem SquashFS auf der Box wirklich brauchen würden.
Textdateien z.B. sind extrem stark komprimierbar. Sie also wegzulassen,
bringt oft weniger als erhofft.**

Was noch auffällt, sind diverse *Netfilter*-Bibliotheken, die wohl mit
in die Firmware kopiert wurden, als ich mal testweise *Iptables*
kompiliert habe. Offensichtlich bleibt dabei so Manches übrig, das gar
nicht hinein gehört in die FW, weil es längst abgewählt wurde. Das gilt
übrigens auch für so manche Shared Library und diverse Kernelmodule.
Also hier bitte aufpassen und kontrollieren, evtl. mal die
entsprechenden Verzeichnisse leeren oder, falls man nicht weiß, wo man
hinfassen soll, mal neu aufsetzen und mit korrekt eingestellter
Konfiguration (Datei ``.config``) von vorne anfangen.

.. _Schritt3:Vorher-Nachher-VergleichexistierenderDateien:

Schritt 3: Vorher-Nachher-Vergleich existierender Dateien
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Wir haben uns bisher alte und neue Dateien angeschaut, aber nicht
geprüft, ob sich gleichnamige, in beiden FW-Versionen vorhandene Dateien
evtl. signifikant in der Größe geändert haben. Auch das kann uns evtl.
Hinweise darauf geben, wo man noch sparen kann, wenngleich vermutlich in
geringerem Umfang. Aber wer den Heller nicht ehrt, …

Das folgende Shell-Skript mag etwas verwirrend sein, und optimal
programmiert ist es sicher nicht, aber es dient seinem Zweck. (Ich kann
übrigens nicht mit *Awk* umgehen, sonst wäre das Ganze vermutlich
übersichtlicher geworden.) Was es tut, ist Folgendes:

-  zwei Dateilisten generieren (wie oben schon gesehen)
-  in beiden Listen auftauchende Dateinamen herausfiltern (d.h. übrig
   lassen)
-  ein weiteres Shell-Skript erzeugen und ausführbar machen
-  das Shell-Skript ausführen
-  Das Skript selbst gibt für alle gemeinsamen Dateien die
   Größendifferenz (neu minus alt) in Bytes und den Pfadnamen aus.
-  Die Ergebnisliste wird aufsteigend sortiert und gefiltert (Dateien
   ohne Unterschied in der Größe werden eliminiert).
-  Uns interessieren dann die Dateien mit den größten absoluten
   Unterschieden. Negative Werte bedeuten dabei Platzersparnis gegenüber
   der Original-Firmware, positive zusätzlich beanspruchten
   Speicherplatz.

::

   $ cd build
   $ find original/filesystem -type f | sed 's/^original\/filesystem\///' > orig-files
   $ find modified/filesystem -type f | sed 's/^modified\/filesystem\///' > modi-files
   $ diff -u 99999 orig-files modi-files | grep '^ ' | sed 's/^ //' > before-after-files
   $ echo '#!/bin/bash' > before-after-script
   $ chmod +x before-after-script
   $ cat before-after-files | sed -r \
       's/(.*)/printf "%10d %s\\n" $(( $(stat -c "%s" modified\/filesystem\/\1) - $(stat -c "%s" original\/filesystem\/\1) )) \1/' \
       >> before-after-script
   $ ./before-after-script | grep -v ' 0 ' | sort -g > before-after-diffs

   -12468 lib/libuClibc-0.9.28.so
    -7508 lib/libgcc_s.so.1
    -3295 lib/modules/2.6.13.1-ohio/kernel/drivers/usb/core/usbcore.ko
    -2184 lib/modules/2.6.13.1-ohio/kernel/drivers/scsi/scsi_mod.ko
    -1088 lib/modules/2.6.13.1-ohio/kernel/fs/fat/fat.ko
      ... ...
     9756 lib/libpthread-0.9.28.so
    10240 var.tar
   183108 bin/busybox

Wir erkennen in diesem Fall nichts Aufregendes: Die *uClibc* wurde ca.
12 KB kleiner, die *Busybox* allerdings um ca. 180 KB größer. Das ist
doch nicht zu vernachlässigen. Allerdings kann die *Busybox* damit auch
mehr als das Original.

War das jetzt umsonst? Nein! Denn wenn wir das Gleiche mal bei der
7050-FW machen, sehen wir, daß dort die *libgcc_s*, wenn sie denn in der
Konfiguration ausgewählt und somit ersetzt wurde, von 215 auf knappe 60
KB schrumpft (siehe
`​dort <http://www.ip-phone-forum.de/showpost.php?p=840715&postcount=17>`__).
Das liegt daran, daß in dieser FW-Version das Original - wohl
versehentlich - nicht gestrippt oder gar mit zusätzlicher
Debug-Information freigegeben wurde. Ergo: Wer eine FW modifiziert und
Platz sparen möchte, sollte tunlichst auch auf scheinbare Kleinigkeiten
achten.

.. _WeitereSpartricks:

Weitere Spartricks
------------------

.. _AuslagerungvonDateien:

Auslagerung von Dateien
~~~~~~~~~~~~~~~~~~~~~~~

Eine Möglichkeit mit viel Potential ist das Auslagern von Dateien,
entweder auf direkt zugreifbare USB-Datenträger (Speicherstift,
Festplatte) oder auf Netzlaufwerke, die mittels NFS, Cifsmount oder
Smbmount beim Hochfahren der Box eingebunden werden, so daß die erst
nach dem Einbinden (Mounten) benötigten Dateien direkt vom externen
Speicher bzw. übers Netz geladen werden können. Damit kann man eine
Firmware in ``build/modified`` bauen, die eigentlich zu groß ist für ein
Image und abbricht beim Bauen, welche man jedoch hinterher so verändert,
daß große Dateien durch Symlinks auf die zu mountenden Speicher ersetzt
werden. Die entnommenen Dateien werden entsprechend bereitgestellt, das
ausgedünnte ``build/modified`` im zweiten Durchgang erfolgreich zu einem
Image verbaut. Die Startskripten der FW wurden vorher ebenfalls
entsprechend angepaßt.

*Update 05.10.2007:* Bereits seit ds26-15.1 ist das Paket
`​Downloader-CGI <http://www.ip-phone-forum.de/showthread.php?t=134934>`__
Bestandteil des DS-Mod. Es erleichtert das automatische Herunterladen
von Dateien beim Start der Box.

.. _KomprimierteBinariesundNutzdaten:

Komprimierte Binaries und Nutzdaten
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Eine häufig geäußerte Idee im IPPF ist, man könne doch beispielsweise
einen EXE-Packer verwenden, um die Binaries zu verkleinern. Das ist
**ziemlich sinnlos** und kostet nur unnötig Rechenzeit, denn das
SquashFS (Dateisystem der Boxen) ist bereits so extrem gut komprimiert,
daß eine weitere Kompression gar nicht zum Tragen kommen würde (siehe
`​dort <http://www.ip-phone-forum.de/showthread.php?p=832868&highlight=lzma#post832868>`__).
Warum das manchmal dazu führt, daß eine scheinbar große weggelassene
Datenmenge kaum Ersparnisse bei der FW-Größe bringt, sofern es sich um
gut komprimierbare Daten handelt, erkläre ich `​in diesem
Beitrag <http://www.ip-phone-forum.de/showthread.php?p=844325&highlight=lzma#post844325>`__.

.. _Älterebzw.alternativeSoftware-Versionen:

Ältere bzw. alternative Software-Versionen
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Oft wird im `​IPPF <http://www.ip-phone-forum.de/>`__ gefragt, weshalb
beispielsweise der *Midnight Commander (mc-4.5.0)* oder *Samba 2.0.10*
so alte Stände haben. Das hängt teilweise einfach damit zusammen, daß
die alten Versionen vom Leistungsumfang her ausreichen, dafür aber viel
kleiner sind als die neueren Versionen mit mehr Features. Im Falle des
*MC* kommt noch dazu, daß neuere Versionen gegen Bibliotheken gelinkt
sind, welche über das, was die *uClibC* als *libc*-Ersatz bietet, ein
wenig hinaus gehen und das Ersetzen entsprechender Aufrufe durch eigene
Makros einen großen Aufwand bedeuten würde.

Weitere Sparmöglichkeiten bestehen in der Suche nach Alternativen zu
bekannten Softwarepaketen. Beispiele:

-  *Matrixssl* ist kleiner als *OpenSSL*, genügt aber oft, z.B. um einen
   HTTPS-Tunnel zu bauen. Nur wenn auf SSL-Bibliotheken aufsetzende
   Software wie *OpenVPN* nicht mit *Matrixssl* funktionieren, man aber
   glaubt, diese zu brauchen, bleibt keine Wahl.
-  *Deco* ist kleiner als *MC*, dafür aber auch wesentlich weniger
   leistungsfähig.
-  Die *Rudi-Shell* ist phantastisch klein, kann aber sehr viel. Sie
   führt beliebige Shell-Skripten aus, hat eine Befehlshistorie, kann
   Dateien von und zur Box transferieren (sogar komprimiert) und taugt
   sogar zum Remote-Flashen der Box. Mittels *Matrixtunnel* wird sie ein
   funktional (nicht komfortmäßig) vollwertiger Ersatz für *SSH* bei
   weit geringerem Platzbedarf und ohne die Notwendigkeit, einen
   SSH-Zugang zu haben, was hinter manchen Firewalls einfach nicht
   erlaubt ist, weil es nur einen Web-Proxy für HTTP und HTTPS gibt.
   Rudi + Matrixtunnel genügt dies. Einen *vi* kann Rudi zwar nicht
   remote bedienbar machen, aber dafür kann man ja einfach Dateien hin
   und her übertragen. Lokal bequem editieren, zurück auf die Box -
   fertig!
-  *Cifsmount* stellt Verbindungen zu Windows- und Samba-Freigaben her,
   ist aber deutlich kleiner als *Smbmount*.
-  *Mini_fo* kleiner als *UnionFS*, läuft aber sehr stabil (bisher keine
   mir bekannten Fehlermeldungen dazu im Forum). Dafür kann man einen
   *Mini_fo*-Mount nicht über NFS exportieren, aber wer braucht das
   schon? Außerdem gibt es Samba, damit geht es.
-  *Perl* oder *PHP* würden die FritzBox ressourcentechnisch überlasten
   - *Lua* nicht. *Lua* ist eine sehr schlanke und dabei einfach zu
   lernende und leistungsfähige Skriptsprache, nicht nur für CGI.
   *Update 05.10.2007:* Inzwischen habe ich gelernt, daß Apache + PHP,
   die man jetzt auch per Freetz bauen kann, sehr wohl stabil und
   performant auf der FritzBox laufen, aber der Platzverbrauch ist
   enorm. Und ums Platzsparen geht es ja hier.
-  A propos CGI-Handling: *Haserl* ist klein und leistet alles, was ich
   auf der Box brauche. Da brauche ich nicht einmal *Lua*, und manchmal
   verzichte ich sogar auf Haserl, weil es ein Shellskript tut.

.. _Firmware-PatchesausMenuconfig:

Firmware-Patches aus Menuconfig
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Schon seit langer Zeit gibt es Firmware-Patches, die nicht benötigte
Original-Bestandteile aus dem FW-Image entfernen und Platz für
Zusatz-Pakete schaffen. Dabei muß jeder selbst entscheiden, ob er
Hilfetexte und Assistenten für die AVM-Weboberfläche, den
Original-AVM-Webserver selbst (durch BusyBox-httpd ersetzbar), UPnP,
DSL, VoIP, Kindersicherung usw. benötigt.

Wer z.B. seine Box als reinen IP-Client betreibt, der über einen
weiteren vorgeschalteten Router die Internet-Verbindung bekommt und auch
keine PPoE-Anmeldung benötigt, kann viel Platz sparen mit einem
entsprechenden Patch, welcher *dsld* plus Zubehör aus der Firmware
entfernt. Normalanwender benutzen die Box als DSL-Router und können den
Patch dann eben nicht anwenden.

Beispiel Webserver: Auf den AVM-Webserver kann man nach heutigem
Wissensstand problemlos verzichten und stattdessen den kleineren und
ressourcenschonenderen *httpd* verwenden, der für Freetz ohnehin benutzt
wird. Leider wurde der AVM-Server bei neueren Firmwares (Neue
AVM-Weboberflächen seit etwa Mitte-Ende 2007) anders realisiert, sodass
der *httpd*-Ersatz nicht mehr möglich ist.

Beispiel UPnP: Wer nicht mit Client-Programmen (z.B. von AVM) den Status
der Box per Universal Plug'n'Play (UPnP) abfragt - mir persönlich genügt
die Web-Oberfläche vollkommen - oder Client-Programmen erlauben möchte,
dynamisch die Firmware-Einstellungen zu verändern (d.h. Löcher hinein zu
bohren), kann auch die entsprechenden Bestandteile (``igdd`` u.a.
Dateien) weglassen. Das spart zum einen Platz im Firmware-Image, zum
anderen läuft ein Prozess weniger. Das Weglassen von UPnP macht jedoch
das Versenden der Faxe mit FritzFax nicht möglich. Wer darauf verzichten
kann, kann UPnP abwählen.

.. _Schlußwort:

Schlußwort
----------

Das soll es fürs Erste gewesen sein. Wie eingangs gesagt: Es gibt sicher
noch diverse weitere Sparmöglichkeiten. Anregungen werden gern in diese
Seite von mir eingepflegt. In diesem Sinne:

**Geiz ist nicht geil, sondern dumm - aber sinnvoll sparen ist
hilfreich.**

`​Alexander Kriegisch
(kriegaex) <http://www.ip-phone-forum.de/member.php?u=117253>`__
